# [\#1740 Issue](https://github.com/ethereum/solidity/issues/1740) `closed`: [WARNING] EVM does not handle deploying contracts which call a library in their constructor, it can lead to value loss on deployment!!
**Labels**: `waiting for more input`


#### <img src="https://avatars.githubusercontent.com/u/11554098?u=49b59dd1a41171bd3f38baa6e323a6587fc38ac7&v=4" width="50">[Bunjin](https://github.com/Bunjin) opened issue at [2017-03-05 13:10](https://github.com/ethereum/solidity/issues/1740):

**The following problem is quite serious because it is not caught by testrpc, will allow you to deploy a contract with potentially value on it, the tx will not throw, but the data deployed will be corrupted**

Take the following simple example:

````
pragma solidity ^0.4.8;

library Lib {
  
  function foo(){
    uint a = 1;
  }

}
````

````
pragma solidity ^0.4.8;

import "./Lib.sol";

contract Contract {

  function(){

  }

  function Contract()
  {	
    Lib.foo();
  }

}
````
Gives me the following binary code 
(before linking)
`0x6060604052346000575b73__Lib___________________________________63c29855786040518163ffffffff167c010000000000000000000000000000000000000000000000000000000002815260040180905060006040518083038186803b1560005760325a03f4156000575050505b5b603d80607f6000396000f30060606040525b34600057600f5b5b565b0000a165627a7a7230582024d73e63c95973053e854463fe1dc26432f496eff7b8b18bca5ef8f5422042bb0029`
(after linking with lib at 0x19bf3ef7305e0674c844960cd9091f4e27eda21b)
`0x6060604052346000575b7319bf3ef7305e0674c844960cd9091f4e27eda21b63c29855786040518163ffffffff167c010000000000000000000000000000000000000000000000000000000002815260040180905060006040518083038186803b1560005760325a03f4156000575050505b5b603d80607f6000396000f30060606040525b34600057600f5b5b565b0000a165627a7a7230582024d73e63c95973053e854463fe1dc26432f496eff7b8b18bca5ef8f5422042bb0029`

Yet when trying to create this contract (with truffle deployer also I get the same behavior), it does not deploy the full byte code:
```
> web3.eth.sendTransaction({from:web3.eth.accounts[0], to:null, gas:4000000, data: "0x6060604052346000575b7319bf3ef7305e0674c844960cd9091f4e27eda21b63c29855786040518163ffffffff167c010000000000000000000000000000000000000000000000000000000002815260040180905060006040518083038186803b1560005760325a03f4156000575050505b5b603d80607f6000396000f30060606040525b34600057600f5b5b565b0000a165627a7a7230582024d73e63c95973053e854463fe1dc26432f496eff7b8b18bca5ef8f5422042bb0029"})
"0xce9da3a5b40ab67e216759b0599c717e96e76070f0222f10e5b03f94e210b683"

> web3.eth.getTransaction("0xce9da3a5b40ab67e216759b0599c717e96e76070f0222f10e5b03f94e210b683")

{
  blockHash: "0x88516101482214cf6dfc32939d97251a48ae88c164513ce994f603fc3557356b",
  blockNumber: 1190,
  from: "0x33494899299738554a15c79dd9b24221355d67bf",
  gas: 4000000,
  gasPrice: 20000000000,
  hash: "0xce9da3a5b40ab67e216759b0599c717e96e76070f0222f10e5b03f94e210b683",
  input: "0x6060604052346000575b7319bf3ef7305e0674c844960cd9091f4e27eda21b63c29855786040518163ffffffff167c010000000000000000000000000000000000000000000000000000000002815260040180905060006040518083038186803b1560005760325a03f4156000575050505b5b603d80607f6000396000f30060606040525b34600057600f5b5b565b0000a165627a7a7230582024d73e63c95973053e854463fe1dc26432f496eff7b8b18bca5ef8f5422042bb0029",
  nonce: 45,
  r: "0x78908ff3660f8c2f28bd7479451b6f915daba37717c4c95fe8e8715a55becbfd",
  s: "0x239ec7b04d263e0f839dd3ac4e1070c6a4a877aa65349e6ac729e18fd77d820",
  to: null,
  transactionIndex: 0,
  v: "0x1b",
  value: 0
}


> web3.eth.getTransactionReceipt("0xce9da3a5b40ab67e216759b0599c717e96e76070f0222f10e5b03f94e210b683")



{
  blockHash: "0x88516101482214cf6dfc32939d97251a48ae88c164513ce994f603fc3557356b",
  blockNumber: 1190,
  contractAddress: "0x70cf2ece1a0505b98de28d8b68583fa4a8f58fcd",
  cumulativeGasUsed: 75847,
  from: "0x33494899299738554a15c79dd9b24221355d67bf",
  gasUsed: 75847,
  logs: [],
  logsBloom: "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  root: "0x9823280599011f707b9dbf522aafded9d060c8f84586b6a03ee50b657e1c78a8",
  to: null,
  transactionHash: "0xce9da3a5b40ab67e216759b0599c717e96e76070f0222f10e5b03f94e210b683",
  transactionIndex: 0
}

> web3.eth.getCode("0x70cf2ece1a0505b98de28d8b68583fa4a8f58fcd")
"0x60606040525b34600057600f5b5b565b0000a165627a7a7230582024d73e63c95973053e854463fe1dc26432f496eff7b8b18bca5ef8f5422042bb0029"
```

*only the end of the input binary code gets deployed!*

I'm unsure if it's a solidity, a geth or an evm problem,
the problem is not reproduced when using ethereumjs-testrpc


Moving the library function call out of the constructor (to the fallback for instance) solves the issue


update: this is related to geth on a private testnet (even when homestead block is properly set). It deploys correctly on the public testnet.

#### <img src="https://avatars.githubusercontent.com/u/11554098?u=49b59dd1a41171bd3f38baa6e323a6587fc38ac7&v=4" width="50">[Bunjin](https://github.com/Bunjin) commented at [2017-03-05 13:10](https://github.com/ethereum/solidity/issues/1740#issuecomment-284244277):

I tried the same deployment on parity 1.6 with the new instantSeal engine and the bug was reproduced althought it also generated another weird behavior, probably related to parity engine, the method of deployment impacts the result:

```

truffle(local)> web3.eth.sendTransaction({from:web3.eth.accounts[0], to:null, data:0x6060604052346000575b73f55f1186faecf4b1cd3a7dfe5d55a7e2bf73338f63c29855786040518163ffffffff167c010000000000000000000000000000000000000000000000000000000002815260040180905060006040518083038186803b1560005760325a03f4156000575050505b5b603d80607f6000396000f30060606040525b34600057600f5b5b565b0000a165627a7a7230582075ea0c8daf070288625613525060c80b93487ca811e7cec5fe3045d20310329b0029, gas:4700000})

'0x2fd0e046693ce5f56c74d56ce2e38c3b8094f45f71f6ec496d9a10b00e5d8af7'

truffle(local)> web3.eth.getTransactionReceipt("0x2fd0e046693ce5f56c74d56ce2e38c3b8094f45f71f6ec496d9a10b00e5d8af7")

{ blockHash: '0xb035212b165e6aa17cd68c56a6b03217ed105a5de822cd3d495f7cad7d501a62',

  blockNumber: 3,

  contractAddress: '0xd4a002fc5b0550fc867d3bc45704a5a6529741c3',

  cumulativeGasUsed: 53000,

  gasUsed: 53000,

  logs: [],

  logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',

  root: null,

  transactionHash: '0x2fd0e046693ce5f56c74d56ce2e38c3b8094f45f71f6ec496d9a10b00e5d8af7',

  transactionIndex: 0 }

truffle(local)> web3.eth.getCode("0xd4a002fc5b0550fc867d3bc45704a5a6529741c3")

'0x'

```

that's when deploying manually

and when deploying with truffle migrate:

```

truffle(local)> web3.eth.getTransaction("0xffd730f3f2767b6f6bd0084b1f1ab204d2d87ea630472d4598352e4cc5132069")

{ blockHash: '0xfd45a05dba683880d6c6561b4db368dd7a52976692b54dff988071a23adaeb0e',

  blockNumber: 2,

  condition: null,

  creates: '0x857d6456ca763c36b4bad7d27a7f5f72507617ca',

  from: '0x0017fc495d78a74e4821699d6c66f3fcd1771a53',

  gas: 4000000,

  gasPrice: { [String: '100000000000'] s: 1, e: 11, c: [ 100000000000 ] },

  hash: '0xffd730f3f2767b6f6bd0084b1f1ab204d2d87ea630472d4598352e4cc5132069',

  input: '0x6060604052346000575b73f55f1186faecf4b1cd3a7dfe5d55a7e2bf73338f63c29855786040518163ffffffff167c010000000000000000000000000000000000000000000000000000000002815260040180905060006040518083038186803b1560005760325a03f4156000575050505b5b603d80607f6000396000f30060606040525b34600057600f5b5b565b0000a165627a7a7230582075ea0c8daf070288625613525060c80b93487ca811e7cec5fe3045d20310329b0029',

  networkId: null,

  nonce: 1,

  publicKey: '0x26c93e05c470e180e9f775c564b9750a2f186258e0e733c4e222e3267919dd4c44640176330bb850f55f005c6fd857338f1bc0069e9639bfceccd60ebb45be69',

  r: '0xb4edb2ba46b322fd318717bdf320b23a5c91fb0a233eca7d0efe0694656df0f2',

  raw: '0xf9010e0

truffle(local)> web3.eth.getTransactionReceipt("0xffd730f3f2767b6f6bd0084b1f1ab204d2d87ea630472d4598352e4cc5132069")

{ blockHash: '0xfd45a05dba683880d6c6561b4db368dd7a52976692b54dff988071a23adaeb0e',

  blockNumber: 2,

  contractAddress: '0x857d6456ca763c36b4bad7d27a7f5f72507617ca',

  cumulativeGasUsed: 77227,

  gasUsed: 77227,

  logs: [],

  logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',

  root: null,

  transactionHash: '0xffd730f3f2767b6f6bd0084b1f1ab204d2d87ea630472d4598352e4cc5132069',

  transactionIndex: 0 }

truffle(local)> web3.eth.getCode("0x857d6456ca763c36b4bad7d27a7f5f72507617ca")

'0x60606040525b34600057600f5b5b565b0000a165627a7a7230582075ea0c8daf070288625613525060c80b93487ca811e7cec5fe3045d20310329b0029'

```

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2017-03-05 13:10](https://github.com/ethereum/solidity/issues/1740#issuecomment-286909715):

The creation and the deployed bytecode differs, because the constructor will not be part of the deployed code (also constructor parameters at the end of the bytecode will not be deployed). Hence by using `getCode()` the bytecode cannot be compared.

The compiler is able to output the deployed (aka runtime) bytecode too:
```
  --bin                Binary of the contracts in hex.
  --bin-runtime        Binary of the runtime part of the contracts in hex.
```

Are you sure the data is corrupted and not seeing the above?

#### <img src="https://avatars.githubusercontent.com/u/9073706?v=4" width="50">[chriseth](https://github.com/chriseth) commented at [2017-03-05 13:10](https://github.com/ethereum/solidity/issues/1740#issuecomment-312622998):

Closing due to inactivity.


-------------------------------------------------------------------------------



[Export of Github issue for [ethereum/solidity](https://github.com/ethereum/solidity). Generated on 2022.05.23 at 03:51:38.]
