# [\#8367 Issue](https://github.com/ethereum/solidity/issues/8367) `closed`: Illegal characters in bytecode output

#### <img src="https://avatars.githubusercontent.com/u/22412996?u=d91a07517a0c02cb39e45f71a6d0f1f0c5bbd9cb&v=4" width="50">[zemse](https://github.com/zemse) opened issue at [2020-02-22 12:24](https://github.com/ethereum/solidity/issues/8367):

I've asked it here in solc-js repo [#450](https://github.com/ethereum/solc-js/issues/450) but reposting it here just in case the issue might better suit here.

I have imported  `Merkle.sol`. But if use it's function `Merkle.verify` (on line 149) then compiled bytecode contains illegal characters like `__$` and `$__` between the hex code.

If I instead have the `Merkle` library function directly in my main contract code, then there are no illegal characters in the compiled bytecode.

Steps to reproduce, clone the project at this commit:
1. Project URL: https://github.com/zemse/esn-plasma-contract/tree/ec62ef4b378e0d635183136bb81ca33e22c71e8b
2. `npm i`
```
// In contracts folder, file PlasmaManager.sol:
148      bool _outp = verifyMerkleProof(
149      // bool _outp = Merkle.verify(
150        _txRoot, // data to verify
151        _blockNumber - bunches[_bunchIndex].startBlockNumber,
152        bunches[_bunchIndex].transactionsMegaRoot,
153        _blockInBunchProof
154      );
```
3. comment out line number 148 and comment line 149.
4. `npm run test`.
5. Look for the `{ bytecode: 60806040523480156200001157600... }` console log it contains illegal characters.

Compiled Bytecode (containing illegal characters):
```
60806040523480156200001157600080fd5b50604051620022ac380380620022ac833981810160405260208110156200003757600080fd5b81019080805160405193929190846401000000008211156200005857600080fd5b838201915060208201858111156200006f57600080fd5b82518660208202830111640100000000821117156200008d57600080fd5b8083526020830192505050908051906020019060200280838360005b83811015620000c6578082015181840152602081019050620000a9565b5050505090500160405250505060008090505b81518110156200015c576001806000848481518110620000f557fe5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055508080600101915050620000d9565b50805160008190555080600290805190602001906200017d92919062000185565b50506200025a565b82805482825590600052602060002090810192821562000201579160200282015b82811115620002005782518260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555091602001919060010190620001a6565b5b50905062000210919062000214565b5090565b6200025791905b808211156200025357600081816101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055506001016200021b565b5090565b90565b612042806200026a6000396000f3fe608060405234801561001057600080fd5b50600436106100b45760003560e01c806376f5e6da1161007157806376f5e6da1461031f578063ca5d0926146103da578063d42f2f3514610495578063d6832ea9146104f4578063f3513a3714610512578063facd743b14610571576100b4565b80630a917b15146100b95780632079fb9a146100dd578063255032ab1461014b5780632ceea82a1461023c57806335aa2e441461025a57806375080de8146102c8575b600080fd5b6100c16105cd565b604051808260ff1660ff16815260200191505060405180910390f35b610109600480360360208110156100f357600080fd5b81019080803590602001909291905050506105e0565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6102226004803603608081101561016157600080fd5b810190808035906020019092919080359060200190929190803590602001909291908035906020019064010000000081111561019c57600080fd5b8201836020820111156101ae57600080fd5b803590602001918460018302840111640100000000831117156101d057600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f82011690508083019250505050505050919291929050505061061c565b604051808215151515815260200191505060405180910390f35b610244610763565b6040518082815260200191505060405180910390f35b6102866004803603602081101561027057600080fd5b8101908080359060200190929190505050610770565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6102f4600480360360208110156102de57600080fd5b81019080803590602001909291905050506107ac565b6040518085815260200184815260200183815260200182815260200194505050505060405180910390f35b6103d86004803603602081101561033557600080fd5b810190808035906020019064010000000081111561035257600080fd5b82018360208201111561036457600080fd5b8035906020019184600183028401116401000000008311171561038657600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f8201169050808301925050505050505091929192905050506107e9565b005b610493600480360360208110156103f057600080fd5b810190808035906020019064010000000081111561040d57600080fd5b82018360208201111561041f57600080fd5b8035906020019184600183028401116401000000008311171561044157600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509192919290505050610ec3565b005b61049d6111cd565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b838110156104e05780820151818401526020810190506104c5565b505050509050019250505060405180910390f35b6104fc61125b565b6040518082815260200191505060405180910390f35b61051a611261565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b8381101561055d578082015181840152602081019050610542565b505050509050019250505060405180910390f35b6105b36004803603602081101561058757600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291905050506112ef565b604051808215151515815260200191505060405180910390f35b600560009054906101000a900460ff1681565b600381815481106105ed57fe5b906000526020600020016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60008060008690506000602085518161063157fe5b06146106a5576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260148152602001807f496e76616c69642070726f6f66206c656e67746800000000000000000000000081525060200191505060405180910390fd5b60008690506000602090505b85518111610752578086015193506000600283816106cb57fe5b061415610708578284604051602001808381526020018281526020019250505060405160208183030381529060405280519060200120925061073a565b838360405160200180838152602001828152602001925050506040516020818303038152906040528051906020012092505b6002828161074457fe5b0491506020810190506106b1565b508582149350505050949350505050565b6000600480549050905090565b6002818154811061077d57fe5b906000526020600020016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600481815481106107b957fe5b90600052602060002090600402016000915090508060000154908060010154908060020154908060030154905084565b60606107fc6107f78361130f565b61133d565b9050606061081d8260008151811061081057fe5b602002602001015161133d565b90506004815114610896576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f62756e636820686561646572206d75737420686176652034206d656d6265727381525060200191505060405180910390fd5b61089e611faa565b60405180608001604052806108c6846000815181106108b957fe5b602002602001015161141a565b81526020016108e8846001815181106108db57fe5b602002602001015161141a565b815260200161090a846002815181106108fd57fe5b602002602001015161148b565b815260200161092c8460038151811061091f57fe5b602002602001015161148b565b81525090506109396114a0565b8160000151146109b1576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601a8152602001807f696e76616c696420737461727420626c6f636b206e756d62657200000000000081525060200191505060405180910390fd5b60606109d0846000815181106109c357fe5b6020026020010151611510565b905060006040518060400160405280601a81526020017f19457468657265756d205369676e6564204d6573736167653a0a000000000000815250610a148351611586565b836040516020018084805190602001908083835b60208310610a4b5780518252602082019150602081019050602083039250610a28565b6001836020036101000a03801982511681845116808217855250505050505090500183805190602001908083835b60208310610a9c5780518252602082019150602081019050602083039250610a79565b6001836020036101000a03801982511681845116808217855250505050505090500182805190602001908083835b60208310610aed5780518252602082019150602081019050602083039250610aca565b6001836020036101000a03801982511681845116808217855250505050505090500193505050506040516020818303038152906040528051906020012090507ff263fdaa282129bf525bc5da5a454ee67eb2b96bc11afab9c6f92896f166b18e816040518082815260200191505060405180910390a1600080600190505b8651811015610d85576060610b92888381518110610b8557fe5b60200260200101516116b3565b90506000806000602084018051935060208101519250604081015160001a9150601b821015610bc257601b820191505b50601b8160ff161480610bd85750601c8160ff16145b610c4a576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260168152602001807f696e76616c6964207265636f766572792076616c75650000000000000000000081525060200191505060405180910390fd5b600060018883868660405160008152602001604052604051808581526020018460ff1660ff1681526020018381526020018281526020019450505050506020604051602081039080840390855afa158015610ca9573d6000803e3d6000fd5b505050602060405103519050600160008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1615610d105786806001019750505b7febfb412ded3f9cdb15b75308503b279416e74d382f6ce86eedee0ef3130fa9e381604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390a150505050508080600101915050610b6b565b50606460426000540281610d9557fe5b048111610e0a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601a8152602001807f3636252076616c696461746f72732073686f756c64207369676e00000000000081525060200191505060405180910390fd5b6000600480549050905060048590806001815401808255809150506001900390600052602060002090600402016000909190919091506000820151816000015560208201518160010155604082015181600201556060820151816003015550507f435520ea9b14c682112acef5bc8466234d75b18dce73c44a78d905139def419d856000015186602001518360405180848152602001838152602001828152602001935050505060405180910390a15050505050505050565b6060610ed6610ed18361130f565b61133d565b90506000610ef782600081518110610eea57fe5b602002602001015161141a565b90506000610f1883600181518110610f0b57fe5b602002602001015161141a565b90506060610f3984600281518110610f2c57fe5b60200260200101516116b3565b90506000610f5a85600381518110610f4d57fe5b602002602001015161148b565b90506060610f7b86600481518110610f6e57fe5b60200260200101516116b3565b90506060610f9c87600581518110610f8f57fe5b60200260200101516116b3565b90506060610fbd88600681518110610fb057fe5b60200260200101516116b3565b9050610fcb8383838761173f565b61103d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601d8152602001807f496e76616c6964204d65726b6c652050617472696369612050726f6f6600000081525060200191505060405180910390fd5b600073__$9015ba71e93c1d46f466ee2ce635bb22bf$__63a2f625868660048b8154811061106757fe5b9060005260206000209060040201600001548a0360048c8154811061108857fe5b9060005260206000209060040201600201548a6040518563ffffffff1660e01b81526004018085815260200184815260200183815260200180602001828103825283818151815260200191508051906020019080838360005b838110156110fc5780820151818401526020810190506110e1565b50505050905090810190601f1680156111295780820380516001836020036101000a031916815260200191505b509550505050505060206040518083038186803b15801561114957600080fd5b505af415801561115d573d6000803e3d6000fd5b505050506040513d602081101561117357600080fd5b810190808051906020019092919050505090507f74aec394922f1e1a4f69076a402d938ff381675095bfa243b4ca0ddb157f335481604051808215151515815260200191505060405180910390a150505050505050505050565b6060600380548060200260200160405190810160405280929190818152602001828054801561125157602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311611207575b5050505050905090565b60005481565b606060028054806020026020016040519081016040528092919081815260200182805480156112e557602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001906001019080831161129b575b5050505050905090565b60016020528060005260406000206000915054906101000a900460ff1681565b611317611fd8565b600060208301905060405180604001604052808451815260200182815250915050919050565b606061134882611a15565b61135157600080fd5b600061135c83611a63565b905060608160405190808252806020026020018201604052801561139a57816020015b611387611ff2565b81526020019060019003908161137f5790505b50905060006113ac8560200151611ad4565b8560200151019050600080600090505b8481101561140d576113cd83611b5d565b91506040518060400160405280838152602001848152508482815181106113f057fe5b6020026020010181905250818301925080806001019150506113bc565b5082945050505050919050565b600080826000015111801561143457506021826000015111155b61143d57600080fd5b600061144c8360200151611ad4565b9050600081846000015103905060008083866020015101905080519150602083101561147f57826020036101000a820491505b81945050505050919050565b60006114968261141a565b60001b9050919050565b60008060048054905014156114b8576000905061150d565b6004600160048054905003815481106114cd57fe5b90600052602060002090600402016001015460020a6004600160048054905003815481106114f757fe5b9060005260206000209060040201600001540190505b90565b60608082600001516040519080825280601f01601f19166020018201604052801561154a5781602001600182028036833780820191505090505b5090506000815114156115605780915050611581565b600081602001905061157b8460200151828660000151611c15565b81925050505b919050565b606060008214156115ce576040518060400160405280600181526020017f300000000000000000000000000000000000000000000000000000000000000081525090506116ae565b600082905060005b600082146115f8578080600101915050600a82816115f057fe5b0491506115d6565b6060816040519080825280601f01601f19166020018201604052801561162d5781602001600182028036833780820191505090505b50905060006001830390505b600086146116a657600a868161164b57fe5b0660300160f81b8282806001900393508151811061166557fe5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350600a868161169e57fe5b049550611639565b819450505050505b919050565b606060008260000151116116c657600080fd5b60006116d58360200151611ad4565b905060008184600001510390506060816040519080825280601f01601f1916602001820160405280156117175781602001600182028036833780820191505090505b5090506000816020019050611733848760200151018285611c15565b81945050505050919050565b6000611749611fd8565b6117528461130f565b9050606061175f8261133d565b90506060806000869050600080905060606117798b611c7c565b9050600081511415611795576000975050505050505050611a0d565b60008090505b8651811015611a045781518311156117be57600098505050505050505050611a0d565b6117da8782815181106117cd57fe5b6020026020010151611510565b9550858051906020012084146117fb57600098505050505050505050611a0d565b61181787828151811061180a57fe5b602002602001015161133d565b94506011855114156118ec578151831415611880578c805190602001206118518660108151811061184457fe5b60200260200101516116b3565b80519060200120141561186f57600198505050505050505050611a0d565b600098505050505050505050611a0d565b600082848151811061188e57fe5b602001015160f81c60f81b60f81c905060108160ff1611156118bc5760009950505050505050505050611a0d565b6118db868260ff16815181106118ce57fe5b6020026020010151611e03565b60001b9450600184019350506119f7565b6002855114156119e55761191d6119168660008151811061190957fe5b60200260200101516116b3565b8385611e31565b83019250815183141561197e578c8051906020012061194f8660018151811061194257fe5b60200260200101516116b3565b80519060200120141561196d57600198505050505050505050611a0d565b600098505050505050505050611a0d565b60006119a76119a08760008151811061199357fe5b60200260200101516116b3565b8486611e31565b14156119be57600098505050505050505050611a0d565b6119db856001815181106119ce57fe5b6020026020010151611e03565b60001b93506119f6565b600098505050505050505050611a0d565b5b808060010191505061179b565b50505050505050505b949350505050565b60008082600001511415611a2c5760009050611a5e565b60008083602001519050805160001a915060c060ff168260ff161015611a5757600092505050611a5e565b6001925050505b919050565b60008082600001511415611a7a5760009050611acf565b60008090506000611a8e8460200151611ad4565b84602001510190506000846000015185602001510190505b80821015611ac857611ab782611b5d565b820191508280600101935050611aa6565b8293505050505b919050565b600080825160001a9050608060ff16811015611af4576000915050611b58565b60b860ff16811080611b19575060c060ff168110158015611b18575060f860ff1681105b5b15611b28576001915050611b58565b60c060ff16811015611b485760018060b80360ff16820301915050611b58565b60018060f80360ff168203019150505b919050565b6000806000835160001a9050608060ff16811015611b7e5760019150611c0b565b60b860ff16811015611b9b576001608060ff168203019150611c0a565b60c060ff16811015611bcb5760b78103600185019450806020036101000a85510460018201810193505050611c09565b60f860ff16811015611be857600160c060ff168203019150611c08565b60f78103600185019450806020036101000a855104600182018101935050505b5b5b5b8192505050919050565b6000811415611c2357611c77565b5b602060ff168110611c535782518252602060ff1683019250602060ff1682019150602060ff1681039050611c24565b6000600182602060ff16036101000a03905080198451168184511681811785525050505b505050565b606080600083511115611dfa57600080611c97600086611f24565b60f81c905060018160ff161480611cb1575060038160ff16145b15611d495760016002865102036040519080825280601f01601f191660200182016040528015611cf05781602001600182028036833780820191505090505b5092506000611d00600187611f24565b90508084600081518110611d1057fe5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053506001925050611d8a565b600280865102036040519080825280601f01601f191660200182016040528015611d825781602001600182028036833780820191505090505b509250600091505b60008260ff1690505b8351811015611df657611dae60028460ff1683030187611f24565b848281518110611dba57fe5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053508080600101915050611d93565b5050505b80915050919050565b60006021826000015114611e1657600080fd5b60008060018460200151019050805191508192505050919050565b6000806060611e3f86611c7c565b9050606081516040519080825280601f01601f191660200182016040528015611e775781602001600182028036833780820191505090505b50905060008590505b82518601811015611ef2576000878281518110611e9957fe5b602001015160f81c60f81b9050808388840381518110611eb557fe5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350508080600101915050611e80565b50808051906020012082805190602001201415611f125781519250611f17565b600092505b8293505050509392505050565b60008060028481611f3157fe5b0614611f6d5760108260028581611f4457fe5b0481518110611f4f57fe5b602001015160f81c60f81b60f81c60ff1681611f6757fe5b06611f9f565b60108260028581611f7a57fe5b0481518110611f8557fe5b602001015160f81c60f81b60f81c60ff1681611f9d57fe5b045b60f81b905092915050565b6040518060800160405280600081526020016000815260200160008019168152602001600080191681525090565b604051806040016040528060008152602001600081525090565b60405180604001604052806000815260200160008152509056fea26469706673582212204fd16e0c381d875ee13ddbb90fc16a31291c5aa212d0b112de14efcde8d1dd4464736f6c63430006030033
```


#### <img src="https://avatars.githubusercontent.com/u/703848?u=b9cc8c48b50ac67bcc4eae73806d121de8c5edb4&v=4" width="50">[elenadimitrova](https://github.com/elenadimitrova) commented at [2020-02-22 12:24](https://github.com/ethereum/solidity/issues/8367#issuecomment-590350217):

Have you tried linking the libraries into the `PlasmaManager` contract, it seems they are not linked, see https://solidity.readthedocs.io/en/latest/using-the-compiler.html#using-the-commandline-compiler and https://solidity.readthedocs.io/en/latest/contracts.html#libraries

#### <img src="https://avatars.githubusercontent.com/u/22412996?u=d91a07517a0c02cb39e45f71a6d0f1f0c5bbd9cb&v=4" width="50">[zemse](https://github.com/zemse) commented at [2020-02-22 12:24](https://github.com/ethereum/solidity/issues/8367#issuecomment-590698122):

Thanks for the links to the docs. I read about `placeholders`. It looks like I might be doing something wrong due to which the `placeholder` is coming in the bytecode.

> If your contracts use libraries, you will notice that the bytecode contains substrings of the form __ $53aea86b7d70b31448b230b20ae141a537$ __. 
> You can use solc as a linker meaning that it will insert the library addresses for you at those points.

I'm not importing libraries from any URL, nor I have any library address as libraries are not deployed on Ethereum, I intend to use library files that I have.

My files structure looks like this:
```
/contracts/PlasmaManager.sol
/contracts/lib/BytesLib.sol
/contracts/lib/ECVerify.sol
/contracts/lib/Merkle.sol
/contracts/lib/MerklePatriciaProof.sol
/contracts/lib/RLP.sol
/contracts/lib/RLPEncode.sol
/contracts/lib/SafeMath.sol
...
```

While giving input to the compiler using JSON-input interface, I have arranged the sources in this fashion:
```
const input = {
      language: 'Solidity',
      sources: {
            'PlasmaManager.sol': {
                    content: 'utf8 source content' 
            },
            'lib/Merkle.sol': {
                    content: 'utf8 source content' 
            },
            'lib/MerklePatriciaProof.sol': {
                    content: 'utf8 source content' 
            },
            ...
      },
      settings: {
          outputSelection: {
              '*': {
                  '*': [ '*' ]
              }
          }
      }
  }
```

I did not face any issue importing and using  `lib/BytesLib.sol`, `lib/MerklePatriciaProof.sol`, `lib/RLP.sol`, `lib/RLPEncode.sol`. I just imported them in the `PlasmaManager.sol` and used methods as I expected.

The `__$9015ba71e93c1d46f466ee2ce635bb22bf$__` style placeholder is coming in case of `ECVerify.sol` and `Merkle.sol`. I have ensured that the file name exactly matches my import statement. I don't understand why these files are resulting in a placeholder while other files are not.

But since the placeholder is present in the bytecode, it should mean that libraries are not linked.
I have already imported libraries in the top of [`PlasmaManager.sol`](https://github.com/zemse/esn-plasma-contract/blob/master/contracts/PlasmaManager.sol), as well as the source code of the libraries, is also present in the [`sources`](https://github.com/zemse/esn-plasma-contract/blob/master/compile.js#L37) in the input JSON. What more do I need to do?

#### <img src="https://avatars.githubusercontent.com/u/9073706?v=4" width="50">[chriseth](https://github.com/chriseth) commented at [2020-02-22 12:24](https://github.com/ethereum/solidity/issues/8367#issuecomment-590772744):

The compiler knows about the source code of he libraries, but that does not mean that they are linked. Linking means that you tell the compiler a contract address where the library is deployed.

Here is more information about linking with solc-js: https://github.com/ethereum/solc-js#linking-bytecode

It might be, though, that you do not want a linked library, but instead just want to import the code of the library into the calling contract. That can be achieved by marking all the library functions you call as `internal`. That way, you can get around the need for linking.

#### <img src="https://avatars.githubusercontent.com/u/22412996?u=d91a07517a0c02cb39e45f71a6d0f1f0c5bbd9cb&v=4" width="50">[zemse](https://github.com/zemse) commented at [2020-02-22 12:24](https://github.com/ethereum/solidity/issues/8367#issuecomment-591235698):

Thanks for guiding! Marking the library functions `internal` helped me what I wanted to achieve.


-------------------------------------------------------------------------------



[Export of Github issue for [ethereum/solidity](https://github.com/ethereum/solidity). Generated on 2022.05.23 at 03:51:38.]
