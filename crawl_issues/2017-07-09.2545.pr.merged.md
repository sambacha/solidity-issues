# [\#2545 PR](https://github.com/ethereum/solidity/pull/2545) `merged`: LLL: alloc issues round-up

#### <img src="https://avatars.githubusercontent.com/u/20796281?u=3ade059256c951779e598bb585d7d85463f340a3&v=4" width="50">[benjaminion](https://github.com/benjaminion) opened issue at [2017-07-09 13:24](https://github.com/ethereum/solidity/pull/2545):

This is an attempt to move the LLL `alloc` issue on.  It supersedes PRs #2489 and #2463, and resolves Issue #2465.

The proposed change to the generated bytecode is the tightest code I can make that handles both the edge cases `(alloc 0)` and `MSIZE` being initially zero.

Notes:

  * `(alloc 0)` does not allocate any memory. This is contra @chriseth, but in line with @axic.
  * It uses `MLOAD` rather than `MSTORE8` to increase `MSIZE`. This is a belt-and-braces guard against memory corruption.
  * It handles the edge case of `MSIZE` being intially zero, which is a problem for @axic's approach in #2489.

 A bunch of test cases is included that should be comprehensive.

Fixes #2465.

#### <img src="https://avatars.githubusercontent.com/u/20796281?u=3ade059256c951779e598bb585d7d85463f340a3&v=4" width="50">[benjaminion](https://github.com/benjaminion) commented at [2017-07-09 14:21](https://github.com/ethereum/solidity/pull/2545#issuecomment-313922840):

Note that, alternatively, ``alloc`` could be implemented pretty efficiently as a compiler macro as follows:

```
  (def 'alloc (n) (raw (msize) (when n (pop (mload (+ (msize) (& (- n 1) (~ 0x1f))))))))
```

The downside of this is that it removes the opportunity to do memory management between ``alloc`` and variables - which seems to be the purpose of the [finalise](https://github.com/ethereum/solidity/blob/develop/liblll/CodeFragment.cpp#L39) function. The memory management is not currently working, so as it stands it makes no practical difference if we do `alloc` in the parser or in the macros. But if we want to do the memory management in future, `alloc` ought to be left in the parser where it currently is.

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2017-07-11 19:35](https://github.com/ethereum/solidity/pull/2545#issuecomment-314548795):

My only nitpicking is I like comments above statements (as opposed to next to them), but I guess it is more readable in this case, since it fits a single window.

Please include your macro version as a comment in the macro section so it is not forgotten. Let's keep the native version for now and see if we can/should fix `finalise`.

#### <img src="https://avatars.githubusercontent.com/u/20796281?u=3ade059256c951779e598bb585d7d85463f340a3&v=4" width="50">[benjaminion](https://github.com/benjaminion) commented at [2017-07-11 20:31](https://github.com/ethereum/solidity/pull/2545#issuecomment-314562654):

> My only nitpicking is I like comments above statements (as opposed to next to them), but I guess it is more readable in this case, since it fits a single window.

Comments were mainly for my benefit; happy to keep them, move them, leave them...

> Please include your macro version as a comment in the macro section so it is not forgotten.

Done. I put it at the top as some of the other macros could probably usefully be rewritten to use ALLOC now that it is reliable.

I've squashed the commits into one for convenience.

By the way, I wrote [some docs](http://lll-docs.readthedocs.io/en/latest/lll_reference.html#memory-allocation-alloc).


-------------------------------------------------------------------------------



[Export of Github issue for [ethereum/solidity](https://github.com/ethereum/solidity). Generated on 2024.12.15 at 06:45:24.]
