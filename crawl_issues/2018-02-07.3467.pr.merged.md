# [\#3467 PR](https://github.com/ethereum/solidity/pull/3467) `merged`: cmake/jsoncpp.cmake: update to jsoncpp v1.8.4

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) opened issue at [2018-02-07 01:18](https://github.com/ethereum/solidity/pull/3467):

Fixes #2829.

To get version 1.8.4 to work, we need to get rid of the usage of deprecated API. PR #3532 (libdevcore/JSON.h - new API) will remove the deprecated API calls.

Remember, that `scripts/travis-emscripten/build_emscripten.sh` is currently using the systems `cmake`, that is shipped with `trzeci/emscripten:sdk`, it is not using the one that is installed with `scripts/install_cmake.sh`.

The new `jsoncpp` (at least version 1.8.4) needs a minimum `cmake` version of 3.1, that is currently not provided by `trzeci/emscripten:sdk`, at least not with version `1.37.33-64bit`. So minor changes on the build scripts are needed. 

#### <img src="https://avatars.githubusercontent.com/u/9073706?v=4" width="50">[chriseth](https://github.com/chriseth) commented at [2018-02-07 14:11](https://github.com/ethereum/solidity/pull/3467#issuecomment-363780204):

The jsoncpp version we currently use also does not support move semantics, so this would also be a big benefit!

#### <img src="https://avatars.githubusercontent.com/u/9073706?v=4" width="50">[chriseth](https://github.com/chriseth) commented at [2018-02-07 16:24](https://github.com/ethereum/solidity/pull/3467#issuecomment-363824405):

Please rebase and remove the merge commit, it is not possible to review it properly.

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-02-07 22:43](https://github.com/ethereum/solidity/pull/3467#issuecomment-363936692):

I wasn't able to run the ipc specific tests with `eth`. I used the most recent version of `develop`. After running
- `eth/eth  --test -d /tmp/ipc` 
- `test/soltest -- --ipcpath /tmp/ipc/geth.ipc --no-smt`

```
➜  cmake-build-debug git:(strict-mode-jsoncpp-1.8.4) ✗ test/soltest -- --ipcpath /tmp/ipc/geth.ipc --no-smt
Running 1733 test cases...
/Users/alex/git/aarlt/solidity/test/RPCSession.cpp:332: fatal error: in "SolidityAuctionRegistrar/creation": critical check dev::jsonParseStrict(reply, &result, &errs) has failed
/Users/alex/git/aarlt/solidity/test/RPCSession.cpp:332: fatal error: in "SolidityAuctionRegistrar/reserve": critical check dev::jsonParseStrict(reply, &result, &errs) has failed
/Users/alex/git/aarlt/solidity/test/RPCSession.cpp:332: fatal error: in "SolidityAuctionRegistrar/double_reserve_long": critical check dev::jsonParseStrict(reply, &result, &errs) has failed
...
```
```
^[[1;37mcpp-ethereum, a C++ Ethereum client^[[0m
cpp-ethereum 1.3.0
  By cpp-ethereum contributors, (c) 2013-2018.
  See the README for contributors and credits.
Networking disabled. To start, use netstart or pass --bootstrap or a remote host.
JSONRPC Admin Session Key: GZeXowHW3aQ=
^[[91m ⚡    ^[[35m23:34:13.065^[[0m^[[30m|^[[34m^[[0m  Stop worker^[[0m 590 ms
^[[94m  ℹ  ^[[35m23:34:13.066^[[0m^[[30m|^[[34m^[[0m  Killing blockchain & extras database (WithExisting::Kill).
^[[91m ⚡    ^[[35m23:34:14.078^[[0m^[[30m|^[[34meth^[[0m  Worker stopping^[[0m 1013 ms
^[[101m^[[1;30m  ✘  ^[[35m23:34:14.328^[[0m^[[30m|^[[34meth^[[0m  Sender: dde147e35eedb9384833d66a487f1f246fb3406b^[[0m  Invalid Nonce: Require ^[[34m0^[[0m  Got ^[[34m3^[[0m
^[[101m^[[1;30m  ✘  ^[[35m23:34:14.328^[[0m^[[30m|^[[34meth^[[0m  Sender: dde147e35eedb9384833d66a487f1f246fb3406b^[[0m  Invalid Nonce: Require ^[[34m0^[[0m  Got ^[[34m3^[[0m
^[[101m^[[1;30m  ✘  ^[[35m23:34:14.328^[[0m^[[30m|^[[34meth^[[0m  Sender: dde147e35eedb9384833d66a487f1f246fb3406b^[[0m  Invalid Nonce: Require ^[[34m0^[[0m  Got ^[[34m3^[[0m
...
```
A lot of ipc related tests seem not to work. Sometimes `eth` just crashes. Am I doing something wrong? Should I file an issue?

However, because of that I couldn't run the ipc related tests. I was also not able to test my changes in `solfuzzer` - I didn't find out how it is used.

Additionally to this, it looks like that `jsoncpp` strict-mode still allow comments, even if the specific setting `allowComments` is set to `false`. 
```cpp
void CharReaderBuilder::strictMode(Json::Value* settings)
{
//! [CharReaderBuilderStrictMode]
  (*settings)["allowComments"] = false;
  (*settings)["strictRoot"] = true;
  (*settings)["allowDroppedNullPlaceholders"] = false;
  (*settings)["allowNumericKeys"] = false;
  (*settings)["allowSingleQuotes"] = false;
  (*settings)["stackLimit"] = 1000;
  (*settings)["failIfExtra"] = true;
  (*settings)["rejectDupKeys"] = true;
  (*settings)["allowSpecialFloats"] = false;
//! [CharReaderBuilderStrictMode]
}
```
It looks like a `jsoncpp` bug to me.

#### <img src="https://avatars.githubusercontent.com/u/9073706?v=4" width="50">[chriseth](https://github.com/chriseth) commented at [2018-02-08 10:58](https://github.com/ethereum/solidity/pull/3467#issuecomment-364077031):

There are compilation errors on travis.

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-02-08 19:58](https://github.com/ethereum/solidity/pull/3467#issuecomment-364230282):

Oops.. its always good to use different compilers :)

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-02-08 22:01](https://github.com/ethereum/solidity/pull/3467#issuecomment-364263416):

On [Node.js:6 Compiler: gcc C++](https://travis-ci.org/ethereum/solidity/jobs/339178210)
```
CMake Error at CMakeLists.txt:3 (CMAKE_MINIMUM_REQUIRED):
  CMake 3.1 or higher is required.  You are running version 3.0.2
```
In `jsoncpp 1.8.4` they are using `CMAKE_MINIMUM_REQUIRED(VERSION 3.1)`, but here cmake seem to be `version 3.0.2`, that is contradicting to the output of `scripts/install_cmake.sh` some lines above. 
```
$ test "$TRAVIS_OS_NAME" != "linux" || (scripts/install_cmake.sh)
CMake 3.7.1 already installed in /home/travis/.local/bin
```

Is it possible that `version 3.0.2` was used all the time and the new `jsoncpp` is now the first thing that really needs `version 3.1` as minimum?

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-02-08 22:10](https://github.com/ethereum/solidity/pull/3467#issuecomment-364265583):

The [C++ travis build](https://travis-ci.org/ethereum/solidity/jobs/339178209) is not finding the make target for `deps/lib/libjsoncpp.a`. Somehow the lib seem to be installed in `/solidity/deps/lib64/libjsoncpp.a` - is `lib` vs. `lib64` the problem here?

#### <img src="https://avatars.githubusercontent.com/u/9073706?v=4" width="50">[chriseth](https://github.com/chriseth) commented at [2018-02-09 11:10](https://github.com/ethereum/solidity/pull/3467#issuecomment-364405539):

Somehow it sometimes uses `lib` and somtimes `lib64`. I guess we need @chfast  to take a look at this...

#### <img src="https://avatars.githubusercontent.com/u/9073706?v=4" width="50">[chriseth](https://github.com/chriseth) commented at [2018-02-09 11:12](https://github.com/ethereum/solidity/pull/3467#issuecomment-364406021):

Please also re-enable the fallthrough warning in cmake/jsoncpp.cmake

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-02-09 16:50](https://github.com/ethereum/solidity/pull/3467#issuecomment-364490433):

`jsoncpp` is compiled with `-Wall -Wconversion -Wshadow -Werror=conversion -Werror=sign-compare`, where `-Wimplicit-fallthrough` is only enabled, if its explicitly set, or if `-Wextra` is set - for [gnu compilers](https://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html). This is not the case for `jsoncpp`.

We can manually do `-Wimplicit-fallthrough`, but this seem to be only ok for `gnu` compilers - I tested it with `GCC 7.3.1`. If enabled by default, `clang` will still warn about the implicit fallthroughs, they are still there in `jsoncpp 1.8.4`. I tested `clang` versions `Apple LLVM version 9.0.0 (clang-900.0.39.2)` and fedora's `5.0.1`.

We shouldn't re-enable the `implicit-fallthrough`, because `jsoncpp` will still generate fallthrough warnings for `clang`. `jsoncpp` is not compiled with `-Wextra`, so we can get rid of the whole  implicit-fallthrough-block in `jsoncpp.cmake`.

However, do you mean "re-enable" in the sense of explicitly enabling `-Wimplicit-fallthrough`? 

I think that its safe to just remove the whole implicit-fallthrough-block in `jsoncpp.cmake`, it looks like that `-Wimplicit-fallthrough` and/or `-Wextra` is never set by the build system.

#### <img src="https://avatars.githubusercontent.com/u/9073706?v=4" width="50">[chriseth](https://github.com/chriseth) commented at [2018-02-09 18:07](https://github.com/ethereum/solidity/pull/3467#issuecomment-364511894):

We recently (6 months?) added some code to `cmake/jsoncpp.cmake` about fallthrough warnings. I though the new version might be fixed in that regard, so we could try removing that code.

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-02-11 23:44](https://github.com/ethereum/solidity/pull/3467#issuecomment-364801705):

 I tried to fix the issue with the emscripten build. I saw that somehow a very old `cmake` was used, that prevented the build of `jsoncpp`, it required a minimum version `3.1`. After fixing that, during the build a missing function `_ZN4Json5Value6appendEOS0_` was shown, I did some debugging sessions.  After finding out that built-in  demangle support had some problems, I activated `DEMANGLE_SUPPORT=1` which didn't solved the problem - I thought that the buggy demangling caused somehow the optimiser to remove the function. However, I rewrote the `scripts/emscripten.sh` build, so it can be also used in OSX and updated to `trzeci/emscripten:sdk-tag-1.37.33-64bit`. The problem with the built-in demangling support seem to be fixed here. However, I saw there
```
RangeError: Maximum call stack size exceeded
    at JSON.stringify (<anonymous>)
    at Object.<anonymous> (/emsdk_portable/sdk/tools/js-optimizer.js:8389:16)
    at Module._compile (module.js:635:30)
    at Object.Module._extensions..js (module.js:646:10)
    at Module.load (module.js:554:32)
    at tryModuleLoad (module.js:497:12)
    at Function.Module._load (module.js:489:3)
    at Function.Module.runMain (module.js:676:10)
    at startup (bootstrap_node.js:187:16)
    at bootstrap_node.js:608:3
fs.js:646
  return binding.open(pathModule._makeLong(path), stringToFlags(flags), mode);
```

I tried to increment the `node_js` stack even more to 16MB, but I had no success. I disabled the JavaScript optimizer (`--js-opts 0`), everything worked, but the resulting `soljson.js` had a size of 75MB. After setting `EMCC_DEBUG=2` I was able to see the different optimizer steps:
```
DEBUG:root:emcc step "part of js opts" took 3.37 seconds
DEBUG:root:applying js optimization passes: asm aggressiveVariableElimination
chunkification: num funcs: 7053 actual num chunks: 9 chunk size range: 35726801 - 2026058
splitting up js optimization into 9 chunks, using 6 cores  (total: 58.66 MB)
.
.
.
.
.
/emsdk_portable/sdk/tools/eliminator/node_modules/uglify-js/lib/process.js:228
                                var ret = gen.apply(ast, ast.slice(1));
                                              ^

RangeError: Maximum call stack size exceeded
```
So somehow the `aggressiveVariableElimination` made problems, I disabled them so I was finally able to build a `soljson.js` (7.6MB). 

However, I tried now my findings on travis, but it looks like that there are still other problems.
```
warning: unresolved symbol: _ZNKSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE7compareEPKc
...
warning: unresolved symbol: _ZTINSt3__115basic_streambufIcNS_11char_traitsIcEEEE
warning: unresolved symbol: _ZTVNSt3__113basic_istreamIcNS_11char_traitsIcEEEE
```
Now it looks like that functions from the standard library are missing.  I have no idea why I don't see that locally. I ran the stuff also within a `trzeci/emscripten:sdk-tag-1.37.33-64bit` container.

Any ideas?

One question - because I want to push my version of `scripts/build_emscripten.sh`- does travis run everything in a container too? so if i create a named docker container inside travis, there will be no conflicts with other potential parallel builds using the same container-name?

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-02-13 20:40](https://github.com/ethereum/solidity/pull/3467#issuecomment-365397037):

> We recently (6 months?) added some code to cmake/jsoncpp.cmake about fallthrough warnings. I though the new version might be fixed in that regard, so we could try removing that code.

We added code to ignore fallthrough warnings, but later the fallthroughs were fixed and the ignore directive removed.

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-02-13 20:54](https://github.com/ethereum/solidity/pull/3467#issuecomment-365400686):

@chriseth do you know why the build was successful for `ci/circleci: build_emscripten`?

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-02-13 21:22](https://github.com/ethereum/solidity/pull/3467#issuecomment-365408417):

> > We recently (6 months?) added some code to cmake/jsoncpp.cmake about fallthrough warnings. I though the new version might be fixed in that regard, so we could try removing that code.
> 
> We added code to ignore fallthrough warnings, but later the fallthroughs were fixed and the ignore directive removed.
```cpp
# Disable implicit fallthrough warning in jsoncpp for gcc >= 7 until the upstream handles it properly
if (("${CMAKE_CXX_COMPILER_ID}" MATCHES "GNU") AND CMAKE_CXX_COMPILER_VERSION VERSION_GREATER 7.0)
    set(JSONCCP_EXTRA_FLAGS -Wno-implicit-fallthrough)
else()
    set(JSONCCP_EXTRA_FLAGS "")
endif()
```
I removed the whole block, because from the compiler flags point of view it should never check for falltroughs. With `gnu` compilers they are only enabled, if explicitly set, or with `-Wextra` - that is not set in `JSONCCP_EXTRA_FLAGS`. And for `clang` it looks like that it need to be set explicitly with `-Wimplicit-fallthrough`.  If fallthroughs warnings are enabled, `clang` will still produce a lot of fallthrough warnings.

Probably the way how you built `jsoncpp` changed somehow - and you probably used `CMAKE_CXX_FLAGS` from `EthCompilerSettings.cmake` that sets `-Wextra` and `-Wimplicit-fallthrough`.

#### <img src="https://avatars.githubusercontent.com/u/9073706?v=4" width="50">[chriseth](https://github.com/chriseth) commented at [2018-02-13 21:42](https://github.com/ethereum/solidity/pull/3467#issuecomment-365414035):

circle uses `trzeci/emscripten:sdk-tag-1.37.21-64bit` - try to see if you can use that for travis, too.

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-02-13 21:45](https://github.com/ethereum/solidity/pull/3467#issuecomment-365414983):

@chriseth interesting.. i tried 1.37.33-64 bit.. and there i had this optimizer bug with the `aggressiveVariableElimination`.. i will check that version now

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-02-13 21:55](https://github.com/ethereum/solidity/pull/3467#issuecomment-365417926):

~~#3491 does that but it failed~~ not sure where I got .19 from, probably an old version of the circleci PR.

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-02-13 23:02](https://github.com/ethereum/solidity/pull/3467#issuecomment-365435217):

Updated #3491 and that demangling issue happens there too even without the jsoncpp changes.

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-02-13 23:02](https://github.com/ethereum/solidity/pull/3467#issuecomment-365435247):

@chriseth `trzeci/emscripten:sdk-tag-1.37.21-64bit` failed also.. also some missing standard lib symbols.. it's really strange... there must be other differences..
```
(function (exports, require, module, __filename, __dirname) { var Module;if(!Module)Module=(typeof Module!=="undefined"?Module:null)||{};var moduleOverrides={};for(var key in Module){if(Module.hasOwnProperty(key)){moduleOverrides[key]=Module[key]}}var ENVIRONMENT_IS_WEB=false;var ENVIRONMENT_IS_WORKER=false;var ENVIRONMENT_IS_NODE=false;var ENVIRONMENT_IS_SHELL=false;if(Module["ENVIRONMENT"]){if(Module["ENVIRONMENT"]==="WEB"){ENVIRONMENT_IS_WEB=true}else if(Module["ENVIRONMENT"]==="WORKER"){ENVIRONMENT_IS_WORKER=true}else if(Module["ENVIRONMENT"]==="NODE"){ENVIRONMENT_IS_NODE=true}else if(Module["ENVIRONMENT"]==="SHELL"){ENVIRONMENT_IS_SHELL=true}else{throw new Error("The provided Module['ENVIRONMENT'] value is not valid. It must be one of: WEB|WORKER|NODE|SHELL.")}}else{ENVIRONMENT_IS_WEB=typeof window==="object";ENVIRONMENT_IS_WORKER=typeof importScripts==="function";ENVIRONMENT_IS_NODE=typeof process==="object"&&typeof require==="function"&&!ENVIRONMENT_IS_WEB&&!ENVIRONME
abort(-1) at Error
    at jsStackTrace (/tmp/tmp.wYO0uu72Zb/soljson.js:1:16688)
    at stackTrace (/tmp/tmp.wYO0uu72Zb/soljson.js:1:16859)
    at abort (/tmp/tmp.wYO0uu72Zb/soljson.js:19:11832)
    at __ZNSt3__16localeC1Ev (/tmp/tmp.wYO0uu72Zb/soljson.js:1:959617)
    at Array.KLa (/tmp/tmp.wYO0uu72Zb/soljson.js:5:633684)
    at Object.M5a [as dynCall_vi] (/tmp/tmp.wYO0uu72Zb/soljson.js:12:230974)
    at invoke_vi (/tmp/tmp.wYO0uu72Zb/soljson.js:1:974851)
    at Array.JLa (/tmp/tmp.wYO0uu72Zb/soljson.js:5:631740)
    at Object.Adb [as dynCall_iiiii] (/tmp/tmp.wYO0uu72Zb/soljson.js:12:275514)
    at invoke_iiiii (/tmp/tmp.wYO0uu72Zb/soljson.js:1:980976)
```
```
warning: unresolved symbol: _ZNSt3__115basic_streambufIcNS_11char_traitsIcEEE5uflowEv
warning: unresolved symbol: _ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEC1ERKS5_jjRKS4_
warning: unresolved symbol: _ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEaSERKS5_
warning: unresolved symbol: _ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6insertENS_11__wrap_iterIPKcEEc
warning: unresolved symbol: _ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE9push_backEc
warning: unresolved symbol: _ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE9__grow_byEjjjjjj
warning: unresolved symbol: _ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6appendEPKc
warning: unresolved symbol: _ZNSt3__115basic_streambufIcNS_11char_traitsIcEEE5imbueERKNS_6localeE
warning: unresolved symbol: _ZNSt3__115basic_streambufIcNS_11char_traitsIcEEE9underflowEv
warning: unresolved symbol: _ZNSt3__115basic_streambufIcNS_11char_traitsIcEEE4syncEv
warning: unresolved symbol: _ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE5eraseEjj
warning: unresolved symbol: _ZNSt3__16localeC1Ev
warning: unresolved symbol: _ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEC1ERKS5_
warning: unresolved symbol: _ZNSt3__115basic_streambufIcNS_11char_traitsIcEEE6xsgetnEPci
warning: unresolved symbol: _ZNSt3__18ios_base5clearEj
warning: unresolved symbol: _ZNSt3__113basic_istreamIcNS_11char_traitsIcEEED1Ev
warning: unresolved symbol: _ZNSt3__115basic_streambufIcNS_11char_traitsIcEEE9pbackfailEi
warning: unresolved symbol: _ZNSt3__115basic_streambufIcNS_11char_traitsIcEEEC2Ev
warning: unresolved symbol: _ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6__initEjc
warning: unresolved symbol: _ZNSt3__115basic_streambufIcNS_11char_traitsIcEEE8overflowEi
warning: unresolved symbol: _ZNKSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE7compareEPKc
warning: unresolved symbol: _ZNKSt3__121__basic_string_commonILb1EE20__throw_length_errorEv
warning: unresolved symbol: _ZNKSt3__120__vector_base_commonILb1EE20__throw_length_errorEv
warning: unresolved symbol: _ZNKSt3__120__vector_base_commonILb1EE20__throw_out_of_rangeEv
warning: unresolved symbol: _ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEEaSEc
warning: unresolved symbol: _ZNSt3__115basic_streambufIcNS_11char_traitsIcEEE6xsputnEPKci
warning: unresolved symbol: _ZNKSt3__16locale9use_facetERNS0_2idE
warning: unresolved symbol: _ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEED1Ev
warning: unresolved symbol: _ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6__initEPKcj
warning: unresolved symbol: _ZNSt3__18ios_base4initEPv
warning: unresolved symbol: _ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6appendEjc
warning: unresolved symbol: _ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6appendEPKcj
warning: unresolved symbol: _ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE7reserveEj
warning: unresolved symbol: _ZNSt3__16localeD1Ev
warning: unresolved symbol: _ZNSt13runtime_errorC2ERKNSt3__112basic_stringIcNS0_11char_traitsIcEENS0_9allocatorIcEEEE
warning: unresolved symbol: _ZNSt3__115basic_streambufIcNS_11char_traitsIcEEED2Ev
warning: unresolved symbol: _ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6assignEPKc
warning: unresolved symbol: _ZNSt3__16localeC1ERKS0_
warning: unresolved symbol: _ZNSt3__19basic_iosIcNS_11char_traitsIcEEED2Ev
warning: unresolved symbol: _ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6assignEjc
warning: unresolved symbol: _ZNSt3__16localeaSERKS0_
warning: unresolved symbol: _ZNKSt3__18ios_base6getlocEv
warning: unresolved symbol: _ZNSt3__112basic_stringIcNS_11char_traitsIcEENS_9allocatorIcEEE6assignEPKcj
warning: unresolved symbol: _ZNSt3__115basic_streambufIcNS_11char_traitsIcEEE9showmanycEv
warning: unresolved symbol: _ZNSt3__113basic_istreamIcNS_11char_traitsIcEEErsERi
warning: unresolved symbol: _ZNSt3__15ctypeIcE2idE
warning: unresolved symbol: _ZNSt3__17collateIcE2idE
warning: unresolved symbol: _ZNSt3__18numpunctIcE2idE
warning: unresolved symbol: _ZTINSt3__115basic_streambufIcNS_11char_traitsIcEEEE
warning: unresolved symbol: _ZTVNSt3__113basic_istreamIcNS_11char_traitsIcEEEE
```

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-02-13 23:06](https://github.com/ethereum/solidity/pull/3467#issuecomment-365436268):

> Updated #3491 and that demangling issue happens there too even without the jsoncpp changes.

@axic good to know..

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-02-15 10:00](https://github.com/ethereum/solidity/pull/3467#issuecomment-365878734):

@aarlt as a next step would you be able to split out changes which introduce helpers for decoding/encoding without changing the jsoncpp version? I think we could merge that quickly.

After that this PR would only deal with a thin layer of jsoncpp version related changes.

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-02-15 19:28](https://github.com/ethereum/solidity/pull/3467#issuecomment-366035336):

@axic great!  I just noticed that the code is 100% compatible with jsoncpp 1.7.7!  the `Json::StreamWriterBuilder` & `Json::CharReaderBuilder` classes where already present in the old version! I will remove all the additional build-system changes - we can later just upgrade `jsoncpp.cmake` to version 1.8.4!

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-02-15 22:59](https://github.com/ethereum/solidity/pull/3467#issuecomment-366090770):

@axic I created a new PR #3532 (libdevcore/JSON.h - new API) that contains the major code changes - I will reduce the current PR #3467 to just contain the changes in `jsoncpp.cmake`.

So after merging #3532 the new `jsoncpp` version will hopefully just work - of course we need to fix the issues with the emscripten build. Additionally to that the emscripten build need to be changed abit, `scripts/travis-emscripten/build_emscripten.sh` is currently using the systems `cmake`, that is shipped with `trzeci/emscripten:sdk-tag-1.X.Y-64bit`, it is not using the one that is installed with `scripts/install_cmake.sh`. 

The new `jsoncpp` (at least version 1.8.4) needs a minimum cmake version of `3.1`, that is currently not provided by `trzeci/emscripten:sdk`, at least not within version `1.37.33-64bit`. But let's just wait until the `emscripten` linking problems are solved - probably `trzeci/emscripten:sdk` is then based on a more recent system.

#### <img src="https://avatars.githubusercontent.com/u/9073706?v=4" width="50">[chriseth](https://github.com/chriseth) commented at [2018-02-19 16:09](https://github.com/ethereum/solidity/pull/3467#issuecomment-366737416):

Please also update `create_source_taball.sh`.

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-02-20 17:13](https://github.com/ethereum/solidity/pull/3467#issuecomment-367049126):

@chriseth Ok, I changed `scripts/create_source_tarball.sh` and `scripts/release_ppa.sh`

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-02-20 21:36](https://github.com/ethereum/solidity/pull/3467#issuecomment-367128400):

@aarlt rebased, please pull before you push :)

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-02-20 21:54](https://github.com/ethereum/solidity/pull/3467#issuecomment-367133313):

Now it fails with a different issue on Travis:

```
[  5%] Performing configure step for 'jsoncpp-project'
CMake Error at CMakeLists.txt:3 (CMAKE_MINIMUM_REQUIRED):
  CMake 3.1 or higher is required.  You are running version 3.0.2
```

(This was noted in #2829 that jsoncpp requires cmake 3.1)

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-02-20 21:58](https://github.com/ethereum/solidity/pull/3467#issuecomment-367134526):

@axic it always failed, it need to use the `cmake` that is installed with `scripts/install_cmake.sh` - its currently using the system version - that is really old. I solved that by just setting the `PATH` in `scripts/install_cmake.sh` and `source` it in the `build_emscripten.sh` - also `build.sh` have a problem here, but here its just ok, because its more recent.

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-02-20 22:04](https://github.com/ethereum/solidity/pull/3467#issuecomment-367136416):

@axic should the build scripts be changed during this PR?

#### <img src="https://avatars.githubusercontent.com/u/573380?u=6cd4b0f473d862749cbed137d0bb32b726ae071f&v=4" width="50">[chfast](https://github.com/chfast) commented at [2018-02-20 22:26](https://github.com/ethereum/solidity/pull/3467#issuecomment-367142490):

To fix empscriten build on Travis you can try to just upgrade the Emscripten docker image. But I usually had problems with this (weird build errors in other places).

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-02-20 22:31](https://github.com/ethereum/solidity/pull/3467#issuecomment-367143847):

@aarlt I guess it is worth a try.

@chfast that is currently being fixed/investigated in #3491

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-02-20 22:48](https://github.com/ethereum/solidity/pull/3467#issuecomment-367148234):

@chfast As far as I know, the system that is used in `trzeci/emscripten:sdk-tag-1.35.4-64bit` - and later version are quite old ubuntu's. Only older cmake versions provided there. 

@axic Ok, I will do that. But I guess it makes more sense to wait until you fixed the problems with `emscripten` and the old `jsoncpp v1.7.7` - after that I could fix the `cmake` version specific problem here. 
The strange thing is, that I solved the problem with `trzeci/emscripten:sdk-tag-1.37.33-64 bit` by remove that aggressive variable optimisation (that version had a bug in optimiser). Everything worked really nice within my docker using `trzeci/emscripten:sdk-tag-1.37.33-64 bit`, after pushing that to travis I also saw the unresolved symbols for the standard libs. I had really no explanation for that, probably something is going wrong on travis? The docker images should exactly behave identical, if same versions are used. At least I would expect that.

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-02-20 22:51](https://github.com/ethereum/solidity/pull/3467#issuecomment-367148984):

@axic cache cleaning sounds super good!

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-02-27 01:22](https://github.com/ethereum/solidity/pull/3467#issuecomment-368712681):

@aarlt it didn't fix it. We're not going ahead with the emscripten update at the moment. Can you try fixing cmake instead?

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-02-27 18:09](https://github.com/ethereum/solidity/pull/3467#issuecomment-368972040):

@axic ok, I did the changes.

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-02-27 19:34](https://github.com/ethereum/solidity/pull/3467#issuecomment-368999060):

@aarlt thanks! Can you please rebase the PR, not sure if there were any changes in the relevant files, but the build has been changed to be faster.

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-02-27 19:40](https://github.com/ethereum/solidity/pull/3467#issuecomment-369000645):

@axic PR rebased. Lets see whether its working ;)

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-02-27 23:19](https://github.com/ethereum/solidity/pull/3467#issuecomment-369062775):

> What I heard is the internet access is restricted only to official packages repo.

That is the official jsoncpp repo.

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-02-27 23:31](https://github.com/ethereum/solidity/pull/3467#issuecomment-369065375):

Fails to link on travis:
```
[100%] Linking CXX executable soljson.js
WARNING:root:Assigning a non-existent settings attribute "NODEJS_CATCH_EXIT"
WARNING:root: - perhaps a typo in emcc's  -s X=Y  notation?
WARNING:root: - (see src/settings.js for valid values)
WARNING:root:generating system library: libcxx.a...
WARNING:root:                                      ok
WARNING:root:generating system library: libcxxabi.bc...
WARNING:root:                                          ok
error: unresolved symbol: _ZN4Json5ValueC1EOS0_
error: unresolved symbol: _ZN4Json5Value6appendEOS0_
```

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-02-27 23:53](https://github.com/ethereum/solidity/pull/3467#issuecomment-369069980):

Yep, the good old problem. I had it once running with `trzeci/emscripten:sdk-tag-1.37.33-64 bit`. But that failed on travis. I thought really that cleaning up the caches will fix the issue. The strange thing was that I was able to build the stuff within a `trzeci/emscripten:sdk-tag-1.37.33-64 bit` docker - on my machine everything was nice. On travis, with at this time exactly the same environment failed. Have you checked all potential caches? Is it possible to just do a clean build, that is not using any caching mechanisms? The big question is: why does it build on circleci?

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-02-28 00:07](https://github.com/ethereum/solidity/pull/3467#issuecomment-369072690):

Maybe jsoncpp uses some weird C++ construct that older version of emscripten cannot handle and decides those symbols aren't used. Not sure yet why the newer emscripten version is working on circleci, but not on travis :)

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-02-28 00:09](https://github.com/ethereum/solidity/pull/3467#issuecomment-369073128):

Demangling those two symbols:
- `Json::Value::Value(Json::Value&&)`
- `Json::Value::append(Json::Value&&)`

Both of these are defined under `#if JSON_HAS_RVALUE_REFERENCES`. My hunch is either we don't properly defined that (or the config is broken) or the old emscripten had issues with rvalue references (unlikely, since we use them).

#### <img src="https://avatars.githubusercontent.com/u/9073706?v=4" width="50">[chriseth](https://github.com/chriseth) commented at [2018-02-28 16:45](https://github.com/ethereum/solidity/pull/3467#issuecomment-369301866):

I remember that the old jsoncpp did not have move semantics (i.e. rvalues), perhaps it is still linking to the old one but compiling with the new header?

#### <img src="https://avatars.githubusercontent.com/u/9073706?v=4" width="50">[chriseth](https://github.com/chriseth) commented at [2018-03-06 15:41](https://github.com/ethereum/solidity/pull/3467#issuecomment-370823625):

Moved to 0.5.0

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-03-15 10:37](https://github.com/ethereum/solidity/pull/3467#issuecomment-373332418):

Need to revert https://github.com/ethereum/solidity/pull/3614 when working on this branch.

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-04-17 08:00](https://github.com/ethereum/solidity/pull/3467#issuecomment-381888288):

Rebased as I think this should be now working after #3888.

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-04-17 08:21](https://github.com/ethereum/solidity/pull/3467#issuecomment-381895409):

Sadly this is still not linking.

@chfast do you have any idea why it would still pick up and older version of the jsoncpp library?

That library line in cmake looks suspicious.

#### <img src="https://avatars.githubusercontent.com/u/573380?u=6cd4b0f473d862749cbed137d0bb32b726ae071f&v=4" width="50">[chfast](https://github.com/chfast) commented at [2018-04-17 08:29](https://github.com/ethereum/solidity/pull/3467#issuecomment-381898071):

@axic Can you show the logs?

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-04-17 08:31](https://github.com/ethereum/solidity/pull/3467#issuecomment-381898771):

It is the emscripten task of travis: https://travis-ci.org/ethereum/solidity/jobs/367535890

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-04-17 09:16](https://github.com/ethereum/solidity/pull/3467#issuecomment-381915165):

Didn't help.

#### <img src="https://avatars.githubusercontent.com/u/573380?u=6cd4b0f473d862749cbed137d0bb32b726ae071f&v=4" width="50">[chfast](https://github.com/chfast) commented at [2018-04-17 09:38](https://github.com/ethereum/solidity/pull/3467#issuecomment-381922990):

So it's rather using new header but link the old lib.
Are you sure nothing is cached on Travis?

You can add `static_assert` in solidity code and check any of these: https://github.com/open-source-parsers/jsoncpp/blob/master/include/json/version.h#L7-L11.

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-04-17 10:01](https://github.com/ethereum/solidity/pull/3467#issuecomment-381930676):

My suspicion was the library part:

> @chfast do you have any idea why it would still pick up and older version of the jsoncpp library?
>
> That library line in cmake looks suspicious.

Cleared cache couple of times, but who knows.

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-04-20 20:14](https://github.com/ethereum/solidity/pull/3467#issuecomment-383209776):

@aarlt this is now compiling :)

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-04-20 20:15](https://github.com/ethereum/solidity/pull/3467#issuecomment-383210022):

Without the `std=c++11` changes there were certain warnings:
```
-- Build files have been written to: /root/project/build/deps/src/jsoncpp-project-build
[  5%] Performing build step for 'jsoncpp-project'
make[3]: warning: jobserver unavailable: using -j1.  Add '+' to parent make rule.
Scanning dependencies of target jsoncpp_lib_static
[ 25%] Building CXX object src/lib_json/CMakeFiles/jsoncpp_lib_static.dir/json_reader.cpp.o
In file included from /root/project/build/deps/src/jsoncpp-project/src/lib_json/json_reader.cpp:9:
In file included from /root/project/build/deps/src/jsoncpp-project/include/json/reader.h:11:
/root/project/build/deps/src/jsoncpp-project/include/json/value.h:404:3: warning: explicit conversion functions are a C++11 extension [-Wc++11-extensions]
  explicit operator bool() const;
  ^~~~~~~~
1 warning generated.
[ 50%] Building CXX object src/lib_json/CMakeFiles/jsoncpp_lib_static.dir/json_value.cpp.o
In file included from /root/project/build/deps/src/jsoncpp-project/src/lib_json/json_value.cpp:8:
/root/project/build/deps/src/jsoncpp-project/include/json/value.h:404:3: warning: explicit conversion functions are a C++11 extension [-Wc++11-extensions]
  explicit operator bool() const;
  ^~~~~~~~
1 warning generated.
[ 75%] Building CXX object src/lib_json/CMakeFiles/jsoncpp_lib_static.dir/json_writer.cpp.o
In file included from /root/project/build/deps/src/jsoncpp-project/src/lib_json/json_writer.cpp:7:
In file included from /root/project/build/deps/src/jsoncpp-project/include/json/writer.h:10:
/root/project/build/deps/src/jsoncpp-project/include/json/value.h:404:3: warning: explicit conversion functions are a C++11 extension [-Wc++11-extensions]
  explicit operator bool() const;
  ^~~~~~~~
1 warning generated.
[100%] Linking CXX static library libjsoncpp.a
```

#### <img src="https://avatars.githubusercontent.com/u/5008794?u=aa5f725afdad81154a79cd5ab6be9340b08da4a9&v=4" width="50">[aarlt](https://github.com/aarlt) commented at [2018-04-20 21:51](https://github.com/ethereum/solidity/pull/3467#issuecomment-383232175):

@axic yep its compiling :) i wrote that on gitter - but looks like u missed it :)

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-04-23 10:09](https://github.com/ethereum/solidity/pull/3467#issuecomment-383524273):

For some reason now Travis is emotional again:
```
Testing overwriting files
Testing soljson via the fuzzer...
Commandline tests successful.
No output has been received in the last 10m0s, this potentially indicates a stalled build or something wrong with the build itself.
Check the details on how to adjust your build configuration on: https://docs.travis-ci.com/user/common-build-problems/#Build-times-out-because-no-output-was-received
The build has been terminated
```

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-04-23 11:39](https://github.com/ethereum/solidity/pull/3467#issuecomment-383545600):

@chriseth can you have a look at this?

#### <img src="https://avatars.githubusercontent.com/u/20340?v=4" width="50">[axic](https://github.com/axic) commented at [2018-04-23 12:09](https://github.com/ethereum/solidity/pull/3467#issuecomment-383552441):

@chriseth are you ok with this? Travis emscripten works. I'll remove the last commit if you're happy with this version before merging.


-------------------------------------------------------------------------------



[Export of Github issue for [ethereum/solidity](https://github.com/ethereum/solidity). Generated on 2024.12.15 at 06:45:24.]
