# [\#8581 PR](https://github.com/ethereum/solidity/pull/8581) `merged`: Debug information for immutable references.

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) opened issue at [2020-04-02 15:28](https://github.com/ethereum/solidity/pull/8581):

Reminder: needs documentation when format is decided.

#### <img src="https://avatars.githubusercontent.com/u/9073706?v=4" width="50">[chriseth](https://github.com/chriseth) commented at [2020-04-02 15:54](https://github.com/ethereum/solidity/pull/8581#issuecomment-607931587):

Please don't forget the metadata!

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) commented at [2020-04-02 15:58](https://github.com/ethereum/solidity/pull/8581#issuecomment-607933989):

We don't have link references in the metadata yet either... and I'm not sure there's a natural place for either of them so far... so we should probably first decide where to put both of those exactly? Just besides the abi? Also: so far the metadata doesn't depend on code generation, so that would also change...

#### <img src="https://avatars.githubusercontent.com/u/9073706?v=4" width="50">[chriseth](https://github.com/chriseth) commented at [2020-04-02 16:00](https://github.com/ethereum/solidity/pull/8581#issuecomment-607935533):

But I think it would be really useful to mark places in the (runtime) bytecode that could be different from the ones generated by recompiling. On the other hand, if you recompile, you get them anyway....

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) commented at [2020-04-02 16:41](https://github.com/ethereum/solidity/pull/8581#issuecomment-607959018):

Independently of the metadata question, I'm not quite happy with the identifiers as keys... they actually need to be parsed the way they are... or generated from the AST... plus we fix the names of the stack slot identifiers...

I'm wondering whether it'd be nicer to have:
```
  astId: [ [offsetOfStackSlot1OfOccurrence1, offsetOfStackSlot2OfOccurrence1], [offsetOfStackSlot1OfOccurrence2, offsetOfStackSlot2OfOccurrence2]]
```
That would be more effort to generate from what we store now, but maybe it'd be worth it...

#### <img src="https://avatars.githubusercontent.com/u/9073706?v=4" width="50">[chriseth](https://github.com/chriseth) commented at [2020-04-02 16:44](https://github.com/ethereum/solidity/pull/8581#issuecomment-607960719):

I don't think we should provide fine-grained stack slot resolution, but probably lengths would make sense. This would also allow use to switch to a codecopy-based method later.

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) commented at [2020-04-02 16:54](https://github.com/ethereum/solidity/pull/8581#issuecomment-607966022):

So I just include the contained PUSH32 opcodes in the bytecode range for multi-slot immutables?

#### <img src="https://avatars.githubusercontent.com/u/9073706?v=4" width="50">[chriseth](https://github.com/chriseth) commented at [2020-04-02 16:58](https://github.com/ethereum/solidity/pull/8581#issuecomment-607968446):

Ah, forgot about the push32 opcodes...

#### <img src="https://avatars.githubusercontent.com/u/9073706?v=4" width="50">[chriseth](https://github.com/chriseth) commented at [2020-04-02 16:59](https://github.com/ethereum/solidity/pull/8581#issuecomment-607969246):

So to make it proper we would need something like:
```
[// for each reference
  [// for each "part"
    [offset, size]
  ]
]
```

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) commented at [2020-04-02 17:00](https://github.com/ethereum/solidity/pull/8581#issuecomment-607969483):

We should probably also consider that we may want to switch from push32 to push[justBigEnough].

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) commented at [2020-04-02 17:00](https://github.com/ethereum/solidity/pull/8581#issuecomment-607969741):


> So to make it proper we would need something like:
> 
> ```
> [// for each reference
>   [// for each "part"
>     [offset, size]
>   ]
> ]
> ```

Yes exactly... but it's not really nice either :-).

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) commented at [2020-04-02 17:15](https://github.com/ethereum/solidity/pull/8581#issuecomment-607978325):

I now switched to offset/size for the current identifiers...
Which is better? Somewhat weird fragile string identifiers or cryptic ID-indexed deeply nested arrays? I'm really not sure :-)... maybe there's still an entirely different and better way...

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) commented at [2020-04-02 17:18](https://github.com/ethereum/solidity/pull/8581#issuecomment-607979792):

A potential advantage of the strings is that they are the same ones that occur e.g. in json assembly...
We could also just change those strings - the AST ID plus a stack slot name (if any) should be enough...

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) commented at [2020-04-02 17:45](https://github.com/ethereum/solidity/pull/8581#issuecomment-608001064):

Ok I changed the identifiers now to ``<ASTID> <spaceSeparatedListOfStackSlotNames>``, so e.g.
``10 address`` and ``10 functionIdentifier`` for a function pointer or just ``12`` for an integer.

Instead we could also go for ``10.0`` and ``10.1``, i.e. just use numeric IDs for the stack slots instead of names...

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) commented at [2020-04-02 17:45](https://github.com/ethereum/solidity/pull/8581#issuecomment-608002716):

Or... we could just disallow external function types for the release and sort this out later :-). They are the only value types with more than one stack slot...

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) commented at [2020-04-02 18:02](https://github.com/ethereum/solidity/pull/8581#issuecomment-608015318):

Especially since we could also still decide to pack the external function pointers into a single slot just as in memory...

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) commented at [2020-04-06 09:24](https://github.com/ethereum/solidity/pull/8581#issuecomment-609679136):

I added documentation and while doing so I actually changed this to now:
```
"immutableReferences": {
 "<astId>": [ { "start": 42, "length": 32 }]
}
```
That's how link references look and this way we can add more fields later if needed (e.g. an "offset" might be useful for an array slice using a codecopy approach, etc.).


-------------------------------------------------------------------------------



[Export of Github issue for [ethereum/solidity](https://github.com/ethereum/solidity). Generated on 2024.12.15 at 06:45:24.]
