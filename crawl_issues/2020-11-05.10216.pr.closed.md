# [\#10216 PR](https://github.com/ethereum/solidity/pull/10216) `closed`: Include bytecode with stripped metadata in command-line test output

#### <img src="https://avatars.githubusercontent.com/u/137030?v=4" width="50">[cameel](https://github.com/cameel) opened issue at [2020-11-05 17:45](https://github.com/ethereum/solidity/pull/10216):

This is needed to make it possible to create sensible linker tests. Bytecode contains metadata hash and compiler version and these change constantly. Looks like this was already noticed because `cmdlineTests.sh` strips the bytecode completely from Standard JSON test output. For other tests it does not but we just do not yet have any non-JSON tests using the `--bin` flag so it was not needed do far. Also in non-JSON output the bytecode is a bit harder to detect with regex without risking false-positives.

My PR makes this consistent in both JSON and non-JSON tests: bytecode is now included but the metadata is replaced with a constant placeholder so that tests won't blow up in CI.

Metadata is detected based on markers mentioned in [Contract Metadata > Encoding of the Metadata Hash in the Bytecode](https://solidity.readthedocs.io/en/v0.7.4/metadata.html#encoding-of-the-metadata-hash-in-the-bytecode).

Unfortunately the final `0x00 0x33` marker is not reliable. It's different in non-release builds. I think it contains something that depends on the length of the version string or the whole binary. For that reason I had no choice but to make an assumption that the version is the last thing in the binary. It would be more reliable if I made it decode the CBOR data but that seems like an overkill for our limited needs.

#### <img src="https://avatars.githubusercontent.com/u/137030?v=4" width="50">[cameel](https://github.com/cameel) commented at [2020-11-05 17:54](https://github.com/ethereum/solidity/pull/10216#issuecomment-722538921):

Looks like tests fail due to one-byte difference in the bytecode. That's probably due to changes in `develop` I rebased on. I'll update them.

This unfortunately shows a downside of this change: any changes to the generated bytecode will require updating command-line tests.

#### <img src="https://avatars.githubusercontent.com/u/137030?v=4" width="50">[cameel](https://github.com/cameel) commented at [2020-11-05 19:28](https://github.com/ethereum/solidity/pull/10216#issuecomment-722591704):

Moving back to draft. Even before merging it, dealing with the bytecode changes is already annoying :) I'm going to change the regex so that the bytecode gets replaced with multiple placeholders with link references left intact in between.

#### <img src="https://avatars.githubusercontent.com/u/137030?v=4" width="50">[cameel](https://github.com/cameel) commented at [2020-11-06 10:48](https://github.com/ethereum/solidity/pull/10216#issuecomment-723013832):

Looks like removing just the metadata wouldn't be viable anyway. The binary generated in `t_ubu_release_cli` differs by one byte from the one on my machine. The difference is `0x60 0xbf` vs `0x60 0x9a`.

I inspected the raw opcodes to make sure it's not a bug. It comes from `dataSize(sub_0)`. So the different size of the version string affects the size of the subassembly and results in a slightly different binary.

In that case removing everything but linker references is the way to go.

#### <img src="https://avatars.githubusercontent.com/u/137030?v=4" width="50">[cameel](https://github.com/cameel) commented at [2020-11-09 11:19](https://github.com/ethereum/solidity/pull/10216#issuecomment-723949503):

Closing in favor of #10225 which completely strips the bytecode, not just metadata.


-------------------------------------------------------------------------------



[Export of Github issue for [ethereum/solidity](https://github.com/ethereum/solidity). Generated on 2024.12.15 at 06:45:24.]
