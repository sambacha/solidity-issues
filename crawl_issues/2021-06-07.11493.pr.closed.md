# [\#11493 PR](https://github.com/ethereum/solidity/pull/11493) `closed`: Enable new Yul->EVM code generation. (New Code Transform Step 4)

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) opened issue at [2021-06-07 09:13](https://github.com/ethereum/solidity/pull/11493):

Depends on https://github.com/ethereum/solidity/pull/11974

I'm keeping a general description of the process here in https://hackmd.io/3xjDedzmRJWuyfK7RKUwQw

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) commented at [2021-06-09 20:14](https://github.com/ethereum/solidity/pull/11493#issuecomment-858070337):

By the way as for runtime: there are quite a few cases, in which the complexity of the provisional algorithm black boxes pretty much sucks and we can hopefully improve them, but in practice I'm getting the following:
Old code generator:
```
$ time { for i in $(seq 1 10); do build/test/tools/isoltest -t sem*/externalCon* &> /dev/null ; done ; }

real    0m27,038s
user    0m26,737s
sys     0m0,253s
```
New code generator:
```
$ time { for i in $(seq 1 10); do build/test/tools/isoltest -t sem*/externalCon* &> /dev/null ; done ; }

real    0m29,352s
user    0m29,058s
sys     0m0,246s
```
So that's "only" <10% slower, which is not as bad as I would have expected. And I'm quite sure we can bring it down quite a bit by improving those parts.

EDIT: Lol, I must have been quite tired, looking at this again it seems I just didn't pass ``--optimize`` to those runs - actually interesting that I still got a 10% difference :-). I'll have another look at it properly.

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) commented at [2021-06-10 17:05](https://github.com/ethereum/solidity/pull/11493#issuecomment-858794165):

So I ran another compile time comparison on the external contracts and am now getting this:
This branch:
```
$ time { for i in $(seq 1 10); do ./build/test/tools/isoltest -t sem*/externalContr* --optimize &> /dev/null ; done ; }

real    0m50,439s
user    0m50,096s
sys     0m0,254s
```
develop:
```
daniel@ekpyrosis solidity_tmp $ time { for i in $(seq 1 10); do ./build/test/tools/isoltest -t sem*/externalContr* --optimize &> /dev/null ; done ; }

real    0m46,675s
user    0m46,330s
sys     0m0,265s
```

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) commented at [2021-07-05 13:27](https://github.com/ethereum/solidity/pull/11493#issuecomment-874114326):

Rebased this again on top of develop after the merge of https://github.com/ethereum/solidity/pull/10286. Also removed the inlining change for now. Resulting gas difference still looks good, although of course less spectacular (and there are a few outliners that deteriorate that might be worth a closer look at at some point):

<details><summary>Click for a table of gas differences</summary>

| File name                                                                |   IR-optimized (%) |   Legacy-Optimized (%) |   Legacy (%) |
|--------------------------------------------------------------------------|--------------------|------------------------|--------------|
| interface_inheritance_conversions.sol                                    |       -2.10593     |                      0 |            0 |
| events/event_indexed_string.sol                                          |       -2.70823     |                      0 |            0 |
| events/event_indexed_mixed.sol                                           |       -0.0379987   |                      0 |            0 |
| events/event_dynamic_nested_array_storage_v2.sol                         |       -0.0215559   |                      0 |            0 |
| events/event_dynamic_array_storage_v2.sol                                |       -0.0452899   |                      0 |            0 |
| events/event_dynamic_array_storage.sol                                   |       -0.0452899   |                      0 |            0 |
| functionCall/failed_create.sol                                           |        2.66324     |                      0 |            0 |
| functionCall/mapping_array_internal_argument.sol                         |       -0.508838    |                      0 |            0 |
| externalContracts/snark.sol                                              |       -5.2279      |                      0 |            0 |
| externalContracts/ramanujan_pi.sol                                       |       -9.83212     |                      0 |            0 |
| externalContracts/prbmath_unsigned.sol                                   |        0.678395    |                      0 |            0 |
| externalContracts/deposit_contract.sol                                   |       -1.74679     |                      0 |            0 |
| externalContracts/prbmath_signed.sol                                     |       -1.35946     |                      0 |            0 |
| externalContracts/FixedFeeRegistrar.sol                                  |       -0.716522    |                      0 |            0 |
| externalContracts/strings.sol                                            |       -8.15007     |                      0 |            0 |
| constructor/arrays_in_constructors.sol                                   |       -0.0411035   |                      0 |            0 |
| constructor/no_callvalue_check.sol                                       |       -0.0601186   |                      0 |            0 |
| constructor/bytes_in_constructors_packer.sol                             |       -0.363897    |                      0 |            0 |
| abiencodedecode/abi_decode_simple_storage.sol                            |       -0.027942    |                      0 |            0 |
| inlineAssembly/keccak_yul_optimization.sol                               |       -0.176634    |                      0 |            0 |
| inheritance/inherited_function_calldata_calldata_interface.sol           |       -4.35312     |                      0 |            0 |
| inheritance/address_overload_resolution.sol                              |       -3.80428     |                      0 |            0 |
| inheritance/inherited_function_calldata_memory_interface.sol             |        4.29385     |                      0 |            0 |
| functionTypes/store_function.sol                                         |       -0.621187    |                      0 |            0 |
| storage/packed_storage_structs_bytes.sol                                 |       -0.415862    |                      0 |            0 |
| abiEncoderV2/abi_encode_calldata_slice.sol                               |       -3.5051      |                      0 |            0 |
| abiEncoderV2/storage_array_encoding.sol                                  |       -0.0629787   |                      0 |            0 |
| abiEncoderV2/abi_encode_v2_in_modifier_used_in_v1_contract.sol           |       -0.746954    |                      0 |            0 |
| abiEncoderV2/abi_encode_v2_in_function_inherited_in_v1_contract.sol      |       -0.386104    |                      0 |            0 |
| abiEncoderV2/calldata_array.sol                                          |       -1.28349     |                      0 |            0 |
| abiEncoderV2/abi_encode_v2.sol                                           |        0.0706115   |                      0 |            0 |
| abiEncoderV1/abi_encode_calldata_slice.sol                               |       -3.5051      |                      0 |            0 |
| abiEncoderV1/abi_decode_v2_storage.sol                                   |       -0.0579693   |                      0 |            0 |
| abiEncoderV1/struct/struct_storage_ptr.sol                               |       -0.0161083   |                      0 |            0 |
| viaYul/array_storage_length_access.sol                                   |       -0.310396    |                      0 |            0 |
| viaYul/array_storage_index_boundary_test.sol                             |       -1.04523     |                      0 |            0 |
| viaYul/array_memory_index_access.sol                                     |       -8.91597     |                      0 |            0 |
| viaYul/array_storage_index_access.sol                                    |       -0.37952     |                      0 |            0 |
| viaYul/array_storage_push_empty_length_address.sol                       |       -1.21753     |                      0 |            0 |
| viaYul/array_storage_push_empty.sol                                      |       -0.550261    |                      0 |            0 |
| viaYul/array_storage_push_pop.sol                                        |       -0.851216    |                      0 |            0 |
| viaYul/simple.sol                                                        |        0           |                      0 |            0 |
| viaYul/array_storage_index_zeroed_test.sol                               |       -0.423478    |                      0 |            0 |
| salted_create/salted_create.sol                                          |       -3.45392e-05 |                      0 |            0 |
| salted_create/salted_create_with_value.sol                               |        1.09896     |                      0 |            0 |
| array/function_array_cross_calls.sol                                     |        2.17292     |                      0 |            0 |
| array/reusing_memory.sol                                                 |       -0.525651    |                      0 |            0 |
| array/byte_array_transitional_2.sol                                      |       -3.81724     |                      0 |            0 |
| array/bytes_length_member.sol                                            |       -0.00543286  |                      0 |            0 |
| array/dynamic_multi_array_cleanup.sol                                    |       -0.475173    |                      0 |            0 |
| array/byte_array_storage_layout.sol                                      |       -1.55687     |                      0 |            0 |
| array/dynamic_array_cleanup.sol                                          |       -0.0741794   |                      0 |            0 |
| array/fixed_arrays_as_return_type.sol                                    |       -1.63172     |                      0 |            0 |
| array/dynamic_arrays_in_storage.sol                                      |       -0.473052    |                      0 |            0 |
| array/arrays_complex_from_and_to_storage.sol                             |       -0.0205732   |                      0 |            0 |
| array/fixed_array_cleanup.sol                                            |       -0.0249093   |                      0 |            0 |
| array/create_memory_array.sol                                            |       -7.19321     |                      0 |            0 |
| array/delete/delete_storage_array_packed.sol                             |       -0.144665    |                      0 |            0 |
| array/delete/bytes_delete_element.sol                                    |       -2.15863     |                      0 |            0 |
| array/push/nested_bytes_push.sol                                         |       -0.152335    |                      0 |            0 |
| array/push/array_push_packed_array.sol                                   |       -0.212446    |                      0 |            0 |
| array/push/array_push_struct_from_calldata.sol                           |       -0.132998    |                      0 |            0 |
| array/push/array_push_nested_from_calldata.sol                           |       -0.095244    |                      0 |            0 |
| array/push/byte_array_push_transition.sol                                |       -3.94912     |                      0 |            0 |
| array/push/push_no_args_2d.sol                                           |       -1.84863     |                      0 |            0 |
| array/push/array_push_struct.sol                                         |       -0.252446    |                      0 |            0 |
| array/push/push_no_args_bytes.sol                                        |       -3.26665     |                      0 |            0 |
| array/push/array_push.sol                                                |        0.0332468   |                      0 |            0 |
| array/copying/array_copy_storage_storage_different_base_nested.sol       |       -0.182776    |                      0 |            0 |
| array/copying/array_copy_storage_to_memory_nested.sol                    |        0.0241119   |                      0 |            0 |
| array/copying/array_copy_storage_storage_static_static.sol               |        0.055081    |                      0 |            0 |
| array/copying/copy_function_storage_array.sol                            |        0.33515     |                      0 |            0 |
| array/copying/array_copy_different_packing.sol                           |       -0.0272724   |                      0 |            0 |
| array/copying/array_copy_storage_storage_static_dynamic.sol              |       -0.00568311  |                      0 |            0 |
| array/copying/array_copy_storage_storage_dynamic_dynamic.sol             |       -0.0256593   |                      0 |            0 |
| array/copying/array_copy_clear_storage_packed.sol                        |       -0.0683615   |                      0 |            0 |
| array/copying/array_copy_target_simple_2.sol                             |       -0.00875842  |                      0 |            0 |
| array/copying/array_nested_calldata_to_storage.sol                       |       -0.135354    |                      0 |            0 |
| array/copying/memory_dyn_2d_bytes_to_storage.sol                         |       -0.713986    |                      0 |            0 |
| array/copying/array_storage_multi_items_per_slot.sol                     |       -0.404284    |                      0 |            0 |
| array/copying/array_nested_memory_to_storage.sol                         |       -0.0387816   |                      0 |            0 |
| array/copying/array_copy_including_array.sol                             |       -0.191831    |                      0 |            0 |
| array/copying/array_copy_target_simple.sol                               |       -0.0491595   |                      0 |            0 |
| array/copying/array_copy_cleanup_uint128.sol                             |       -0.145407    |                      0 |            0 |
| array/copying/copy_byte_array_in_struct_to_storage.sol                   |        0.0351555   |                      0 |            0 |
| array/copying/array_copy_target_leftover.sol                             |       -2.13875     |                      0 |            0 |
| array/copying/calldata_array_dynamic_to_storage.sol                      |       -0.0386677   |                      0 |            0 |
| array/copying/array_copy_storage_storage_struct.sol                      |       -0.123362    |                      0 |            0 |
| array/copying/bytes_inside_mappings.sol                                  |        0.0228918   |                      0 |            0 |
| array/copying/array_of_struct_memory_to_storage.sol                      |       -0.0184562   |                      0 |            0 |
| array/copying/copy_byte_array_to_storage.sol                             |       -0.190221    |                      0 |            0 |
| array/copying/array_copy_calldata_storage.sol                            |       -0.0311842   |                      0 |            0 |
| array/copying/copy_removes_bytes_data.sol                                |        0.0118379   |                      0 |            0 |
| array/copying/array_copy_target_leftover2.sol                            |        0.0543391   |                      0 |            0 |
| array/copying/array_copy_nested_array.sol                                |       -0.0357709   |                      0 |            0 |
| array/copying/array_of_struct_calldata_to_storage.sol                    |       -0.0981897   |                      0 |            0 |
| array/copying/storage_memory_nested.sol                                  |        0.0956383   |                      0 |            0 |
| array/copying/storage_memory_packed_dyn.sol                              |       -0.551637    |                      0 |            0 |
| array/copying/array_of_structs_containing_arrays_memory_to_storage.sol   |        0.0381656   |                      0 |            0 |
| array/copying/array_copy_storage_storage_dyn_dyn.sol                     |       -0.0547149   |                      0 |            0 |
| array/copying/storage_memory_nested_bytes.sol                            |        0.0241677   |                      0 |            0 |
| array/copying/storage_memory_nested_struct.sol                           |        0.0534387   |                      0 |            0 |
| array/copying/array_copy_storage_storage_different_base.sol              |       -0.0738513   |                      0 |            0 |
| array/copying/array_copy_clear_storage.sol                               |       -0.0318177   |                      0 |            0 |
| array/copying/array_of_structs_containing_arrays_calldata_to_storage.sol |       -0.488825    |                      0 |            0 |
| array/copying/storage_memory_nested_from_pointer.sol                     |        0.0956383   |                      0 |            0 |
| array/copying/arrays_from_and_to_storage.sol                             |       -0.262827    |                      0 |            0 |
| array/copying/bytes_storage_to_storage.sol                               |       -2.83298     |                      0 |            0 |
| array/copying/array_copy_cleanup_uint40.sol                              |       -0.372254    |                      0 |            0 |
| array/pop/array_pop_uint24_transition.sol                                |       -1.23956     |                      0 |            0 |
| array/pop/byte_array_pop_masking_long.sol                                |       -0.657738    |                      0 |            0 |
| array/pop/array_pop_uint16_transition.sol                                |       -1.98208     |                      0 |            0 |
| array/pop/byte_array_pop_copy_long.sol                                   |       -1.28197     |                      0 |            0 |
| array/pop/byte_array_pop_long_storage_empty_garbage_ref.sol              |       -2.41516     |                      0 |            0 |
| array/pop/byte_array_pop_long_storage_empty.sol                          |       -4.15047     |                      0 |            0 |
| array/pop/array_pop_array_transition.sol                                 |       -0.00325648  |                      0 |            0 |
| immutable/multi_creation.sol                                             |       -0.661375    |                      0 |            0 |
| structs/struct_copy_via_local.sol                                        |        0.0018158   |                      0 |            0 |
| structs/struct_delete_storage_nested_small.sol                           |       -0.118999    |                      0 |            0 |
| structs/struct_delete_storage_with_array.sol                             |       -0.0780582   |                      0 |            0 |
| structs/structs.sol                                                      |       -0.0982223   |                      0 |            0 |
| structs/memory_structs_nested_load.sol                                   |       -0.0170903   |                      0 |            0 |
| structs/struct_copy.sol                                                  |        0.0153048   |                      0 |            0 |
| structs/struct_delete_storage_with_arrays_small.sol                      |       -0.230029    |                      0 |            0 |
| structs/struct_containing_bytes_copy_and_delete.sol                      |       -0.045584    |                      0 |            0 |
| structs/struct_memory_to_storage_function_ptr.sol                        |        0.340893    |                      0 |            0 |
| structs/conversion/recursive_storage_memory.sol                          |       -0.871451    |                      0 |            0 |
| structs/calldata/calldata_struct_with_nested_array_to_storage.sol        |       -0.146282    |                      0 |            0 |
| various/staticcall_for_view_and_pure.sol                                 |       -6.09517e-06 |                      0 |            0 |
| various/erc20.sol                                                        |       -3.2306      |                      0 |            0 |
| various/destructuring_assignment.sol                                     |        0.164771    |                      0 |            0 |
| various/swap_in_storage_overwrite.sol                                    |       -0.0109355   |                      0 |            0 |
| various/skip_dynamic_types_for_structs.sol                               |       -0.0167643   |                      0 |            0 |
</details>

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) commented at [2021-08-12 16:49](https://github.com/ethereum/solidity/pull/11493#issuecomment-897799785):

Gas differences for the lastest version compared to develop:

<details><summary>Click for a table of gas differences</summary>

| File name                                                                |   IR-optimized (%) |   Legacy-Optimized (%) |   Legacy (%) |
|--------------------------------------------------------------------------|--------------------|------------------------|--------------|
| interface_inheritance_conversions.sol                                    |       -2.31312     |            0           |            0 |
| events/event_indexed_string.sol                                          |       -2.8624      |           -1.06218     |            0 |
| events/event_indexed_mixed.sol                                           |        0.10133     |           -0.03789     |            0 |
| events/event_dynamic_nested_array_storage_v2.sol                         |       -0.0700567   |            0.0260091   |            0 |
| events/event_dynamic_array_storage_v2.sol                                |       -0.0609671   |           -0.0262203   |            0 |
| events/event_dynamic_array_storage.sol                                   |       -0.0609671   |           -0.0262203   |            0 |
| functionCall/failed_create.sol                                           |       -0.408619    |           -1.52575     |            0 |
| functionCall/mapping_array_internal_argument.sol                         |       -0.508838    |           -0.0724631   |            0 |
| externalContracts/snark.sol                                              |       -5.43571     |           -1.96128     |            0 |
| externalContracts/ramanujan_pi.sol                                       |       -7.15177     |            0.218404    |            0 |
| externalContracts/prbmath_unsigned.sol                                   |        0.386611    |           -0.256389    |            0 |
| externalContracts/deposit_contract.sol                                   |       -2.29509     |           -1.4425      |            0 |
| externalContracts/prbmath_signed.sol                                     |       -1.8738      |           -0.148987    |            0 |
| externalContracts/FixedFeeRegistrar.sol                                  |       -1.53787     |           -2.48255     |            0 |
| externalContracts/strings.sol                                            |       -8.44192     |           -5.25153     |            0 |
| constructor/arrays_in_constructors.sol                                   |       -0.183987    |           -0.483315    |            0 |
| constructor/no_callvalue_check.sol                                       |       -0.0430579   |            0           |            0 |
| constructor/bytes_in_constructors_packer.sol                             |       -1.11091     |           -0.0348544   |            0 |
| abiencodedecode/abi_decode_simple_storage.sol                            |       -0.0617665   |           -0.100675    |            0 |
| inlineAssembly/keccak_yul_optimization.sol                               |       -0.176634    |            0           |            0 |
| inheritance/inherited_function_calldata_calldata_interface.sol           |       -4.35666     |            0           |            0 |
| inheritance/address_overload_resolution.sol                              |       -1.99196     |            0           |            0 |
| inheritance/inherited_function_calldata_memory_interface.sol             |        1.91189     |            1.47739     |            0 |
| functionTypes/store_function.sol                                         |        0.177771    |           -0.7795      |            0 |
| storage/packed_storage_structs_bytes.sol                                 |       -0.409942    |            0           |            0 |
| abiEncoderV2/abi_encode_calldata_slice.sol                               |       -4.49671     |           -3.6014      |            0 |
| abiEncoderV2/storage_array_encoding.sol                                  |       -0.0987234   |           -0.069951    |            0 |
| abiEncoderV2/abi_encode_v2_in_modifier_used_in_v1_contract.sol           |       -0.733352    |            0           |            0 |
| abiEncoderV2/abi_encode_v2_in_function_inherited_in_v1_contract.sol      |       -0.723427    |           -0.554845    |            0 |
| abiEncoderV2/calldata_array.sol                                          |       -4.12843     |           -2.29579     |            0 |
| abiEncoderV2/abi_encode_v2.sol                                           |        0.052076    |            0.0657159   |            0 |
| abiEncoderV1/abi_encode_calldata_slice.sol                               |       -4.49671     |           -3.6014      |            0 |
| abiEncoderV1/abi_decode_v2_storage.sol                                   |       -0.0805675   |           -0.111765    |            0 |
| abiEncoderV1/struct/struct_storage_ptr.sol                               |       -0.0208812   |           -0.0304665   |            0 |
| viaYul/array_storage_length_access.sol                                   |       -0.310396    |           -0.00146059  |            0 |
| viaYul/array_storage_index_boundary_test.sol                             |       -1.04095     |           -0.0132575   |            0 |
| viaYul/array_memory_index_access.sol                                     |       -8.89162     |           -5.01906     |            0 |
| viaYul/array_storage_index_access.sol                                    |       -0.37952     |           -0.173932    |            0 |
| viaYul/array_storage_push_empty_length_address.sol                       |       -1.21841     |           -0.00207441  |            0 |
| viaYul/array_storage_push_empty.sol                                      |       -0.549191    |           -0.319682    |            0 |
| viaYul/array_storage_push_pop.sol                                        |       -0.851216    |           -0.000251185 |            0 |
| viaYul/simple.sol                                                        |        0           |            0           |            0 |
| viaYul/array_storage_index_zeroed_test.sol                               |       -0.423719    |           -0.117486    |            0 |
| salted_create/salted_create.sol                                          |       -3.45392e-05 |            0           |            0 |
| salted_create/salted_create_with_value.sol                               |        1.12412     |            0.16675     |            0 |
| array/function_array_cross_calls.sol                                     |        1.12646     |           -0.577378    |            0 |
| array/reusing_memory.sol                                                 |       -0.156203    |           -0.0561015   |            0 |
| array/byte_array_transitional_2.sol                                      |       -4.2857      |           -1.63114     |            0 |
| array/bytes_length_member.sol                                            |       -0.00543286  |           -0.00361772  |            0 |
| array/dynamic_multi_array_cleanup.sol                                    |       -0.475173    |            0           |            0 |
| array/byte_array_storage_layout.sol                                      |       -1.77503     |           -0.779716    |            0 |
| array/dynamic_array_cleanup.sol                                          |       -0.0983934   |           -0.0609228   |            0 |
| array/fixed_arrays_as_return_type.sol                                    |        9.03105     |           -2.80047     |            0 |
| array/dynamic_arrays_in_storage.sol                                      |       -0.473052    |           -0.0159336   |            0 |
| array/arrays_complex_from_and_to_storage.sol                             |       -0.121857    |           -0.0799442   |            0 |
| array/fixed_array_cleanup.sol                                            |       -0.0225472   |           -0.0641684   |            0 |
| array/create_memory_array.sol                                            |       -7.19321     |            0           |            0 |
| array/delete/delete_storage_array_packed.sol                             |       -0.161105    |            0           |            0 |
| array/delete/bytes_delete_element.sol                                    |       -2.09969     |           -1.53493     |            0 |
| array/push/nested_bytes_push.sol                                         |       -0.154003    |           -0.0243898   |            0 |
| array/push/array_push_packed_array.sol                                   |       -0.196352    |            0           |            0 |
| array/push/array_push_struct_from_calldata.sol                           |       -0.199856    |           -0.111374    |            0 |
| array/push/array_push_nested_from_calldata.sol                           |       -0.111118    |           -0.0440533   |            0 |
| array/push/byte_array_push_transition.sol                                |       -4.5257      |           -1.78624     |            0 |
| array/push/push_no_args_2d.sol                                           |       -2.01296     |           -0.596245    |            0 |
| array/push/array_push_struct.sol                                         |       -0.171459    |            0           |            0 |
| array/push/push_no_args_bytes.sol                                        |       -3.37637     |           -0.720345    |            0 |
| array/push/array_push.sol                                                |        0.0251597   |            0           |            0 |
| array/copying/array_copy_storage_storage_different_base_nested.sol       |       -0.227292    |            0           |            0 |
| array/copying/array_copy_storage_to_memory_nested.sol                    |       -0.0296762   |            0.0537651   |            0 |
| array/copying/array_copy_storage_storage_static_static.sol               |        0.0313538   |            0           |            0 |
| array/copying/copy_function_storage_array.sol                            |        0.296327    |            0           |            0 |
| array/copying/array_copy_different_packing.sol                           |       -0.00893407  |           -0.0366958   |            0 |
| array/copying/array_copy_storage_storage_static_dynamic.sol              |       -0.00811873  |            0           |            0 |
| array/copying/array_copy_storage_storage_dynamic_dynamic.sol             |       -0.0256593   |            0           |            0 |
| array/copying/array_copy_clear_storage_packed.sol                        |       -0.0893544   |            0           |            0 |
| array/copying/array_copy_target_simple_2.sol                             |       -0.0215311   |           -0.0228714   |            0 |
| array/copying/array_nested_calldata_to_storage.sol                       |       -0.14814     |            0           |            0 |
| array/copying/memory_dyn_2d_bytes_to_storage.sol                         |       -0.885617    |           -0.180113    |            0 |
| array/copying/array_storage_multi_items_per_slot.sol                     |       -0.212702    |            0           |            0 |
| array/copying/array_nested_memory_to_storage.sol                         |       -0.0512471   |           -0.0100019   |            0 |
| array/copying/array_copy_including_array.sol                             |       -0.19193     |           -0.00124288  |            0 |
| array/copying/array_copy_target_simple.sol                               |       -0.0630598   |           -0.0268213   |            0 |
| array/copying/array_copy_cleanup_uint128.sol                             |       -0.114171    |            0           |            0 |
| array/copying/array_copy_storage_storage_static_simple.sol               |        0           |           -0.0336757   |            0 |
| array/copying/copy_byte_array_in_struct_to_storage.sol                   |       -0.00522111  |           -0.00974449  |            0 |
| array/copying/array_copy_target_leftover.sol                             |       -2.25677     |           -1.6957      |            0 |
| array/copying/calldata_array_dynamic_to_storage.sol                      |       -0.0386677   |           -0.0449047   |            0 |
| array/copying/array_copy_storage_storage_struct.sol                      |       -0.128798    |            0           |            0 |
| array/copying/bytes_inside_mappings.sol                                  |        0.015608    |           -0.0104021   |            0 |
| array/copying/array_of_struct_memory_to_storage.sol                      |       -0.0436238   |            0           |            0 |
| array/copying/copy_byte_array_to_storage.sol                             |       -0.241275    |           -0.032395    |            0 |
| array/copying/array_copy_calldata_storage.sol                            |       -0.040862    |           -0.0102304   |            0 |
| array/copying/copy_removes_bytes_data.sol                                |        0.0118379   |           -0.00225357  |            0 |
| array/copying/array_copy_target_leftover2.sol                            |        0.0127857   |           -0.0955414   |            0 |
| array/copying/array_copy_nested_array.sol                                |       -0.0435912   |           -0.00729195  |            0 |
| array/copying/array_of_struct_calldata_to_storage.sol                    |       -0.0759113   |            0           |            0 |
| array/copying/storage_memory_nested.sol                                  |        0.0647249   |           -0.0170224   |            0 |
| array/copying/storage_memory_packed_dyn.sol                              |       -0.638049    |           -0.245654    |            0 |
| array/copying/array_of_structs_containing_arrays_memory_to_storage.sol   |        0.0185376   |            0           |            0 |
| array/copying/array_copy_storage_storage_dyn_dyn.sol                     |       -0.0547149   |            0           |            0 |
| array/copying/storage_memory_nested_bytes.sol                            |        0.0152898   |            0.0442397   |            0 |
| array/copying/storage_memory_nested_struct.sol                           |        0.0685112   |            0           |            0 |
| array/copying/array_copy_storage_storage_different_base.sol              |       -0.0725247   |            0           |            0 |
| array/copying/array_copy_clear_storage.sol                               |       -0.0347775   |            0           |            0 |
| array/copying/array_of_structs_containing_arrays_calldata_to_storage.sol |       -0.526055    |            0           |            0 |
| array/copying/storage_memory_nested_from_pointer.sol                     |        0.0647249   |           -0.017022    |            0 |
| array/copying/arrays_from_and_to_storage.sol                             |       -0.0559631   |           -0.228315    |            0 |
| array/copying/bytes_storage_to_storage.sol                               |       -3.12147     |           -1.5887      |            0 |
| array/copying/array_copy_cleanup_uint40.sol                              |       -0.433322    |            0           |            0 |
| array/pop/array_pop_uint24_transition.sol                                |       -1.19798     |           -0.246606    |            0 |
| array/pop/byte_array_pop_masking_long.sol                                |       -0.751047    |           -0.399153    |            0 |
| array/pop/array_pop_uint16_transition.sol                                |       -1.91033     |           -0.337116    |            0 |
| array/pop/byte_array_pop_copy_long.sol                                   |       -1.48799     |           -0.411645    |            0 |
| array/pop/byte_array_pop_long_storage_empty_garbage_ref.sol              |       -2.60362     |           -1.19915     |            0 |
| array/pop/byte_array_pop_long_storage_empty.sol                          |       -4.24304     |           -2.26437     |            0 |
| array/pop/array_pop_array_transition.sol                                 |       -0.0401779   |           -0.0266532   |            0 |
| immutable/multi_creation.sol                                             |       -0.016456    |           -0.0175408   |            0 |
| structs/struct_copy_via_local.sol                                        |        0.0381319   |            0           |            0 |
| structs/struct_delete_storage_nested_small.sol                           |       -0.121549    |            0           |            0 |
| structs/struct_delete_storage_with_array.sol                             |       -0.0706632   |            0           |            0 |
| structs/structs.sol                                                      |       -0.0401819   |            0           |            0 |
| structs/memory_structs_nested_load.sol                                   |        0.00449745  |            0           |            0 |
| structs/struct_copy.sol                                                  |        0.013993    |           -0.0118096   |            0 |
| structs/struct_delete_storage_with_arrays_small.sol                      |       -0.235378    |            0           |            0 |
| structs/struct_containing_bytes_copy_and_delete.sol                      |       -0.0500676   |           -0.0507921   |            0 |
| structs/struct_memory_to_storage_function_ptr.sol                        |        0.33818     |            0           |            0 |
| structs/conversion/recursive_storage_memory.sol                          |       -0.977563    |            0           |            0 |
| structs/calldata/calldata_struct_with_nested_array_to_storage.sol        |       -0.155118    |           -0.111502    |            0 |
| various/staticcall_for_view_and_pure.sol                                 |       -3.04758e-06 |            0           |            0 |
| various/erc20.sol                                                        |       -3.51847     |           -2.52977     |            0 |
| various/destructuring_assignment.sol                                     |        0.144798    |           -0.0262848   |            0 |
| various/swap_in_storage_overwrite.sol                                    |       -0.000911295 |            0           |            0 |
| various/skip_dynamic_types_for_structs.sol                               |       -0.00447047  |           -0.0423141   |            0 |
| various/negative_stack_height.sol                                        |        0           |            0           |            0 |
</details>

Still generally quite favourable, but there are a few freak cases, partly, I think, because the memoryguard prevents memory memory optimizations.

Additionally removing the artificial bounds for the ``FullInliner`` (not in the PR) gives the following:

<details><summary>Click for a table of gas differences</summary>

| File name                                                                |   IR-optimized (%) |   Legacy-Optimized (%) |   Legacy (%) |
|--------------------------------------------------------------------------|--------------------|------------------------|--------------|
| interface_inheritance_conversions.sol                                    |       -4.21527     |            0           |            0 |
| events/event_indexed_string.sol                                          |       -5.15593     |           -1.06616     |            0 |
| events/event_indexed_mixed.sol                                           |        0.10133     |           -0.03789     |            0 |
| events/event_dynamic_nested_array_storage_v2.sol                         |       -1.15701     |            0.0260091   |            0 |
| events/event_dynamic_array_storage_v2.sol                                |       -1.02599     |           -0.0262203   |            0 |
| events/event_dynamic_array_storage.sol                                   |       -1.02599     |           -0.0262203   |            0 |
| functionCall/failed_create.sol                                           |       -4.35332     |           -1.52575     |            0 |
| functionCall/mapping_array_internal_argument.sol                         |       -0.192823    |           -0.0724631   |            0 |
| externalContracts/snark.sol                                              |      -15.5184      |           -1.96128     |            0 |
| externalContracts/ramanujan_pi.sol                                       |       -8.72195     |            0.218404    |            0 |
| externalContracts/prbmath_unsigned.sol                                   |       -0.268189    |           -0.256389    |            0 |
| externalContracts/deposit_contract.sol                                   |       -7.24927     |           -1.58575     |            0 |
| externalContracts/prbmath_signed.sol                                     |       -1.52774     |           -0.148987    |            0 |
| externalContracts/FixedFeeRegistrar.sol                                  |       -7.47971     |           -2.48255     |            0 |
| externalContracts/strings.sol                                            |      -16.253       |           -5.35392     |            0 |
| constructor/arrays_in_constructors.sol                                   |       -3.81893     |           -0.387807    |            0 |
| constructor/no_callvalue_check.sol                                       |       -0.0454952   |            0           |            0 |
| constructor/bytes_in_constructors_packer.sol                             |       -6.35122     |           -0.0348544   |            0 |
| abiencodedecode/abi_decode_simple_storage.sol                            |       -0.159564    |           -0.100675    |            0 |
| inlineAssembly/keccak_yul_optimization.sol                               |       -0.266098    |            0           |            0 |
| inheritance/inherited_function_calldata_calldata_interface.sol           |       -4.69461     |            0           |            0 |
| inheritance/address_overload_resolution.sol                              |       -2.3138      |            0           |            0 |
| inheritance/inherited_function_calldata_memory_interface.sol             |        0.366317    |            1.47739     |            0 |
| functionTypes/store_function.sol                                         |       -0.112117    |           -0.7795      |            0 |
| storage/packed_storage_structs_bytes.sol                                 |       -1.27348     |            0           |            0 |
| abiEncoderV2/abi_encode_calldata_slice.sol                               |       -4.58098     |           -3.6014      |            0 |
| abiEncoderV2/storage_array_encoding.sol                                  |       -0.126638    |           -0.069951    |            0 |
| abiEncoderV2/abi_encode_v2_in_modifier_used_in_v1_contract.sol           |       -0.880703    |            0           |            0 |
| abiEncoderV2/abi_encode_v2_in_function_inherited_in_v1_contract.sol      |        0.631656    |           -0.592431    |            0 |
| abiEncoderV2/calldata_array.sol                                          |      -28.9041      |           -2.29579     |            0 |
| abiEncoderV2/abi_encode_v2.sol                                           |       -0.300099    |            0.0657159   |            0 |
| abiEncoderV1/abi_encode_calldata_slice.sol                               |       -4.58098     |           -3.6014      |            0 |
| abiEncoderV1/abi_decode_v2_storage.sol                                   |       -0.191102    |           -0.13589     |            0 |
| abiEncoderV1/struct/struct_storage_ptr.sol                               |       -0.556036    |           -0.0304665   |            0 |
| viaYul/array_storage_length_access.sol                                   |       -0.310851    |           -0.00146059  |            0 |
| viaYul/array_storage_index_boundary_test.sol                             |       -1.94516     |           -0.0132575   |            0 |
| viaYul/array_memory_index_access.sol                                     |       -9.093       |           -5.01906     |            0 |
| viaYul/array_storage_index_access.sol                                    |       -2.25673     |           -0.173932    |            0 |
| viaYul/array_storage_push_empty_length_address.sol                       |       -1.21885     |           -0.00207441  |            0 |
| viaYul/array_storage_push_empty.sol                                      |      -10.7576      |           -0.319682    |            0 |
| viaYul/array_storage_push_pop.sol                                        |       -0.851216    |           -0.000251185 |            0 |
| viaYul/simple.sol                                                        |        0           |            0           |            0 |
| viaYul/array_storage_index_zeroed_test.sol                               |       -2.3886      |           -0.117486    |            0 |
| salted_create/salted_create.sol                                          |       -3.45392e-05 |            0           |            0 |
| salted_create/salted_create_with_value.sol                               |        0.866589    |            0.16675     |            0 |
| array/function_array_cross_calls.sol                                     |       -3.30105     |           -1.43535     |            0 |
| array/reusing_memory.sol                                                 |       -0.308019    |           -0.0561015   |            0 |
| array/byte_array_transitional_2.sol                                      |       -4.74084     |           -1.63114     |            0 |
| array/bytes_length_member.sol                                            |       -0.0335027   |           -0.00361772  |            0 |
| array/dynamic_multi_array_cleanup.sol                                    |       -5.33412     |            0           |            0 |
| array/byte_array_storage_layout.sol                                      |       -0.858317    |           -0.779716    |            0 |
| array/dynamic_array_cleanup.sol                                          |       -0.109732    |           -0.0609228   |            0 |
| array/fixed_arrays_as_return_type.sol                                    |        2.01755     |           -2.96551     |            0 |
| array/dynamic_arrays_in_storage.sol                                      |       -0.932752    |           -0.0159336   |            0 |
| array/arrays_complex_from_and_to_storage.sol                             |       -0.275892    |           -0.179269    |            0 |
| array/fixed_array_cleanup.sol                                            |       -0.0334987   |           -0.0641684   |            0 |
| array/create_memory_array.sol                                            |      -11.359       |            0           |            0 |
| array/delete/delete_storage_array_packed.sol                             |       -1.34364     |            0           |            0 |
| array/delete/bytes_delete_element.sol                                    |       -9.88698     |           -1.53493     |            0 |
| array/push/nested_bytes_push.sol                                         |       -0.400296    |           -0.0243898   |            0 |
| array/push/array_push_packed_array.sol                                   |       -1.88841     |            0           |            0 |
| array/push/array_push_struct_from_calldata.sol                           |       -0.635514    |           -0.138678    |            0 |
| array/push/array_push_nested_from_calldata.sol                           |       -1.1297      |           -0.0440533   |            0 |
| array/push/byte_array_push_transition.sol                                |       -6.44924     |           -1.78624     |            0 |
| array/push/push_no_args_2d.sol                                           |       -2.06174     |           -0.596245    |            0 |
| array/push/array_push_struct.sol                                         |       -0.483004    |            0           |            0 |
| array/push/push_no_args_bytes.sol                                        |       -4.01486     |           -0.720345    |            0 |
| array/push/array_push.sol                                                |       -0.392671    |            0           |            0 |
| array/copying/array_copy_storage_storage_different_base_nested.sol       |       -0.658308    |            0           |            0 |
| array/copying/array_copy_storage_to_memory_nested.sol                    |       -0.635564    |            0.0537651   |            0 |
| array/copying/array_copy_storage_storage_static_static.sol               |        0.0300827   |            0           |            0 |
| array/copying/copy_function_storage_array.sol                            |       -0.461129    |            0           |            0 |
| array/copying/array_copy_different_packing.sol                           |       -1.58086     |           -0.0366958   |            0 |
| array/copying/array_copy_storage_storage_static_dynamic.sol              |       -0.0162375   |            0           |            0 |
| array/copying/array_copy_storage_storage_dynamic_dynamic.sol             |       -0.286651    |            0           |            0 |
| array/copying/array_copy_clear_storage_packed.sol                        |       -1.45443     |            0           |            0 |
| array/copying/array_copy_target_simple_2.sol                             |       -0.30472     |           -0.0228714   |            0 |
| array/copying/array_nested_calldata_to_storage.sol                       |       -0.561192    |            0           |            0 |
| array/copying/memory_dyn_2d_bytes_to_storage.sol                         |       -7.32141     |           -0.180113    |            0 |
| array/copying/array_storage_multi_items_per_slot.sol                     |       -0.488007    |            0           |            0 |
| array/copying/array_nested_memory_to_storage.sol                         |       -0.652916    |           -0.0100019   |            0 |
| array/copying/array_copy_including_array.sol                             |       -0.227285    |           -0.00124288  |            0 |
| array/copying/array_copy_target_simple.sol                               |       -0.449895    |           -0.0268213   |            0 |
| array/copying/array_copy_cleanup_uint128.sol                             |       -1.45407     |            0           |            0 |
| array/copying/array_copy_storage_storage_static_simple.sol               |        0           |           -0.0336757   |            0 |
| array/copying/copy_byte_array_in_struct_to_storage.sol                   |       -0.0692668   |           -0.00974449  |            0 |
| array/copying/array_copy_target_leftover.sol                             |       -5.35406     |           -2.3422      |            0 |
| array/copying/calldata_array_dynamic_to_storage.sol                      |       -0.149275    |           -0.0449047   |            0 |
| array/copying/array_copy_storage_storage_struct.sol                      |       -0.204906    |            0           |            0 |
| array/copying/bytes_inside_mappings.sol                                  |       -0.0721438   |           -0.0104021   |            0 |
| array/copying/array_of_struct_memory_to_storage.sol                      |       -0.64429     |            0           |            0 |
| array/copying/copy_byte_array_to_storage.sol                             |       -1.25496     |           -0.032395    |            0 |
| array/copying/array_copy_calldata_storage.sol                            |       -0.0227353   |           -0.0102304   |            0 |
| array/copying/copy_removes_bytes_data.sol                                |       -0.0050734   |           -0.00225357  |            0 |
| array/copying/array_copy_target_leftover2.sol                            |       -2.07341     |           -0.0955414   |            0 |
| array/copying/array_copy_nested_array.sol                                |       -0.241996    |           -0.00729195  |            0 |
| array/copying/array_of_struct_calldata_to_storage.sol                    |       -0.610591    |            0           |            0 |
| array/copying/storage_memory_nested.sol                                  |       -0.642902    |           -0.0170224   |            0 |
| array/copying/storage_memory_packed_dyn.sol                              |       -3.50272     |           -0.245654    |            0 |
| array/copying/array_of_structs_containing_arrays_memory_to_storage.sol   |       -0.625917    |            0           |            0 |
| array/copying/array_copy_storage_storage_dyn_dyn.sol                     |       -0.0977692   |            0           |            0 |
| array/copying/storage_memory_nested_bytes.sol                            |        0.00986436  |            0.0442397   |            0 |
| array/copying/storage_memory_nested_struct.sol                           |       -0.339816    |            0           |            0 |
| array/copying/array_copy_storage_storage_different_base.sol              |       -0.483793    |            0           |            0 |
| array/copying/array_copy_clear_storage.sol                               |       -0.508343    |            0           |            0 |
| array/copying/array_of_structs_containing_arrays_calldata_to_storage.sol |       -2.88089     |            0           |            0 |
| array/copying/storage_memory_nested_from_pointer.sol                     |       -0.642902    |           -0.017022    |            0 |
| array/copying/arrays_from_and_to_storage.sol                             |       -0.748506    |           -0.64558     |            0 |
| array/copying/bytes_storage_to_storage.sol                               |      -14.955       |           -1.5887      |            0 |
| array/copying/array_copy_cleanup_uint40.sol                              |       -4.55671     |            0           |            0 |
| array/pop/array_pop_uint24_transition.sol                                |       -1.81124     |           -0.246606    |            0 |
| array/pop/byte_array_pop_masking_long.sol                                |       -1.02274     |           -0.399153    |            0 |
| array/pop/array_pop_uint16_transition.sol                                |       -2.84781     |           -0.337116    |            0 |
| array/pop/byte_array_pop_copy_long.sol                                   |       -1.07865     |           -0.411645    |            0 |
| array/pop/byte_array_pop_long_storage_empty_garbage_ref.sol              |       -2.65415     |           -1.19915     |            0 |
| array/pop/byte_array_pop_long_storage_empty.sol                          |      -11.593       |           -2.26437     |            0 |
| array/pop/array_pop_array_transition.sol                                 |       -0.232486    |           -0.0266532   |            0 |
| immutable/multi_creation.sol                                             |       -0.105005    |           -0.0175408   |            0 |
| structs/struct_copy_via_local.sol                                        |       -0.380411    |            0           |            0 |
| structs/struct_delete_storage_nested_small.sol                           |       -0.192098    |            0           |            0 |
| structs/struct_delete_storage_with_array.sol                             |       -0.446986    |            0           |            0 |
| structs/structs.sol                                                      |        0.0662257   |            0           |            0 |
| structs/memory_structs_nested_load.sol                                   |       -0.742979    |            0           |            0 |
| structs/struct_copy.sol                                                  |        0.0104947   |           -0.0118096   |            0 |
| structs/struct_delete_storage_with_arrays_small.sol                      |       -0.475214    |            0           |            0 |
| structs/struct_containing_bytes_copy_and_delete.sol                      |       -0.141983    |           -0.0507921   |            0 |
| structs/struct_memory_to_storage_function_ptr.sol                        |        0.1284      |            0           |            0 |
| structs/conversion/recursive_storage_memory.sol                          |       -0.941167    |            0           |            0 |
| structs/calldata/calldata_struct_with_nested_array_to_storage.sol        |       -0.71472     |           -0.215146    |            0 |
| various/staticcall_for_view_and_pure.sol                                 |       -3.04758e-06 |            0           |            0 |
| various/erc20.sol                                                        |      -11.6867      |           -2.52977     |            0 |
| various/destructuring_assignment.sol                                     |       -0.822189    |           -0.0262848   |            0 |
| various/swap_in_storage_overwrite.sol                                    |       -0.0364518   |            0           |            0 |
| various/skip_dynamic_types_for_structs.sol                               |       -0.105056    |           -0.0423141   |            0 |
| various/negative_stack_height.sol                                        |        0           |            0           |            0 |
</details>
which has significant improvements and almost no regressions.

#### <img src="https://avatars.githubusercontent.com/u/2388185?v=4" width="50">[bshastry](https://github.com/bshastry) commented at [2021-08-24 09:08](https://github.com/ethereum/solidity/pull/11493#issuecomment-904464775):

The fuzzer found ~~two~~three test cases so far (see gists below per test case) that didn't throw StackTooDeep with old code transform + optimizer but throw with new code transform + optimizer (this PR)

1. https://gist.github.com/bshastry/2775a93fca515a6c0b82f820f02537ea
2. https://gist.github.com/bshastry/13e745bae64bf5b98be5611700153c6a
3. https://gist.github.com/bshastry/6fded19eba60fa17292f3df7aeb3e7b0


Edit: Summarized earlier comment

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) commented at [2021-09-01 10:40](https://github.com/ethereum/solidity/pull/11493#issuecomment-910158837):

The last rebase including this change https://github.com/ethereum/solidity/pull/11615#issuecomment-910144902 should have fixed those fuzzer cases (https://github.com/ethereum/solidity/pull/11815 is also rebased).

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) commented at [2022-02-14 18:48](https://github.com/ethereum/solidity/pull/11493#issuecomment-1039431987):

I'm not entirely sure if we still plan on doing this by the way... if we want, it'd be nice to at least keep the branch alive...

#### <img src="https://avatars.githubusercontent.com/u/9073706?v=4" width="50">[chriseth](https://github.com/chriseth) commented at [2022-02-15 08:24](https://github.com/ethereum/solidity/pull/11493#issuecomment-1039989360):

What does it do (the hackmd does not have a "step 4") and what is still needed here?

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) commented at [2022-02-15 12:30](https://github.com/ethereum/solidity/pull/11493#issuecomment-1040216369):

> What does it do (the hackmd does not have a "step 4") and what is still needed here?

This PR here enabled the new EVM code transform for the Yul parts of old code generation, in particular for ABI decoding. ~~Which involves special assembly items for the free memory pointer to allow stack-to-memory during abi encoding and all that...~~ EDIT: Actually not that - I did change it to only store the index into the assembly items to later replace the initial free memory pointer value.

So the main question is: do we want to bother with all that - then I can rebase this and clean it up next month - or do we instead just want to push towards moving to new codegen anyways, then we can close this.

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) commented at [2022-04-04 15:40](https://github.com/ethereum/solidity/pull/11493#issuecomment-1087715302):

I don't see this being merged any time soon, so I'll close it.


-------------------------------------------------------------------------------



[Export of Github issue for [ethereum/solidity](https://github.com/ethereum/solidity). Generated on 2024.12.15 at 06:45:24.]
