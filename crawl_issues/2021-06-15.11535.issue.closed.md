# [\#11535 Issue](https://github.com/ethereum/solidity/issues/11535) `closed`: Legacy and Sol->Yul divergence in program containing multiple calls to ripemd precompile and abi.encode

#### <img src="https://avatars.githubusercontent.com/u/2388185?v=4" width="50">[bshastry](https://github.com/bshastry) opened issue at [2021-06-15 09:59](https://github.com/ethereum/solidity/issues/11535):

```
pragma solidity >= 0.0.0;
contract C {
  function f() external returns (bytes20) {
    return ripemd160("4") ^ ripemd160(abi.encode());
  }
}
// ====
// compileViaYul: also
// ----
// f() -> FAILURE
// gas legacy: 98437883
```

When EVM bytecode generated by the legacy code gen is run on EVMHost, the following calls are made (i.e., two calls to ripemd precompile located at address `0x00...03`)

The same for via Sol->Yul results in a *single* call to the precompile.

However, both legacy and Sol->Yul calls result in a failure. This can be confirmed via isoltest using the test case.

#### <img src="https://avatars.githubusercontent.com/u/2388185?v=4" width="50">[bshastry](https://github.com/bshastry) commented at [2021-06-15 10:53](https://github.com/ethereum/solidity/issues/11535#issuecomment-861398566):

Closing this bug. Thanks to @hrkrshnn and @ekpyron for unearthing the root cause. I will leave a summary here before closing the issue as a duplicate of https://github.com/ethereum/solidity/issues/11414

Legacy code generator evaluates expressions right-to-left. This means the `ripemd160(abi.encode())` call is evaluated first. Since `abi.encode()` is zero and `ripemd160` has a partial implementation for zero bytes here 

https://github.com/ethereum/solidity/blob/b2ffa91058a4f54fd308964f3da638693081aa5c/test/EVMHost.cpp#L418-L419

it is successfully executed. However, since `ripemd160("4")` is not implemented. See

https://github.com/ethereum/evmc/blob/17fd712701502ffe0588df34f006a7ef3d2f954e/examples/example_precompiles_vm/example_precompiles_vm.cpp#L79-L80

EVMHost reverts. In the end, two calls to the `ripemd160` precompile are made.

The new code gen evaluates expressions in the opposite order. Therefore, the first call to the `ripemd160` precompile reverts. In the end, both the old and new code gens provide the same output. See

https://github.com/ethereum/evmc/blob/17fd712701502ffe0588df34f006a7ef3d2f954e/examples/example_precompiles_vm/example_precompiles_vm.cpp#L45-L47

but make different number of calls.


-------------------------------------------------------------------------------



[Export of Github issue for [ethereum/solidity](https://github.com/ethereum/solidity). Generated on 2024.12.15 at 06:45:24.]
