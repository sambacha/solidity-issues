# [\#14167 PR](https://github.com/ethereum/solidity/pull/14167) `open`: Add native support of EIP-712 struct typehash
**Labels**: `external contribution :star:`


#### <img src="https://avatars.githubusercontent.com/u/702124?u=00e20e1963ccc9a908a5826b2d8c3b1b1f6acea4&v=4" width="50">[k06a](https://github.com/k06a) opened issue at [2023-04-28 09:09](https://github.com/ethereum/solidity/pull/14167):

First attempt to implement this: https://github.com/ethereum/solidity/issues/14157

#### <img src="https://avatars.githubusercontent.com/in/15368?v=4" width="50">[github-actions](https://github.com/apps/github-actions) commented at [2023-04-28 09:09](https://github.com/ethereum/solidity/pull/14167#issuecomment-1527240550):

Thank you for your contribution to the Solidity compiler! A team member will follow up shortly.

If you haven't read our [contributing guidelines](https://docs.soliditylang.org/en/latest/contributing.html) and our [review checklist](https://github.com/ethereum/solidity/blob/develop/ReviewChecklist.md) before, please do it now, this makes the reviewing process and accepting your contribution smoother.

If you have any questions or need our help, feel free to post them in the PR or talk to us directly on the [#solidity-dev](https://matrix.to/#/#ethereum_solidity-dev:gitter.im) channel on Matrix.

#### <img src="https://avatars.githubusercontent.com/u/702124?u=00e20e1963ccc9a908a5826b2d8c3b1b1f6acea4&v=4" width="50">[k06a](https://github.com/k06a) commented at [2023-05-07 19:02](https://github.com/ethereum/solidity/pull/14167#issuecomment-1537518308):

@Saw-mon-and-Natalie @hrkrshnn I see some CI items failed, do you think merging latest `develop` branch back to the branch would help with that?

#### <img src="https://avatars.githubusercontent.com/u/702124?u=00e20e1963ccc9a908a5826b2d8c3b1b1f6acea4&v=4" width="50">[k06a](https://github.com/k06a) commented at [2023-05-07 19:04](https://github.com/ethereum/solidity/pull/14167#issuecomment-1537518808):

One more important question is how to handle this case:
```
contract C1 {
    struct S1 {
        uint256 x;
    }
}

contract C2 {
    struct S1 {
        uint256 x;
    }
    struct S2 {
        S1 one;
        C1.S1 two;
    }
}
```

#### <img src="https://avatars.githubusercontent.com/u/13174375?u=52d702cb6bec53b561afa293cf9cd53ef7a63924&v=4" width="50">[hrkrshnn](https://github.com/hrkrshnn) commented at [2023-05-07 21:19](https://github.com/ethereum/solidity/pull/14167#issuecomment-1537542980):

> I see some CI items failed, do you think merging latest develop branch back to the branch would help with that?

Please rebase against develop (instead of merging). I think that should fix the CI.

Also if you can write some `semanticTests`, that would be great! Here's an example https://github.com/ethereum/solidity/pull/8872/files#diff-2472d3c9a13ad5ca3c7f6069c856f5b2b9f10fd10cd185f56f7146a1f719772c That PR is similar (implemented `type(...).min` or `max`), so should give you an idea of what's needed.

This is already looking quite good, especially that you even implemented the SMTChecker encoding and some tests (though they are failing, aren't they?).

#### <img src="https://avatars.githubusercontent.com/u/702124?u=00e20e1963ccc9a908a5826b2d8c3b1b1f6acea4&v=4" width="50">[k06a](https://github.com/k06a) commented at [2023-05-08 14:38](https://github.com/ethereum/solidity/pull/14167#issuecomment-1538471233):

@hrkrshnn rebasing helped with the failing CI items. Could you elaborate what is semantic tests how is it different from tests I already wrote. Not sure what this means, but probably they are failing now. Will try to run it locally to investigate bugs.

#### <img src="https://avatars.githubusercontent.com/u/702124?u=00e20e1963ccc9a908a5826b2d8c3b1b1f6acea4&v=4" width="50">[k06a](https://github.com/k06a) commented at [2023-05-09 10:47](https://github.com/ethereum/solidity/pull/14167#issuecomment-1539943768):

@hrkrshnn it seems this one is not correct:
> 7. A test for a type(S).typehash where S is recursive, for example struct S { S[] s; }. This should be an error.

As stated in EIP-712: https://eips.ethereum.org/EIPS/eip-712#definition-of-typed-structured-data-ð•Š:
> **Definition:** The _reference_ types are arrays and structs. Arrays are either fixed size or dynamic and denoted by `Type[n]` or `Type[]` respectively. Structs are references to other structs by their name. The standard supports recursive struct types.

#### <img src="https://avatars.githubusercontent.com/u/13174375?u=52d702cb6bec53b561afa293cf9cd53ef7a63924&v=4" width="50">[hrkrshnn](https://github.com/hrkrshnn) commented at [2023-05-10 10:31](https://github.com/ethereum/solidity/pull/14167#issuecomment-1541893086):

@k06a That's a good point on the recursive structs. In that case, the spec is closer to 'structs living in memory'. Which makes things really complicated. 

The typehash may be well-defined, but allowing non-ABI types can make the final EIP-712 hash to be ill-defined. The encoding of elements in memory is not standardized, even in the compiler, there are deviations between how internal function pointers are encoded between the legacy and the new codegen.

I think this is probably an issue with the spec. Is there a known example of recursive structs being used in EIP-712 or an implementation in ethers.js or similar library that supports it? @k06a Can you try asking Remco or other authors on the reasoning behind including recursive structs?

(I haven't checked properly why recursive structs are disallowed as arguments in function calls or in `abi.encode(...)`, and whether it's truly undefined in the ABI, but Daniel seems to agree that it's not well-defined in the ABI)

#### <img src="https://avatars.githubusercontent.com/u/3140080?u=2f731a1aa6e7b2a1fdeafc89a287cd804bcc781f&v=4" width="50">[Saw-mon-and-Natalie](https://github.com/Saw-mon-and-Natalie) commented at [2023-05-16 00:33](https://github.com/ethereum/solidity/pull/14167#issuecomment-1548797129):

For differential testing:
1. [`ethers-rs`](https://github.com/gakonst/ethers-rs/blob/master/ethers-contract/ethers-contract-derive/src/eip712.rs#L171-L189) does not implement the `EIP-712` fully ( https://github.com/gakonst/ethers-rs/issues/495 ).
2. [`ethers.js`](https://github.com/ethers-io/ethers.js/blob/13593809bd61ef24c01d79de82563540d77098db/src.ts/hash/typed-data.ts)

#### <img src="https://avatars.githubusercontent.com/u/3140080?u=2f731a1aa6e7b2a1fdeafc89a287cd804bcc781f&v=4" width="50">[Saw-mon-and-Natalie](https://github.com/Saw-mon-and-Natalie) commented at [2023-05-16 04:17](https://github.com/ethereum/solidity/pull/14167#issuecomment-1548964295):

So for:

```solidity
contract C {
  struct S {
    uint256 x;
  }

  function f() public pure {
    assert(type(S).typehash == keccak256("S(uint256 x)"));
  }
}
// ====
// SMTEngine: chc
// ----
```

We still get:

```bash
Warning 6328: (84-137): CHC: Assertion violation happens here.
```

debugging the following [line](https://github.com/ethereum/solidity/blob/f8d1437206bbd16f006fafab207c85460bdb6a50/libsolidity/formal/CHC.cpp#L1822):

```c++
// libsolidity/formal/CHC.cpp#L1822
tie(resultNoOpt, invariantNoOpt, cexNoOpt) = m_interface->query(_query);
```

<details>
<summary><code>cexNoOpt</code> (counter example no-optimization)</summary>

```python
(let ((a!1 (forall ((A abi_type)
                    (B crypto_type)
                    (C state_type)
                    (D state_type)
                    (E Int)
                    (F tx_type))
             (! (=> (and (summary_4_function_f__57_58_0 1 E A B F C D)
                         (interface_0_C_58_0 E A B C))
                    error_target_3_0)
                :weight 0)))
      (a!2 (asserted (forall ((A abi_type)
                              (B crypto_type)
                              (C Int)
                              (D Int)
                              (E state_type)
                              (F state_type)
                              (G state_type)
                              (H Int)
                              (I tx_type))
                       (! (let ((a!1 (= (select (bytes_tuple_accessor_array
                                                  (msg.data I))
                                                2)
                                        31))
                                (a!2 (= (select (bytes_tuple_accessor_array
                                                  (msg.data I))
                                                3)
                                        240))
                                (a!3 (= (select (bytes_tuple_accessor_array
                                                  (msg.data I))
                                                1)
                                        18))
                                (a!4 (= (select (bytes_tuple_accessor_array
                                                  (msg.data I))
                                                0)
                                        38))
                                (a!5 (>= (+ (select (balances E) H) D) 0))
                                (a!6 (<= (+ (select (balances E) H) D)
                                         115792089237316195423570985008687907853269984665640564039457584007913129639935))
                                (a!7 (store (balances E)
                                            H
                                            (+ (select (balances E) H) D))))
                          (let ((a!8 (and (summary_3_function_f__57_58_0
                                            C
                                            H
                                            A
                                            B
                                            I
                                            F
                                            G)
                                          (= (msg.value I) 0)
                                          (= (msg.sig I) 638722032)
                                          a!1
                                          a!2
                                          a!3
                                          a!4
                                          (>= (tx.origin I) 0)
                                          (>= (tx.gasprice I) 0)
                                          (>= (msg.value I) 0)
                                          (>= (msg.sender I) 0)
                                          (>= (block.prevrandao I) 0)
                                          (>= (block.timestamp I) 0)
                                          (>= (block.number I) 0)
                                          (>= (block.gaslimit I) 0)
                                          (>= (block.coinbase I) 0)
                                          (>= (block.chainid I) 0)
                                          (>= (block.basefee I) 0)
                                          (>= (bytes_tuple_accessor_length
                                                (msg.data I))
                                              4)
                                          a!5
                                          (>= D (msg.value I))
                                          (<= (tx.origin I)
                                              1461501637330902918203684832716283019655932542975)
                                          (<= (tx.gasprice I)
                                              115792089237316195423570985008687907853269984665640564039457584007913129639935)
                                          (<= (msg.value I)
                                              115792089237316195423570985008687907853269984665640564039457584007913129639935)
                                          (<= (msg.sender I)
                                              1461501637330902918203684832716283019655932542975)
                                          (not (<= (block.prevrandao I)
                                                   18446744073709551616))
                                          (<= (block.prevrandao I)
                                              115792089237316195423570985008687907853269984665640564039457584007913129639935)
                                          (<= (block.timestamp I)
                                              115792089237316195423570985008687907853269984665640564039457584007913129639935)
                                          (<= (block.number I)
                                              115792089237316195423570985008687907853269984665640564039457584007913129639935)
                                          (<= (block.gaslimit I)
                                              115792089237316195423570985008687907853269984665640564039457584007913129639935)
                                          (<= (block.coinbase I)
                                              1461501637330902918203684832716283019655932542975)
                                          (<= (block.chainid I)
                                              115792089237316195423570985008687907853269984665640564039457584007913129639935)
                                          (<= (block.basefee I)
                                              115792089237316195423570985008687907853269984665640564039457584007913129639935)
                                          a!6
                                          (= F (state_type a!7)))))
                            (=> a!8
                                (summary_4_function_f__57_58_0 C H A B I E G))))
                          :weight 0))))
      (a!3 (asserted (forall ((A abi_type)
                              (B crypto_type)
                              (C Int)
                              (D state_type)
                              (E state_type)
                              (F Int)
                              (G tx_type))
                       (! (=> (block_8_function_f__57_58_0 C F A B G D E)
                              (summary_3_function_f__57_58_0 C F A B G D E))
                          :weight 0))))
      (a!4 (asserted (forall ((A abi_type)
                              (B crypto_type)
                              (C Int)
                              (D bytes_tuple)
                              (E Int)
                              (F state_type)
                              (G state_type)
                              (H Int)
                              (I tx_type))
                       (! (let ((a!1 (and (block_6_f_56_58_0 C H A B I F G)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     2)
                                             40)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     3)
                                             117)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     4)
                                             105)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     5)
                                             110)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     6)
                                             116)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     7)
                                             50)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     8)
                                             53)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     9)
                                             54)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     10)
                                             32)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     11)
                                             120)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     12)
                                             44)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     13)
                                             105)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     14)
                                             110)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     15)
                                             116)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     16)
                                             49)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     17)
                                             50)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     18)
                                             56)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     19)
                                             32)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     20)
                                             121)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     21)
                                             44)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     22)
                                             98)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     23)
                                             111)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     24)
                                             111)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     25)
                                             108)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     26)
                                             32)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     27)
                                             122)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     28)
                                             44)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     29)
                                             98)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     30)
                                             121)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     31)
                                             116)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     33)
                                             115)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     34)
                                             91)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     35)
                                             51)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     36)
                                             93)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     37)
                                             91)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     38)
                                             50)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     39)
                                             57)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     42)
                                             93)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     43)
                                             91)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     45)
                                             93)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     46)
                                             32)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     47)
                                             119)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     48)
                                             44)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     49)
                                             83)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     52)
                                             41)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     53)
                                             83)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     54)
                                             40)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     55)
                                             83)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     56)
                                             50)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     57)
                                             32)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     58)
                                             97)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     59)
                                             44)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     60)
                                             83)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     61)
                                             50)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     62)
                                             91)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     63)
                                             50)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     64)
                                             93)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     65)
                                             32)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     66)
                                             98)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     67)
                                             44)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     68)
                                             83)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     69)
                                             50)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     70)
                                             91)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     71)
                                             93)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     72)
                                             91)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     73)
                                             93)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     74)
                                             91)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     51)
                                             102)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     75)
                                             51)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     76)
                                             93)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     77)
                                             32)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     78)
                                             99)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     79)
                                             41)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     80)
                                             83)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     50)
                                             32)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     81)
                                             50)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     40)
                                             93)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     82)
                                             40)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     83)
                                             97)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     84)
                                             100)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     85)
                                             100)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     86)
                                             114)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     87)
                                             101)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     88)
                                             115)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     89)
                                             115)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     90)
                                             32)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     91)
                                             103)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     44)
                                             50)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     92)
                                             44)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     93)
                                             115)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     94)
                                             116)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     95)
                                             114)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     96)
                                             105)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     97)
                                             110)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     98)
                                             103)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     99)
                                             32)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     41)
                                             91)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     100)
                                             120)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     32)
                                             101)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     101)
                                             41)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     1)
                                             49)
                                          (= (select (bytes_tuple_accessor_array
                                                       D)
                                                     0)
                                             83)
                                          (= (bytes_tuple_accessor_length D)
                                             102)
                                          (= E (select (keccak256 B) D))
                                          (>= E 0)
                                          (<= E
                                              115792089237316195423570985008687907853269984665640564039457584007913129639935)
                                          (not (= 97917517395518591791934826843804715574802037062465178277739313638650163451180
                                                  E)))))
                            (=> a!1 (block_8_function_f__57_58_0 1 H A B I F G)))
                          :weight 0))))
      (a!5 (store (store (store ((as const (Array Int Int)) 12) 25 24) 5 23)
                  22
                  21))
      (a!7 (store (store ((as const (Array bytes_tuple Int)) 10)
                         (bytes_tuple ((as const (Array Int Int)) 48) 19)
                         49)
                  (bytes_tuple ((as const (Array Int Int)) 33) 8)
                  35))
      (a!8 (store (store ((as const (Array bytes_tuple Int)) 11)
                         (bytes_tuple ((as const (Array Int Int)) 43) 19)
                         45)
                  (bytes_tuple ((as const (Array Int Int)) 48) 19)
                  50))
      (a!10 (store (store (store ((as const (Array Int Int)) 7) 28 42) 39 41)
                   5
                   46))
      (a!11 (store (store (store ((as const (Array Int Int)) 6) 1 18) 25 32)
                   30
                   29))
      (a!14 (store (store (store ((as const (Array Int Int)) 16) 39 40) 22 36)
                   30
                   37))
      (a!18 (store (store (store ((as const (Array Int Int)) 16) 5 0) 30 37)
                   22
                   36))
      (a!19 (store (store (store ((as const (Array Int Int)) 16) 5 38) 30 37)
                   22
                   36))
      (a!21 (asserted (forall ((A abi_type)
                               (B crypto_type)
                               (C state_type)
                               (D state_type)
                               (E Int)
                               (F tx_type))
                        (! (let ((a!1 (and (summary_constructor_2_C_58_0
                                             0
                                             E
                                             A
                                             B
                                             F
                                             C
                                             D)
                                           (>= (tx.origin F) 0)
                                           (>= (tx.gasprice F) 0)
                                           (>= (msg.value F) 0)
                                           (>= (msg.sender F) 0)
                                           (>= (block.prevrandao F) 0)
                                           (>= (block.timestamp F) 0)
                                           (>= (block.number F) 0)
                                           (>= (block.gaslimit F) 0)
                                           (>= (block.coinbase F) 0)
                                           (>= (block.chainid F) 0)
                                           (>= (block.basefee F) 0)
                                           (<= (tx.origin F)
                                               1461501637330902918203684832716283019655932542975)
                                           (<= (tx.gasprice F)
                                               115792089237316195423570985008687907853269984665640564039457584007913129639935)
                                           (<= (msg.value F)
                                               115792089237316195423570985008687907853269984665640564039457584007913129639935)
                                           (<= (msg.sender F)
                                               1461501637330902918203684832716283019655932542975)
                                           (not (<= (block.prevrandao F)
                                                    18446744073709551616))
                                           (<= (block.prevrandao F)
                                               115792089237316195423570985008687907853269984665640564039457584007913129639935)
                                           (<= (block.timestamp F)
                                               115792089237316195423570985008687907853269984665640564039457584007913129639935)
                                           (<= (block.number F)
                                               115792089237316195423570985008687907853269984665640564039457584007913129639935)
                                           (<= (block.gaslimit F)
                                               115792089237316195423570985008687907853269984665640564039457584007913129639935)
                                           (<= (block.coinbase F)
                                               1461501637330902918203684832716283019655932542975)
                                           (<= (block.chainid F)
                                               115792089237316195423570985008687907853269984665640564039457584007913129639935)
                                           (<= (block.basefee F)
                                               115792089237316195423570985008687907853269984665640564039457584007913129639935)
                                           (= (msg.value F) 0))))
                             (=> a!1 (interface_0_C_58_0 E A B D)))
                           :weight 0))))
      (a!22 (forall ((A abi_type)
                     (B crypto_type)
                     (C Int)
                     (D state_type)
                     (E state_type)
                     (F state_type)
                     (G Int)
                     (H tx_type))
              (! (=> (and (contract_initializer_10_C_58_0 0 G A B H E F)
                          (implicit_constructor_entry_13_C_58_0 C G A B H D E))
                     (summary_constructor_2_C_58_0 0 G A B H D F))
                 :weight 0)))
      (a!23 (asserted (forall ((A abi_type)
                               (B crypto_type)
                               (C Int)
                               (D state_type)
                               (E state_type)
                               (F Int)
                               (G tx_type))
                        (! (=> (contract_initializer_after_init_12_C_58_0
                                 C
                                 F
                                 A
                                 B
                                 G
                                 D
                                 E)
                               (contract_initializer_10_C_58_0 C F A B G D E))
                           :weight 0))))
      (a!24 (asserted (forall ((A abi_type)
                               (B crypto_type)
                               (C Int)
                               (D state_type)
                               (E state_type)
                               (F Int)
                               (G tx_type))
                        (! (=> (contract_initializer_entry_11_C_58_0
                                 C
                                 F
                                 A
                                 B
                                 G
                                 D
                                 E)
                               (contract_initializer_after_init_12_C_58_0
                                 C
                                 F
                                 A
                                 B
                                 G
                                 D
                                 E))
                           :weight 0))))
      (a!25 (store (store (store ((as const (Array Int Int)) 4) 17 18) 54 55)
                   39
                   15))
      (a!26 (store (store (store ((as const (Array Int Int)) 2) 52 53) 39 59)
                   28
                   31))
      (a!32 (forall ((A abi_type)
                     (B crypto_type)
                     (C state_type)
                     (D Int)
                     (E tx_type))
              (! (=> (>= (select (balances C) D) (msg.value E))
                     (implicit_constructor_entry_13_C_58_0 0 D A B E C C))
                 :weight 0))))
(let ((a!6 (store (store ((as const (Array bytes_tuple Int)) 9)
                         (bytes_tuple ((as const (Array Int Int)) 43) 19)
                         44)
                  (bytes_tuple (store a!5 20 19) 102)
                  97917517395518591791934826843804715574802037062465178277739313638650163451181))
      (a!12 (store (store (store (store a!11 28 27) 3 240) 0 38) 5 26))
      (a!27 (bytes_tuple (store (store (store a!26 20 32) 47 51) 57 58) 3)))
(let ((a!9 (crypto_type ((as const (Array ecrecover_input_type Int)) 8)
                        (store a!6
                               (bytes_tuple ((as const (Array Int Int)) 33) 8)
                               34)
                        a!7
                        a!8))
      (a!13 (tx_type 7719
                     38
                     10450
                     32285
                     8365
                     18446744073709551617
                     11797
                     (store a!10 20 47)
                     (bytes_tuple (store a!12 2 31) 4)
                     8855
                     638722032
                     0
                     2437
                     21238))
      (a!28 (tx_type 26285
                     8945
                     15921
                     20537
                     281
                     18446744073709551617
                     1142
                     (store (store (store a!25 28 29) 26 27) 38 41)
                     a!27
                     28100
                     6
                     0
                     5853
                     30612)))
(let ((a!15 ((_ hyper-res 0 0)
              (asserted (forall ((A abi_type)
                                 (B crypto_type)
                                 (C state_type)
                                 (D Int)
                                 (E tx_type))
                          (! (block_6_f_56_58_0 0 D A B E C C) :weight 0)))
              (block_6_f_56_58_0
                0
                5
                abi_type
                a!9
                a!13
                (state_type (store a!14 5 38))
                (state_type (store a!14 5 38)))))
      (a!29 ((_ hyper-res 0 0)
              (asserted (forall ((A abi_type)
                                 (B crypto_type)
                                 (C state_type)
                                 (D Int)
                                 (E tx_type))
                          (! (contract_initializer_entry_11_C_58_0
                               0
                               D
                               A
                               B
                               E
                               C
                               C)
                             :weight 0)))
              (contract_initializer_entry_11_C_58_0
                0
                5
                abi_type
                a!9
                a!28
                (state_type (store a!14 5 0))
                (state_type (store a!14 5 0)))))
      (a!33 ((_ hyper-res 0 0)
              (asserted a!32)
              (implicit_constructor_entry_13_C_58_0
                0
                5
                abi_type
                a!9
                a!28
                (state_type (store a!14 5 0))
                (state_type (store a!14 5 0))))))
(let ((a!16 ((_ hyper-res 0 0 0 1)
              a!4
              a!15
              (block_8_function_f__57_58_0
                1
                5
                abi_type
                a!9
                a!13
                (state_type (store a!14 5 38))
                (state_type (store a!14 5 38)))))
      (a!30 ((_ hyper-res 0 0 0 1)
              a!24
              a!29
              (contract_initializer_after_init_12_C_58_0
                0
                5
                abi_type
                a!9
                a!28
                (state_type (store a!14 5 0))
                (state_type (store a!14 5 0))))))
(let ((a!17 ((_ hyper-res 0 0 0 1)
              a!3
              a!16
              (summary_3_function_f__57_58_0
                1
                5
                abi_type
                a!9
                a!13
                (state_type (store a!14 5 38))
                (state_type (store a!14 5 38)))))
      (a!31 ((_ hyper-res 0 0 0 1)
              a!23
              a!30
              (contract_initializer_10_C_58_0
                0
                5
                abi_type
                a!9
                a!28
                (state_type (store a!14 5 0))
                (state_type (store a!14 5 0))))))
(let ((a!20 ((_ hyper-res 0 0 0 1)
              a!2
              a!17
              (summary_4_function_f__57_58_0
                1
                5
                abi_type
                a!9
                a!13
                (state_type (store a!18 39 40))
                (state_type (store a!19 39 40)))))
      (a!34 ((_ hyper-res 0 0 0 1 0 2)
              (asserted a!22)
              a!31
              a!33
              (summary_constructor_2_C_58_0
                0
                5
                abi_type
                a!9
                a!28
                (state_type (store a!14 5 0))
                (state_type (store a!14 5 0))))))
(let ((a!35 ((_ hyper-res 0 0 0 1)
              a!21
              a!34
              (interface_0_C_58_0
                5
                abi_type
                a!9
                (state_type (store a!18 39 40))))))
  ((_ hyper-res 0 0 0 1)
    (asserted (=> error_target_3_0 query!187))
    ((_ hyper-res 0 0 0 1 0 2) (asserted a!1) a!20 a!35 error_target_3_0)
    query!187)))))))))
(asserted (=> query!187 false))
false
```
</details>

#### <img src="https://avatars.githubusercontent.com/u/3140080?u=2f731a1aa6e7b2a1fdeafc89a287cd804bcc781f&v=4" width="50">[Saw-mon-and-Natalie](https://github.com/Saw-mon-and-Natalie) commented at [2023-05-16 16:34](https://github.com/ethereum/solidity/pull/14167#issuecomment-1550005271):

More info for:
- https://github.com/ethereum/solidity/pull/14167#issuecomment-1548964295

<details>
<summary><code>z3::fixedpoint</code> rules and background axioms</summary>

```python
(declare-datatypes ((state_type 0)) (((state_type (balances (Array Int Int))))))
(declare-datatypes ((bytes_tuple 0)) (((bytes_tuple (bytes_tuple_accessor_array (Array Int Int)) (bytes_tuple_accessor_length Int)))))
(declare-datatypes ((ecrecover_input_type 0)) (((ecrecover_input_type (hash Int) (v Int) (r Int) (s Int)))))
(declare-datatypes ((crypto_type 0)) (((crypto_type (ecrecover (Array ecrecover_input_type Int)) (keccak256 (Array bytes_tuple Int)) (ripemd160 (Array bytes_tuple Int)) (sha256 (Array bytes_tuple Int))))))
(declare-datatypes ((abi_type 0)) (((abi_type))))
(declare-datatypes ((tx_type 0)) (((tx_type (block.basefee Int) (block.chainid Int) (block.coinbase Int) (block.gaslimit Int) (block.number Int) (block.prevrandao Int) (block.timestamp Int) (blockhash (Array Int Int)) (msg.data bytes_tuple) (msg.sender Int) (msg.sig Int) (msg.value Int) (tx.gasprice Int) (tx.origin Int)))))
(declare-rel contract_initializer_after_init_12_C_20_0 (Int Int abi_type crypto_type tx_type state_type state_type))
(declare-rel implicit_constructor_entry_13_C_20_0 (Int Int abi_type crypto_type tx_type state_type state_type))
(declare-rel block_5_function_f__19_20_0 (Int Int abi_type crypto_type tx_type state_type state_type))
(declare-rel interface_0_C_20_0 (Int abi_type crypto_type state_type))
(declare-rel nondet_interface_1_C_20_0 (Int Int abi_type crypto_type state_type state_type))
(declare-rel summary_4_function_f__19_20_0 (Int Int abi_type crypto_type tx_type state_type state_type))
(declare-rel block_9_function_f__19_20_0 (Int Int abi_type crypto_type tx_type state_type state_type))
(declare-rel block_8_function_f__19_20_0 (Int Int abi_type crypto_type tx_type state_type state_type))
(declare-rel error_target_3_0 ())
(declare-rel block_7_return_function_f__19_20_0 (Int Int abi_type crypto_type tx_type state_type state_type))
(declare-rel summary_constructor_2_C_20_0 (Int Int abi_type crypto_type tx_type state_type state_type))
(declare-rel block_6_f_18_20_0 (Int Int abi_type crypto_type tx_type state_type state_type))
(declare-rel summary_3_function_f__19_20_0 (Int Int abi_type crypto_type tx_type state_type state_type))
(declare-rel contract_initializer_entry_11_C_20_0 (Int Int abi_type crypto_type tx_type state_type state_type))
(declare-rel contract_initializer_10_C_20_0 (Int Int abi_type crypto_type tx_type state_type state_type))
(declare-var A Int)
(declare-var B state_type)
(declare-var C Int)
(declare-var D crypto_type)
(declare-var E abi_type)
(declare-var F tx_type)
(declare-var G state_type)
(declare-var H state_type)
(declare-var I Int)
(declare-var J Bool)
(declare-var K bytes_tuple)
(declare-var L Int)
(declare-var M Int)
(declare-var N state_type)
(rule (! (=> (= C 0) (nondet_interface_1_C_20_0 C A E D B B)) :named base_nondet))
(rule (! (=> (and (summary_4_function_f__19_20_0 C A E D F G B)
         (nondet_interface_1_C_20_0 I A E D H G)
         (= I 0))
    (nondet_interface_1_C_20_0 C A E D H B)) :named nondet_interface_1_C_20_0_to_nondet_interface_1_C_20_0))
(rule (! (block_5_function_f__19_20_0 C A E D F G B) :named block_5_function_f__19_20_0!))
(rule (! (=> (and (block_5_function_f__19_20_0 C A E D F G B) (= C 0) (= B G))
    (block_6_f_18_20_0 C A E D F G B)) :named block_5_function_f__19_20_0_to_block_6_f_18_20_0))
(rule (! (let ((a!1 (and (block_6_f_18_20_0 M A E D F G B)
                (= (bytes_tuple_accessor_length K) 13)
                (= (select (bytes_tuple_accessor_array K) 0) 83)
                (= (select (bytes_tuple_accessor_array K) 1) 49)
                (= (select (bytes_tuple_accessor_array K) 2) 40)
                (= (select (bytes_tuple_accessor_array K) 3) 117)
                (= (select (bytes_tuple_accessor_array K) 4) 105)
                (= (select (bytes_tuple_accessor_array K) 5) 110)
                (= (select (bytes_tuple_accessor_array K) 6) 116)
                (= (select (bytes_tuple_accessor_array K) 7) 50)
                (= (select (bytes_tuple_accessor_array K) 8) 53)
                (= (select (bytes_tuple_accessor_array K) 9) 54)
                (= (select (bytes_tuple_accessor_array K) 10) 32)
                (= (select (bytes_tuple_accessor_array K) 11) 120)
                (= (select (bytes_tuple_accessor_array K) 12) 41)
                (= C (select (keccak256 D) K))
                (=> true
                    (and (>= C 0)
                         (<= C
                             115792089237316195423570985008687907853269984665640564039457584007913129639935)))
                (= J (= I C))
                (not (= J true))
                (= I
                   54574610769285188390170717317527093233128981244767303702604084935113342998240) # keccak256("S1(uint256 x)")
                (= L 1)
                (=> true
                    (and (>= I 0)
                         (<= I
                             115792089237316195423570985008687907853269984665640564039457584007913129639935))))))
  (=> a!1 (block_8_function_f__19_20_0 L A E D F G B))) :named block_6_f_18_20_0_to_block_8_function_f__19_20_0))
(rule (! (=> (block_8_function_f__19_20_0 C A E D F G B)
    (summary_3_function_f__19_20_0 C A E D F G B)) :named block_8_function_f__19_20_0!))
(rule (! (let ((a!1 (and (block_6_f_18_20_0 M A E D F G B)
                (= (bytes_tuple_accessor_length K) 13)
                (= (select (bytes_tuple_accessor_array K) 0) 83)
                (= (select (bytes_tuple_accessor_array K) 1) 49)
                (= (select (bytes_tuple_accessor_array K) 2) 40)
                (= (select (bytes_tuple_accessor_array K) 3) 117)
                (= (select (bytes_tuple_accessor_array K) 4) 105)
                (= (select (bytes_tuple_accessor_array K) 5) 110)
                (= (select (bytes_tuple_accessor_array K) 6) 116)
                (= (select (bytes_tuple_accessor_array K) 7) 50)
                (= (select (bytes_tuple_accessor_array K) 8) 53)
                (= (select (bytes_tuple_accessor_array K) 9) 54)
                (= (select (bytes_tuple_accessor_array K) 10) 32)
                (= (select (bytes_tuple_accessor_array K) 11) 120)
                (= (select (bytes_tuple_accessor_array K) 12) 41)
                (= C (select (keccak256 D) K))
                (=> true
                    (and (>= C 0)
                         (<= C
                             115792089237316195423570985008687907853269984665640564039457584007913129639935)))
                (= J (= I C))
                (= L M)
                (= I
                   54574610769285188390170717317527093233128981244767303702604084935113342998240) # keccak256("S1(uint256 x)")
                (= L 1)
                (=> true
                    (and (>= I 0)
                         (<= I
                             115792089237316195423570985008687907853269984665640564039457584007913129639935))))))
  (=> a!1 (block_7_return_function_f__19_20_0 L A E D F G B))) :named block_6_f_18_20_0_to_block_7_return_function_f__19_20_0))
(rule (! (=> (block_7_return_function_f__19_20_0 C A E D F G B)
    (summary_3_function_f__19_20_0 C A E D F G B)) :named block_7_return_function_f__19_20_0_to_summary_3_function_f__19_20_0))
(rule (! (block_9_function_f__19_20_0 C A E D F G B) :named block_9_function_f__19_20_0!))
(rule (! (let ((a!1 (= (select (bytes_tuple_accessor_array (msg.data F)) 0) 38))
      (a!2 (= (select (bytes_tuple_accessor_array (msg.data F)) 1) 18))
      (a!3 (= (select (bytes_tuple_accessor_array (msg.data F)) 2) 31))
      (a!4 (= (select (bytes_tuple_accessor_array (msg.data F)) 3) 240))
      (a!5 (>= (+ (select (balances H) A) C) 0))
      (a!6 (<= (+ (select (balances H) A) C)
               115792089237316195423570985008687907853269984665640564039457584007913129639935))
      (a!7 (store (balances H) A (+ (select (balances H) A) C))))
(let ((a!8 (and (block_9_function_f__19_20_0 L A E D F N H)
                (summary_3_function_f__19_20_0 I A E D F G B)
                (> (block.prevrandao F) 18446744073709551616)
                (>= (block.chainid F) 0)
                (<= (block.basefee F)
                    115792089237316195423570985008687907853269984665640564039457584007913129639935)
                (>= (block.coinbase F) 0)
                (<= (block.chainid F)
                    115792089237316195423570985008687907853269984665640564039457584007913129639935)
                (>= (block.prevrandao F) 0)
                (<= (block.coinbase F)
                    1461501637330902918203684832716283019655932542975)
                (>= (block.gaslimit F) 0)
                (<= (block.prevrandao F)
                    115792089237316195423570985008687907853269984665640564039457584007913129639935)
                (>= (block.number F) 0)
                (<= (block.gaslimit F)
                    115792089237316195423570985008687907853269984665640564039457584007913129639935)
                (= (msg.value F) 0)
                (>= (block.timestamp F) 0)
                (<= (block.number F)
                    115792089237316195423570985008687907853269984665640564039457584007913129639935)
                (= (msg.sig F) 638722032)
                (>= (msg.sender F) 0)
                (<= (block.timestamp F)
                    115792089237316195423570985008687907853269984665640564039457584007913129639935)
                a!1
                (>= (msg.value F) 0)
                (<= (msg.sender F)
                    1461501637330902918203684832716283019655932542975)
                a!2
                (>= (tx.origin F) 0)
                (<= (msg.value F)
                    115792089237316195423570985008687907853269984665640564039457584007913129639935)
                a!3
                (>= (tx.gasprice F) 0)
                (<= (tx.origin F)
                    1461501637330902918203684832716283019655932542975)
                a!4
                (<= (tx.gasprice F)
                    115792089237316195423570985008687907853269984665640564039457584007913129639935)
                a!5
                (= H N)
                (>= (bytes_tuple_accessor_length (msg.data F)) 4)
                (>= C (msg.value F))
                a!6
                (= G (state_type a!7))
                (= L 0)
                (>= (block.basefee F) 0))))
  (=> a!8 (summary_4_function_f__19_20_0 I A E D F N B)))) :named block_9_function_f__19_20_0_to_summary_4_function_f__19_20_0))
(rule (! (=> (and (summary_4_function_f__19_20_0 C A E D F G B)
         (interface_0_C_20_0 A E D G)
         (= C 0))
    (interface_0_C_20_0 A E D B)) :named interface_0_C_20_0_to_interface_0_C_20_0))
(rule (! (=> (and (= B G) (= C 0)) (contract_initializer_entry_11_C_20_0 C A E D F G B)) :named contract_initializer_entry_11_C_20_0!))
(rule (! (=> (contract_initializer_entry_11_C_20_0 C A E D F G B)
    (contract_initializer_after_init_12_C_20_0 C A E D F G B)) :named contract_initializer_entry_11_C_20_0_to_contract_initializer_after_init_12_C_20_0))
(rule (! (=> (contract_initializer_after_init_12_C_20_0 C A E D F G B)
    (contract_initializer_10_C_20_0 C A E D F G B)) :named contract_initializer_after_init_12_C_20_0_to_contract_initializer_10_C_20_0))
(rule (! (let ((a!1 (and (= B G) (= C 0) (>= (select (balances B) A) (msg.value F)))))
  (=> a!1 (implicit_constructor_entry_13_C_20_0 C A E D F G B))) :named implicit_constructor_entry_13_C_20_0!))
(rule (! (=> (and (implicit_constructor_entry_13_C_20_0 I A E D F H G)
         (contract_initializer_10_C_20_0 C A E D F G B)
         (> C 0))
    (summary_constructor_2_C_20_0 C A E D F H B)) :named implicit_constructor_entry_13_C_20_0_to_summary_constructor_2_C_20_0))
(rule (! (=> (and (contract_initializer_10_C_20_0 C A E D F G B)
         (implicit_constructor_entry_13_C_20_0 I A E D F H G)
         (= C 0))
    (summary_constructor_2_C_20_0 C A E D F H B)) :named implicit_constructor_entry_13_C_20_0_to_summary_constructor_2_C_20_0!))
(rule (! (=> (and (summary_constructor_2_C_20_0 C A E D F G B)
         (> (block.prevrandao F) 18446744073709551616)
         (>= (block.chainid F) 0)
         (<= (block.basefee F)
             115792089237316195423570985008687907853269984665640564039457584007913129639935)
         (>= (block.coinbase F) 0)
         (<= (block.chainid F)
             115792089237316195423570985008687907853269984665640564039457584007913129639935)
         (>= (block.prevrandao F) 0)
         (<= (block.coinbase F)
             1461501637330902918203684832716283019655932542975)
         (>= (block.gaslimit F) 0)
         (<= (block.prevrandao F)
             115792089237316195423570985008687907853269984665640564039457584007913129639935)
         (>= (block.number F) 0)
         (<= (block.gaslimit F)
             115792089237316195423570985008687907853269984665640564039457584007913129639935)
         (>= (block.timestamp F) 0)
         (<= (block.number F)
             115792089237316195423570985008687907853269984665640564039457584007913129639935)
         (>= (msg.sender F) 0)
         (<= (block.timestamp F)
             115792089237316195423570985008687907853269984665640564039457584007913129639935)
         (>= (msg.value F) 0)
         (<= (msg.sender F) 1461501637330902918203684832716283019655932542975)
         (>= (tx.origin F) 0)
         (<= (msg.value F)
             115792089237316195423570985008687907853269984665640564039457584007913129639935)
         (>= (tx.gasprice F) 0)
         (<= (tx.origin F) 1461501637330902918203684832716283019655932542975)
         (<= (tx.gasprice F)
             115792089237316195423570985008687907853269984665640564039457584007913129639935)
         (= (msg.value F) 0)
         (= C 0)
         (>= (block.basefee F) 0))
    (interface_0_C_20_0 A E D B)) :named summary_constructor_2_C_20_0_to_interface_0_C_20_0))
(rule (! (=> (and (summary_4_function_f__19_20_0 C A E D F G B)
         (interface_0_C_20_0 A E D G)
         (= C 1))
    error_target_3_0) :named interface_0_C_20_0_to_error_target_3_0))
```
</details>

I'm guessing it might be because `keccak256 (Array bytes_tuple Int)` for `crypto_type` is a symbolic declaration which is not concretely defined and and so `z3` tries to find a possible model for it that would make the whole query `SAT`.

Even for:

```solidity
contract C {
	function f() public pure {
		assert(bytes32(0x78a822935e38445215ba7404686b919cbbef5725cbf9231d92802f542d7456e0) == keccak256("S1(uint256 x)"));
	}
}
// ====
// SMTEngine: chc
// ----
```

We get:
```bash
Warning 6328: (43-156): CHC: Assertion violation happens here.
```

Here is [reference](https://github.com/ethereum/solidity/blob/f8d1437206bbd16f006fafab207c85460bdb6a50/test/libsolidity/smtCheckerTests/abi/abi_encode_with_selector_vs_sig.sol#L16) example by @leonardoalt:

```solidity
// test/libsolidity/smtCheckerTests/abi/abi_encode_with_selector_vs_sig.sol
contract C {
	function f(string memory sig, uint x, uint[] memory a) public pure {
		bytes memory b1 = abi.encodeWithSignature(sig, x, a);
		bytes memory b2 = abi.encodeWithSelector(bytes4(keccak256(bytes(sig))), x, a);
		// should hold but we do not evaluate keccak256 in an interpreted way
		//assert(b1.length == b2.length);
		assert(b1.length != b2.length); // should fail
	}
}
// ====
// SMTEngine: all
// SMTIgnoreOS: macos
// ----
// Warning 6328: (330-360): CHC: Assertion violation might happen here.
// Warning 7812: (330-360): BMC: Assertion violation might happen here.
```

If we tweak the test file to something like:

```solidity
contract C {
    struct S1 {
        uint256 x;
    }

    function f() public pure {
        // keccak256("S1(uint256 x)") =
        // 0x78a822935e38445215ba7404686b919cbbef5725cbf9231d92802f542d7456e0
        assert(type(S1).typehash == bytes32(0x78a822935e38445215ba7404686b919cbbef5725cbf9231d92802f542d7456e0));
    }
}
// ====
// SMTEngine: all
// ----
```

We get:
```bash
Info 1391: CHC: 1 verification condition(s) proved safe! Enable the model checker option "show proved safe" to see all of them.
```

We can also have tests like the following:

```solidity
library A {
    struct S1 {
        uint256 x;
    }

    bytes32 internal constant a = type(S1).typehash;
}

library B {
    struct S1 {
        uint256 x;
    }

    bytes32 internal constant b = type(S1).typehash;
}

contract C {
    function f() public pure {
        assert(A.a == B.b);
    }
}
// ====
// SMTEngine: all
// ----
// Info 1391: CHC: 1 verification condition(s) proved safe! Enable the model checker option "show proved safe" to see all of them.
```

#### <img src="https://avatars.githubusercontent.com/u/504195?u=ce2facd14af9fd474ebff49f0d44891f56f7500f&v=4" width="50">[leonardoalt](https://github.com/leonardoalt) commented at [2023-05-16 17:58](https://github.com/ethereum/solidity/pull/14167#issuecomment-1550121927):

Exactly, the SMTChecker (both engines BMC and CHC) doesn't compute `keccak` concretely. I see that the added test uses keccak of string literals, which we could compute at compile-time as an optimization, but that's orthogonal. So for this PR I would suggest to replace the keccak calls by the actual hashes which can then be asserted, with comments of how the hash was obtained.

#### <img src="https://avatars.githubusercontent.com/u/702124?u=00e20e1963ccc9a908a5826b2d8c3b1b1f6acea4&v=4" width="50">[k06a](https://github.com/k06a) commented at [2023-05-17 07:23](https://github.com/ethereum/solidity/pull/14167#issuecomment-1550884895):

@leonardoalt are you sure we need adopt tests for this strange behaviour instead of fixing the behaviour itself?

#### <img src="https://avatars.githubusercontent.com/u/504195?u=ce2facd14af9fd474ebff49f0d44891f56f7500f&v=4" width="50">[leonardoalt](https://github.com/leonardoalt) commented at [2023-05-17 07:34](https://github.com/ethereum/solidity/pull/14167#issuecomment-1550898570):

That's not strange behavior, it's abstraction and you'll see it all over the SMT tests like the test @Saw-mon-and-Natalie linked above.

To clarify further: functions such as keccak and ABI encode/decode are too complex to be encoded precisely in SAT/SMT. Instead they are encoded as Uninterpreted Functions, that is, their semantics are symbolic and the axiom you get is syntactic: f(a1,b1...k1) = f(a2, b2,...k2) iff a1=a2, b1=b2...k1=k2.

Other examples of the same thing are the selector tests. We don't compute the hash and check the 4-byte prefix in SMT, but rather compare f.selector directly to a 4-byte number.

That said, we could compute the keccaks at compile time whenever the arguments are string literals, which is the case is the test added here, but that's a different feature so I don't think it should be done here. That's why I suggested comparing typehash to a constant with a comment containing how it was created so that that can be used when the new feature is added. Note that all of this only relates to the tests inside smtCheckerTests and no other.

#### <img src="https://avatars.githubusercontent.com/u/702124?u=00e20e1963ccc9a908a5826b2d8c3b1b1f6acea4&v=4" width="50">[k06a](https://github.com/k06a) commented at [2023-05-18 21:36](https://github.com/ethereum/solidity/pull/14167#issuecomment-1553680770):

Fixed tests!

#### <img src="https://avatars.githubusercontent.com/u/13174375?u=52d702cb6bec53b561afa293cf9cd53ef7a63924&v=4" width="50">[hrkrshnn](https://github.com/hrkrshnn) commented at [2023-05-19 11:30](https://github.com/ethereum/solidity/pull/14167#issuecomment-1554437848):

@k06a would you be working on adding the tests mentioned here: https://github.com/ethereum/solidity/pull/14167#pullrequestreview-1417033283

That's the main blocker here.

#### <img src="https://avatars.githubusercontent.com/u/3140080?u=2f731a1aa6e7b2a1fdeafc89a287cd804bcc781f&v=4" width="50">[Saw-mon-and-Natalie](https://github.com/Saw-mon-and-Natalie) commented at [2023-05-21 15:49](https://github.com/ethereum/solidity/pull/14167#issuecomment-1556211894):

@hrkrshnn @k06a , added syntax tests to address:
- https://github.com/ethereum/solidity/pull/14167#pullrequestreview-1417033283

Also updated the `TypeChecker.cpp` logic to:
- catch recursive struct definition and report a type error (previously it would segfault)
- catch member types that cannot be used for `EIP712` and report a type error (previously it would throw during code generation)
- error numbers are generated using `scripts/error_codes.py --fix `

commit:
- https://github.com/ethereum/solidity/pull/14167/commits/92350cba199b9d8e33954afb5ffd9285b217bd54

Note, currently an error will be reported for `enum` struct members. We could remove this restriction to have it pass through which currently should convert it to `uint8` (for example `seaport` structs have enum members that are hashed using `uint8`).

There are more semantic tests cases that should be added. I can add more in a different commit.
Adding fuzz tests would be great too.

#### <img src="https://avatars.githubusercontent.com/u/13174375?u=52d702cb6bec53b561afa293cf9cd53ef7a63924&v=4" width="50">[hrkrshnn](https://github.com/hrkrshnn) commented at [2023-05-21 21:36](https://github.com/ethereum/solidity/pull/14167#issuecomment-1556297749):

Hey @Saw-mon-and-Natalie: quick comment on the semantic test in case there
is a confusion here with `smtCheckerTests`.

The semantic tests should be inside
https://github.com/ethereum/solidity/tree/develop/test/libsolidity/semanticTests.
See my previous review that gives an example test (with that diff patch).

On Sun, May 21, 2023, 5:49 PM Saw-mon & Natalie ***@***.***>
wrote:

> @hrkrshnn <https://github.com/hrkrshnn> @k06a <https://github.com/k06a> ,
> added syntax tests to address:
>
>    - #14167 (review)
>    <https://github.com/ethereum/solidity/pull/14167#pullrequestreview-1417033283>
>
> Also updated the TypeChecker.cpp logic to:
>
>    - catch recursive struct definition and report a type error
>    - catch member types that cannot be used for EIP712 and report a type
>    error
>    - error numbers are generated using scripts/error_codes.py --fix
>
> commit:
>
>    - 92350cb
>    <https://github.com/ethereum/solidity/commit/92350cba199b9d8e33954afb5ffd9285b217bd54>
>
> Note, currently an error will be reported for enum struct members. We
> could remove this restriction to have it pass through which currently
> should convert it to uint8 (for example seaport structs have enum members
> that are hashed using uint8).
>
> There are more semantic tests cases that should be added. I can add more
> in a different commit.
>
> â€”
> Reply to this email directly, view it on GitHub
> <https://github.com/ethereum/solidity/pull/14167#issuecomment-1556211894>,
> or unsubscribe
> <https://github.com/notifications/unsubscribe-auth/ADEQMZYUGZSQH77Y4IORXFTXHI2R3ANCNFSM6AAAAAAXO6XSGA>
> .
> You are receiving this because you were mentioned.Message ID:
> ***@***.***>
>

#### <img src="https://avatars.githubusercontent.com/u/702124?u=00e20e1963ccc9a908a5826b2d8c3b1b1f6acea4&v=4" width="50">[k06a](https://github.com/k06a) commented at [2023-06-06 20:30](https://github.com/ethereum/solidity/pull/14167#issuecomment-1579404541):

So, do we have anything else to fix here?

#### <img src="https://avatars.githubusercontent.com/u/1347491?v=4" width="50">[ekpyron](https://github.com/ekpyron) commented at [2023-06-13 12:16](https://github.com/ethereum/solidity/pull/14167#issuecomment-1589187852):

> So, do we have anything else to fix here?

Pinging @hrkrshnn, since he promised to take care of reviewing this :-). I also retriggered CI, since it failed due to a random network error. EDIT: there's some remaining CI failures that should be unrelated and fixed by a rebase to current develop.

#### <img src="https://avatars.githubusercontent.com/u/13174375?u=52d702cb6bec53b561afa293cf9cd53ef7a63924&v=4" width="50">[hrkrshnn](https://github.com/hrkrshnn) commented at [2023-06-13 12:46](https://github.com/ethereum/solidity/pull/14167#issuecomment-1589244785):

> So, do we have anything else to fix here?

@k06a Could you add a few more semantic tests? Especially for nested cases?

Also sorry about the delay; was busy the last 2 weeks. Should be able to spend more time reviewing this in the coming days.

#### <img src="https://avatars.githubusercontent.com/u/702124?u=00e20e1963ccc9a908a5826b2d8c3b1b1f6acea4&v=4" width="50">[k06a](https://github.com/k06a) commented at [2023-07-05 11:49](https://github.com/ethereum/solidity/pull/14167#issuecomment-1621602853):

@hrkrshnn added semantic test for nested structs and rebased commits to fix CI

#### <img src="https://avatars.githubusercontent.com/u/702124?u=00e20e1963ccc9a908a5826b2d8c3b1b1f6acea4&v=4" width="50">[k06a](https://github.com/k06a) commented at [2023-07-18 19:12](https://github.com/ethereum/solidity/pull/14167#issuecomment-1640836666):

@hrkrshnn @leonardoalt what can we do to speed up merging?

#### <img src="https://avatars.githubusercontent.com/u/702124?u=00e20e1963ccc9a908a5826b2d8c3b1b1f6acea4&v=4" width="50">[k06a](https://github.com/k06a) commented at [2023-10-16 09:54](https://github.com/ethereum/solidity/pull/14167#issuecomment-1764122502):

@hrkrshnn let's decide something on enums and UDT to finally merge this PR...

#### <img src="https://avatars.githubusercontent.com/u/4415530?u=dc3db70e8fbd03f92ca81ee173d57774ce61084d&v=4" width="50">[nikola-matic](https://github.com/nikola-matic) commented at [2023-11-28 11:56](https://github.com/ethereum/solidity/pull/14167#issuecomment-1829695153):

Hi @k06a, can you add a test that covers structs with same name defined in two separate contracts, used in one, e.g.:

```
====A.sol====
struct S
{
    uint256 x;
}

====B.sol====
import { S as T } from "A.sol";

struct S
{
    T t;
}
```
or you can avoid renaming during import and simply use a fully qualified name, i.e. `A.S t`.

Either way, the PR doesn't account for this since it doesn't disambiguate between such cases - should likely be handled by disallowing this.

#### <img src="https://avatars.githubusercontent.com/u/4415530?u=dc3db70e8fbd03f92ca81ee173d57774ce61084d&v=4" width="50">[nikola-matic](https://github.com/nikola-matic) commented at [2024-03-27 10:19](https://github.com/ethereum/solidity/pull/14167#issuecomment-2022397840):

Hi @k06a, do you plan on continuing your work on this? Sorry for taking this long to review by the way.

#### <img src="https://avatars.githubusercontent.com/u/702124?u=00e20e1963ccc9a908a5826b2d8c3b1b1f6acea4&v=4" width="50">[k06a](https://github.com/k06a) commented at [2024-04-16 16:07](https://github.com/ethereum/solidity/pull/14167#issuecomment-2059449492):

@nikola-matic done!

#### <img src="https://avatars.githubusercontent.com/u/702124?u=00e20e1963ccc9a908a5826b2d8c3b1b1f6acea4&v=4" width="50">[k06a](https://github.com/k06a) commented at [2024-04-16 16:08](https://github.com/ethereum/solidity/pull/14167#issuecomment-2059451570):

> test that covers structs with same name defined in two separate contracts

@nikola-matic I need help with that


-------------------------------------------------------------------------------



[Export of Github issue for [ethereum/solidity](https://github.com/ethereum/solidity). Generated on 2024.12.15 at 06:45:24.]
