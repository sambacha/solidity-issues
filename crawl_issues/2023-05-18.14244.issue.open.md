# [\#14244 Issue](https://github.com/ethereum/solidity/issues/14244) `open`: Incorrect handling of revert when `viaIR = true`
**Labels**: `bug :bug:`


#### <img src="https://avatars.githubusercontent.com/u/7003246?v=4" width="50">[barakman](https://github.com/barakman) opened issue at [2023-05-18 07:22](https://github.com/ethereum/solidity/issues/14244):

## Description

Calling a function which takes no input arguments, under a scenario in which the function should revert with a message:
- When `viaIR = false`, the function reverts with the expected message
- When `viaIR = true`, the function reverts with a different message

## Environment

- Compiler version: 0.8.19
- Framework/IDE: hardhat-truffle5
- Operating system: MacOS

I have tested this problem separately with hardhat versions 2.12.7 and 2.14.0.
The reproduction below uses the 'truffle5' plugin, but it also works without it.

## Steps to Reproduce

```solidity
pragma solidity 0.8.19;

contract MyContract {
    bool private alreadyCalled;

    function initialize() external {
        require(!alreadyCalled, "already called");
        alreadyCalled = true;
    }
}
```

```javascript
const MyContract = artifacts.require("MyContract");

contract("MyContract", () => {
    it("Test", async () => {
        const myContract = await MyContract.new();

        await myContract.initialize();
        try {
            await myContract.initialize();
        } catch (error) {
            console.log(error.message);
        }
    });
});
```

Outcome:
```
+---------+-------+-----------------------------------------------------------------------------------------+
| HardHat | viaIR | Printout                                                                                |
+---------+-------+-----------------------------------------------------------------------------------------+
| 2.12.7  | false | VM Exception while processing transaction: reverted with reason string 'already called' |
+---------+-------+-----------------------------------------------------------------------------------------+
| 2.12.7  | true  | Transaction reverted: function was called with incorrect parameters                     |
+---------+-------+-----------------------------------------------------------------------------------------+
| 2.14.0  | false | VM Exception while processing transaction: reverted with reason string 'already called' |
+---------+-------+-----------------------------------------------------------------------------------------+
| 2.14.0  | true  | Transaction reverted and Hardhat couldn't infer the reason                              |
+---------+-------+-----------------------------------------------------------------------------------------+
```

Strangely enough, adding a `console.log` inside the contract function solves the problem.

This is possibly a HardHat issue, so I shall post it there too.

Please find the project configuration below.

File package.json:
```json
{
    "scripts": {
        "build": "hardhat compile",
        "test": "hardhat test --bail"
    },
    "devDependencies": {
        "@nomiclabs/hardhat-truffle5": "2.0.7",
        "@nomiclabs/hardhat-web3": "2.0.0",
        "hardhat": "2.12.7"
    }
}
```

File hardhat.config.js:
```javascript
require("@nomiclabs/hardhat-truffle5");

module.exports = {
    solidity: {
        version: "0.8.19",
        settings: {
            viaIR: true,
            optimizer: {
                enabled: true,
                runs: 200
            }
        }
    },
    paths: {
        sources: "./project/contracts",
        tests: "./project/tests",
        cache: "./project/cache",
        artifacts: "./project/artifacts"
    }
};
```

Thanks :)

#### <img src="https://avatars.githubusercontent.com/u/13174375?u=52d702cb6bec53b561afa293cf9cd53ef7a63924&v=4" width="50">[hrkrshnn](https://github.com/hrkrshnn) commented at [2023-05-19 18:18](https://github.com/ethereum/solidity/issues/14244#issuecomment-1555059891):

@barakman could you please confirm with a different framework? The `viaIR` in Hardhat is a bit flaky at times, especially with revert messages.

#### <img src="https://avatars.githubusercontent.com/u/137030?v=4" width="50">[cameel](https://github.com/cameel) commented at [2023-05-19 19:18](https://github.com/ethereum/solidity/issues/14244#issuecomment-1555125468):

This looks like https://github.com/NomicFoundation/hardhat/issues/2453 and https://github.com/NomicFoundation/hardhat/issues/3750. See especially https://github.com/NomicFoundation/hardhat/issues/3750#issuecomment-1462483527.

The tl;dr is that you should be running your tests with optimizer disabled if you need Hardhat to properly detect revert reasons when using `viaIR: true`. It's because Hardhat uses heuristics to detect those reasons and they're not reliable with optimized code generated by the the IR pipeline.

Not sure about other frameworks but I would not be suprised if they either have similar limitations or just don't support checking revert reasons. This will only really be solved properly when we get the [ethdebug format](https://github.com/ethdebug/format) specified and implemented in the compiler so that debuggers and frameworks can stop relying on heuristics.

#### <img src="https://avatars.githubusercontent.com/u/22360160?u=68428882948af7fc25e5b53147689b4c0843c831&v=4" width="50">[SevenSwen](https://github.com/SevenSwen) commented at [2023-05-31 08:13](https://github.com/ethereum/solidity/issues/14244#issuecomment-1569707826):

We managed to avoid a similar problem when calling `populateTransaction`: https://github.com/1inch/limit-order-protocol/blob/master/test/RangeAmountCalculator.js#L23

hardhat 2.14.0 / @nomiclabs/hardhat-ethers

Before using `populateTransaction` we had received "without reason" error too.


-------------------------------------------------------------------------------



[Export of Github issue for [ethereum/solidity](https://github.com/ethereum/solidity). Generated on 2024.12.15 at 06:45:24.]
