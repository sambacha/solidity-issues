# [\#14355 PR](https://github.com/ethereum/solidity/pull/14355) `merged`: Via IR bytecode comparison
**Labels**: `testing :hammer:`, `has dependencies`


#### <img src="https://avatars.githubusercontent.com/u/137030?v=4" width="50">[cameel](https://github.com/cameel) opened issue at [2023-06-23 18:02](https://github.com/ethereum/solidity/pull/14355):

~Depends on #14354.~ Merged.
Depends on #14374.
Fixes #13583.

This is the final PR for `--via-ir` bytecode comparison.

#### <img src="https://avatars.githubusercontent.com/u/137030?v=4" width="50">[cameel](https://github.com/cameel) commented at [2023-06-23 18:46](https://github.com/ethereum/solidity/pull/14355#issuecomment-1604709217):

Timing, from the [most recent run](https://app.circleci.com/pipelines/github/ethereum/solidity/30336/workflows/5a907609-222a-4e5a-aa40-13ec169ac1f5):

| Job                     | Preset         | Legacy | Via IR  |
|-------------------------|----------------|--------|---------|
| `b_bytecode_win`        | `optimize`     | 6m 52s | 24m 24s |
| `b_bytecode_win`        | `no-optimize`  | 5m 5s  | 10m 12s |
| `b_bytecode_osx`        | `optimize`     | 3m 56s | 10m 42s |
| `b_bytecode_osx`        | `no-optimize`  | 3m 38s | 5m 55s  |
| `b_bytecode_ems`        | `optimize`     | 5m 31s | 26m 47s |
| `b_bytecode_ems`        | `no-optimize`  | 2m 8s  | 13m 25s |
| `b_bytecode_ubu`        | `optimize`     | 3m 48s | 9m 18s  |
| `b_bytecode_ubu`        | `no-optimize`  | 3m 2s  | 5m 9s   |
| `b_bytecode_ubu_static` | `optimize`     | 2m 12s | 7m 51s  |
| `b_bytecode_ubu_static` | `no-optimize`  | 1m 13s | 3m 35s  |

#### <img src="https://avatars.githubusercontent.com/u/137030?v=4" width="50">[cameel](https://github.com/cameel) commented at [2023-06-23 18:48](https://github.com/ethereum/solidity/pull/14355#issuecomment-1604712981):

Also, we have a problem: [`t_bytecode_compare`](https://app.circleci.com/pipelines/github/ethereum/solidity/30336/workflows/5a907609-222a-4e5a-aa40-13ec169ac1f5/jobs/1346462) does not pass via IR. And it looks like it's due to actual differences in generated bytecode. Weirdly, this happens only for unoptimized code. Optimized is fine.

I will investigate that on Monday.

#### <img src="https://avatars.githubusercontent.com/u/137030?v=4" width="50">[cameel](https://github.com/cameel) commented at [2023-06-26 12:41](https://github.com/ethereum/solidity/pull/14355#issuecomment-1607389028):

Current status: blocked by #14361, which I'll be fixing.

If need be, I could add a temporary workaround to delete test cases that do not pass and merge this. I would then remove that workaround in the PR fixing #14361.

#### <img src="https://avatars.githubusercontent.com/u/137030?v=4" width="50">[cameel](https://github.com/cameel) commented at [2023-06-28 18:23](https://github.com/ethereum/solidity/pull/14355#issuecomment-1611882865):

With #14374 and one additional tweak the bytecode comparison finally passes.

The tweak is basically that one of the tests triggers a `YulException` (actually stack too deep, but for some reason it's not `StackTooDeep`) and CLI just barfs while Standard JSON can still successfully return some outputs like metadata. This is basically a hack to ignore those outputs. The proper way to deal with it would be to fix #13925.

The PR is now reviewable but I'll keep it as a draft until #14374 is merged because PRs with dependencies always confuse people :)

#### <img src="https://avatars.githubusercontent.com/u/137030?v=4" width="50">[cameel](https://github.com/cameel) commented at [2023-07-14 10:17](https://github.com/ethereum/solidity/pull/14355#issuecomment-1635640762):

Base PR was merged. This is now reviewable.

@matheusaaguiar But since the PR is simple and you already reviewed and approved it, we can also just merge if you reapprove.


-------------------------------------------------------------------------------



[Export of Github issue for [ethereum/solidity](https://github.com/ethereum/solidity). Generated on 2024.12.15 at 06:45:24.]
