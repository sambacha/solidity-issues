# [\#14928 PR](https://github.com/ethereum/solidity/pull/14928) `closed`: [seqbench] `the-good-parts-mk2` sequence
**Labels**: `performance :racehorse:`, `optimizer`


#### <img src="https://avatars.githubusercontent.com/u/137030?v=4" width="50">[cameel](https://github.com/cameel) opened issue at [2024-03-08 22:58](https://github.com/ethereum/solidity/pull/14928):

Related to https://github.com/ethereum/solidity/issues/14406

**Do not merge**. This is just a test PR to evaluate how the `the-good-parts-mk2` sequence would affect costs in CI.

A small tweak of `the-good-parts` sequence (#14909), which makes it deal better with the `erc20.sol` contract.

The difference is the addition of the `gvif` part before the final segment that makes code "short and pretty".

#### <img src="https://avatars.githubusercontent.com/u/137030?v=4" width="50">[cameel](https://github.com/cameel) commented at [2024-03-08 23:05](https://github.com/ethereum/solidity/pull/14928#issuecomment-1986545241):

### `gas_diff_stats`

| File name                                                                                      | IR optimized   | Legacy optimized   | Legacy   |
|------------------------------------------------------------------------------------------------|----------------|--------------------|----------|
| `array/create_memory_array.sol`                                                                | 9%             |                    |          |
| `array/array_storage_push_empty_length_address.sol`                                            | 8%             |                    |          |
| `externalContracts/base64.sol`                                                                 | 8%             | -0%                |          |
| `array/array_storage_index_boundary_test.sol`                                                  | 7%             |                    |          |
| `array/delete/bytes_delete_element.sol`                                                        | 7%             | -0%                |          |
| `array/copying/cleanup_during_multi_element_per_slot_copy.sol`                                 | 6%             |                    |          |
| `array/copying/bytes_storage_to_storage.sol`                                                   | 5%             | -0%                |          |
| `array/copying/storage_memory_packed_dyn.sol`                                                  | 5%             |                    |          |
| `array/byte_array_transitional_2.sol`                                                          | 5%             |                    |          |
| `array/copying/array_copy_cleanup_uint40.sol`                                                  | 5%             |                    |          |
| `abiEncoderV2/calldata_array.sol`                                                              | 3%             |                    |          |
| `array/array_storage_push_pop.sol`                                                             | 3%             |                    |          |
| `inheritance/inherited_function_calldata_memory_interface.sol`                                 |                | 3%                 |          |
| `abiEncoderV2/abi_encode_calldata_slice.sol`                                                   | 3%             | -0%                |          |
| `abiEncoderV1/abi_encode_calldata_slice.sol`                                                   | 3%             | -0%                |          |
| `array/array_storage_push_empty.sol`                                                           | 2%             |                    |          |
| `array/array_storage_index_zeroed_test.sol`                                                    | 2%             |                    |          |
| `isoltestTesting/balance_other_contract.sol`                                                   | 2%             |                    |          |
| `externalContracts/prbmath_unsigned.sol`                                                       | 2%             |                    |          |
| `array/dynamic_arrays_in_storage.sol`                                                          | 2%             |                    |          |
| `externalContracts/FixedFeeRegistrar.sol`                                                      | 1%             | +0%                |          |
| `various/erc20.sol`                                                                            | 1%             | +0%                |          |
| `events/event_indexed_string.sol`                                                              | 1%             | -0%                |          |
| `abiEncoderV2/abi_encode_v2_in_function_inherited_in_v1_contract.sol`                          | 1%             | -0%                |          |
| `array/fixed_arrays_as_return_type.sol`                                                        | 1%             | -0%                |          |
| `array/push/byte_array_push_transition.sol`                                                    | 1%             |                    |          |
| `various/selfdestruct_pre_cancun_multiple_beneficiaries.sol`                                   | 1%             |                    |          |
| `userDefinedValueType/erc20.sol`                                                               | 1%             | +0%                |          |
| `array/copying/array_of_struct_calldata_to_storage.sol`                                        | 1%             |                    |          |
| `array/copying/array_copy_clear_storage.sol`                                                   | 1%             |                    |          |
| `array/copying/memory_dyn_2d_bytes_to_storage.sol`                                             | 1%             | -0%                |          |
| `events/event_dynamic_array_storage_v2.sol`                                                    | 1%             | +0%                |          |
| `events/event_dynamic_array_storage.sol`                                                       | 1%             | +0%                |          |
| `array/array_storage_index_access.sol`                                                         | 1%             |                    |          |
| `externalContracts/prbmath_signed.sol`                                                         | 1%             |                    |          |
| `constructor/bytes_in_constructors_packer.sol`                                                 | +0%            | +0%                |          |
| `various/value_complex.sol`                                                                    | 1%             |                    |          |
| `various/value_insane.sol`                                                                     | +0%            |                    |          |
| `salted_create/salted_create_with_value.sol`                                                   | +0%            |                    |          |
| `array/push/array_push.sol`                                                                    | +0%            |                    |          |
| `structs/memory_structs_nested_load.sol`                                                       | +0%            |                    |          |
| `externalContracts/snark.sol`                                                                  | +0%            |                    |          |
| `byte_array_to_storage_cleanup.sol`                                                            | 1%             | -0%                |          |
| `array/copying/array_of_struct_memory_to_storage.sol`                                          | +0%            |                    |          |
| `array/pop/byte_array_pop_long_storage_empty.sol`                                              | +0%            |                    |          |
| `array/copying/storage_memory_nested_from_pointer.sol`                                         | +0%            |                    |          |
| `array/copying/storage_memory_nested.sol`                                                      | +0%            |                    |          |
| `various/selfdestruct_pre_cancun_redeploy.sol`                                                 | +0%            |                    |          |
| `array/copying/array_copy_storage_storage_different_base.sol`                                  | +0%            |                    |          |
| `array/copying/copy_byte_array_to_storage.sol`                                                 | +0%            | -0%                |          |
| `array/push/push_no_args_bytes.sol`                                                            | +0%            |                    |          |
| `structs/struct_memory_to_storage_function_ptr.sol`                                            | +0%            |                    |          |
| `array/copying/array_copy_storage_storage_dynamic_dynamic.sol`                                 | +0%            |                    |          |
| `structs/struct_delete_storage_with_array.sol`                                                 | +0%            |                    |          |
| `array/push/nested_bytes_push.sol`                                                             | +0%            | -0%                |          |
| `array/constant_var_as_array_length.sol`                                                       | +0%            | +0%                |          |
| `array/copying/array_of_structs_containing_arrays_calldata_to_storage.sol`                     | +0%            |                    |          |
| `array/dynamic_multi_array_cleanup.sol`                                                        | +0%            |                    |          |
| `structs/struct_copy_via_local.sol`                                                            | +0%            |                    |          |
| `array/push/array_push_struct.sol`                                                             | +0%            |                    |          |
| `abiEncoderV1/struct/struct_storage_ptr.sol`                                                   | +0%            |                    |          |
| `libraries/using_library_mappings_public.sol`                                                  | +0%            |                    |          |
| `array/fixed_arrays_in_constructors.sol`                                                       | +0%            |                    |          |
| `array/copying/array_copy_different_packing.sol`                                               | +0%            |                    |          |
| `constructor/constructor_arguments_external.sol`                                               | +0%            |                    |          |
| `abiEncoderV2/abi_encode_v2.sol`                                                               | +0%            | +0%                |          |
| `array/copying/nested_array_element_storage_to_storage.sol`                                    | +0%            |                    |          |
| `viaYul/copy_struct_invalid_ir_bug.sol`                                                        | +0%            |                    |          |
| `userDefinedValueType/calldata.sol`                                                            | +0%            | -0%                |          |
| `array/copying/array_copy_storage_to_memory_nested.sol`                                        | +0%            | +0%                |          |
| `storage/packed_storage_structs_bytes.sol`                                                     | +0%            |                    |          |
| `array/copying/calldata_array_dynamic_to_storage.sol`                                          | +0%            | -0%                |          |
| `array/dynamic_array_cleanup.sol`                                                              | +0%            |                    |          |
| `inheritance/value_for_constructor.sol`                                                        | +0%            |                    |          |
| `array/copying/array_nested_calldata_to_storage.sol`                                           | +0%            |                    |          |
| `immutable/use_scratch.sol`                                                                    | +0%            |                    |          |
| `constructor/constructor_static_array_argument.sol`                                            | +0%            | -0%                |          |
| `events/event_dynamic_nested_array_storage_v2.sol`                                             | +0%            | +0%                |          |
| `array/push/array_push_struct_from_calldata.sol`                                               | +0%            | -0%                |          |
| `various/destructuring_assignment.sol`                                                         | +0%            | -0%                |          |
| `array/copying/array_copy_target_simple.sol`                                                   | +0%            |                    |          |
| `array/copying/array_copy_including_array.sol`                                                 | +0%            |                    |          |
| `functionCall/creation_function_call_with_salt.sol`                                            | +0%            |                    |          |
| `array/copying/array_copy_storage_storage_different_base_nested.sol`                           | +0%            |                    |          |
| `array/copying/storage_memory_nested_struct.sol`                                               | +0%            |                    |          |
| `array/copying/nested_array_of_structs_calldata_to_storage.sol`                                | +0%            |                    |          |
| `array/copying/elements_of_nested_array_of_structs_calldata_to_storage.sol`                    | +0%            |                    |          |
| `structs/copy_struct_array_from_storage.sol`                                                   | +0%            |                    |          |
| `functionCall/creation_function_call_with_args.sol`                                            | +0%            |                    |          |
| `array/copying/array_nested_memory_to_storage.sol`                                             | +0%            |                    |          |
| `types/mapping/copy_from_mapping_to_mapping.sol`                                               | +0%            | +0%                |          |
| `array/copying/nested_dynamic_array_element_calldata_to_storage.sol`                           | +0%            |                    |          |
| `array/fixed_array_cleanup.sol`                                                                | +0%            |                    |          |
| `array/copying/nested_array_of_structs_memory_to_storage.sol`                                  | +0%            |                    |          |
| `array/copying/array_copy_storage_storage_struct.sol`                                          | +0%            |                    |          |
| `array/copying/array_copy_storage_storage_static_dynamic.sol`                                  | +0%            |                    |          |
| `abiencodedecode/abi_decode_simple_storage.sol`                                                | +0%            | -0%                |          |
| `structs/calldata/calldata_struct_with_nested_array_to_storage.sol`                            | +0%            | +0%                |          |
| `array/bytes_length_member.sol`                                                                | +0%            |                    |          |
| `array/reusing_memory.sol`                                                                     | +0%            |                    |          |
| `array/pop/array_pop_array_transition.sol`                                                     | +0%            |                    |          |
| `array/push/array_push_nested_from_calldata.sol`                                               | +0%            | -0%                |          |
| `array/copying/nested_array_of_structs_storage_to_storage.sol`                                 | +0%            |                    |          |
| `array/copying/array_of_structs_containing_arrays_memory_to_storage.sol`                       | +0%            |                    |          |
| `abiEncoderV1/abi_decode_v2_storage.sol`                                                       | +0%            | +0%                |          |
| `array/push/push_no_args_2d.sol`                                                               | +0%            |                    |          |
| `array/copying/array_storage_multi_items_per_slot.sol`                                         | +0%            |                    |          |
| `structs/struct_copy.sol`                                                                      | +0%            |                    |          |
| `abiEncoderV2/calldata_overlapped_dynamic_arrays.sol`                                          | +0%            | -0%                |          |
| `array/copying/copy_function_internal_storage_array.sol`                                       | +0%            |                    |          |
| `array/copying/array_copy_storage_storage_dyn_dyn.sol`                                         | +0%            |                    |          |
| `various/staticcall_for_view_and_pure.sol`                                                     | -0%            |                    |          |
| `array/array_storage_length_access.sol`                                                        | -0%            |                    |          |
| `array/copying/copy_byte_array_in_struct_to_storage.sol`                                       | +0%            | -0%                |          |
| `calldata/copy_from_calldata_removes_bytes_data.sol`                                           | -0%            |                    |          |
| `array/copying/array_copy_storage_storage_static_static.sol`                                   | -0%            |                    |          |
| `array/copying/bytes_inside_mappings.sol`                                                      | -0%            |                    |          |
| `array/invalid_encoding_for_storage_byte_array.sol`                                            | -0%            | -0%                |          |
| `array/copying/array_of_function_external_storage_to_storage_dynamic_different_mutability.sol` | -0%            | +0%                |          |
| `constructor/no_callvalue_check.sol`                                                           | -0%            |                    |          |
| `array/copying/array_copy_nested_array.sol`                                                    | -0%            | -0%                |          |
| `array/copying/elements_of_nested_array_of_structs_memory_to_storage.sol`                      | -0%            |                    |          |
| `array/array_memory_index_access.sol`                                                          | -0%            |                    |          |
| `array/copying/copy_removes_bytes_data.sol`                                                    | -0%            |                    |          |
| `various/many_subassemblies.sol`                                                               | -0%            |                    |          |
| `immutable/multi_creation.sol`                                                                 | -0%            |                    |          |
| `array/copying/calldata_array_to_mapping.sol`                                                  | -0%            |                    |          |
| `array/copying/array_to_mapping.sol`                                                           | -0%            | +0%                |          |
| `array/copying/array_of_function_external_storage_to_storage_dynamic.sol`                      | -0%            | -0%                |          |
| `structs/struct_containing_bytes_copy_and_delete.sol`                                          | -0%            | -0%                |          |
| `array/copying/array_copy_target_simple_2.sol`                                                 | -0%            |                    |          |
| `abiEncoderV2/storage_array_encoding.sol`                                                      | -0%            | -0%                |          |
| `structs/copy_substructures_from_mapping.sol`                                                  | -0%            | -0%                |          |
| `array/copying/array_elements_to_mapping.sol`                                                  | -0%            | +0%                |          |
| `array/copying/function_type_array_to_storage.sol`                                             | -0%            | -0%                |          |
| `various/skip_dynamic_types_for_structs.sol`                                                   | -0%            | -0%                |          |
| `storage/empty_nonempty_empty.sol`                                                             | -0%            | -0%                |          |
| `structs/copy_to_mapping.sol`                                                                  | -0%            | -0%                |          |
| `structs/copy_from_mapping.sol`                                                                | -0%            | -0%                |          |
| `array/pop/byte_array_pop_long_storage_empty_garbage_ref.sol`                                  | -0%            |                    |          |
| `array/copying/array_copy_calldata_storage.sol`                                                | -0%            | -0%                |          |
| `array/copying/storage_memory_nested_bytes.sol`                                                | -0%            | +0%                |          |
| `array/pop/array_pop_uint16_transition.sol`                                                    | -0%            |                    |          |
| `array/copying/arrays_from_and_to_storage.sol`                                                 |                | -0%                |          |
| `functionCall/external_call_to_nonexisting_debugstrings.sol`                                   | -0%            | +0%                |          |
| `array/pop/array_pop_uint24_transition.sol`                                                    | -0%            |                    |          |
| `functionCall/gas_and_value_brace_syntax.sol`                                                  | -0%            |                    |          |
| `functionCall/gas_and_value_basic.sol`                                                         | -0%            |                    |          |
| `structs/copy_substructures_to_mapping.sol`                                                    | -0%            | -0%                |          |
| `libraries/internal_types_in_library.sol`                                                      | -0%            |                    |          |
| `constructor/arrays_in_constructors.sol`                                                       | -1%            | +0%                |          |
| `structs/structs.sol`                                                                          | -0%            |                    |          |
| `functionCall/mapping_array_internal_argument.sol`                                             | -0%            |                    |          |
| `array/pop/byte_array_pop_masking_long.sol`                                                    | -0%            | -0%                |          |
| `array/copying/array_copy_target_leftover.sol`                                                 | -0%            | -0%                |          |
| `structs/conversion/recursive_storage_memory.sol`                                              | -0%            |                    |          |
| `externalContracts/strings.sol`                                                                | -0%            | +0%                |          |
| `libraries/using_library_mappings_return.sol`                                                  | -1%            |                    |          |
| `array/arrays_complex_from_and_to_storage.sol`                                                 | -1%            | +0%                |          |
| `functionCall/external_call_to_nonexisting.sol`                                                | -1%            | +0%                |          |
| `constructor/bytes_in_constructors_unpacker.sol`                                               | -1%            | -0%                |          |
| `externalContracts/deposit_contract.sol`                                                       | -1%            | +0%                |          |
| `various/address_code.sol`                                                                     | -1%            | -0%                |          |
| `array/function_array_cross_calls.sol`                                                         | -2%            | 1%                 |          |
| `various/create_calldata.sol`                                                                  | -1%            | -0%                |          |
| `externalContracts/ramanujan_pi.sol`                                                           | -6%            |                    |          |

### Changes compared to [the same table for `the-good-parts`](https://github.com/ethereum/solidity/pull/14909#issuecomment-1980771356)

```diff
-| `various/erc20.sol`                                   | 4%  | +0% |   |
+| `various/erc20.sol`                                   | 1%  | +0% |   |
-| `userDefinedValueType/erc20.sol`                      | 3%  | +0% |   |
+| `userDefinedValueType/erc20.sol`                      | 1%  | +0% |   |
-| `byte_array_to_storage_cleanup.sol`                   | 3%  | -0% |   |
+| `byte_array_to_storage_cleanup.sol`                   | 1%  | -0% |   |
-| `array/push/push_no_args_bytes.sol`                   | 3%  |     |   |
+| `array/push/push_no_args_bytes.sol`                   | +0% |     |   |
-| `externalContracts/FixedFeeRegistrar.sol`             | 2%  | +0% |   |
+| `externalContracts/FixedFeeRegistrar.sol`             | 1%  | +0% |   |
-| `salted_create/salted_create_with_value.sol`          | 1%  |     |   |
+| `salted_create/salted_create_with_value.sol`          | +0% |     |   |
-| `structs/conversion/recursive_storage_memory.sol`     | 1%  |     |   |
+| `structs/conversion/recursive_storage_memory.sol`     | -0% |     |   |
-| `structs/memory_structs_nested_load.sol`              | 1%  |     |   |
+| `structs/memory_structs_nested_load.sol`              | +0% |     |   |
-| `array/copying/array_of_struct_memory_to_storage.sol` | 1%  |     |   |
+| `array/copying/array_of_struct_memory_to_storage.sol` | +0% |     |   |
-| `array/pop/array_pop_uint16_transition.sol`           | 1%  |     |   |
+| `array/pop/array_pop_uint16_transition.sol`           | -0% |     |   |
-| `array/pop/array_pop_uint24_transition.sol`           | 1%  |     |   |
+| `array/pop/array_pop_uint24_transition.sol`           | -0% |     |   |
-| `array/copying/array_elements_to_mapping.sol`         | +0% | +0% |   |
+| `array/copying/array_elements_to_mapping.sol`         | -0% | +0% |   |
-| `array/copying/function_type_array_to_storage.sol`    | +0% | -0% |   |
+| `array/copying/function_type_array_to_storage.sol`    | -0% | -0% |   |
-| `externalContracts/snark.sol`                         | 1%  |     |   |
+| `externalContracts/snark.sol`                         | +0% |     |   |
-| `libraries/using_library_mappings_return.sol`         | -0% |     |   |
+| `libraries/using_library_mappings_return.sol`         | -1% |     |   |
-| `immutable/multi_creation.sol`                        | +0% |     |   |
+| `immutable/multi_creation.sol`                        | -0% |     |   |

```

#### <img src="https://avatars.githubusercontent.com/u/137030?v=4" width="50">[cameel](https://github.com/cameel) commented at [2024-03-08 23:10](https://github.com/ethereum/solidity/pull/14928#issuecomment-1986548985):

## External test benchmark diff

[CI run on `develop`](https://app.circleci.com/pipelines/github/ethereum/solidity/33255/workflows/17d7e1f5-fb85-4289-999d-eb4b6dbfb98c) vs [CI run on `seqbench-sequence-the-good-parts-mk2`](https://app.circleci.com/pipelines/github/ethereum/solidity/33259/workflows/f1007a58-fa0e-4b76-b6b6-59052bf5d6c5)


### `ir-no-optimize`
|          project | bytecode_size | deployment_gas |     method_gas |
|:----------------:|--------------:|---------------:|---------------:|
|           bleeps |               |                |                |
|            brink |          `0%` |                |                |
|        chainlink |               |                |                |
|           colony |          `0%` |                |                |
|        elementfi |          `0%` |                |                |
|              ens |          `0%` |                |                |
|            euler |               |                |                |
|           gnosis |               |                |                |
|              gp2 |          `0%` |                |                |
|  perpetual-pools |          `0%` |          `+0%` | **`+0.01% ❌`** |
|    pool-together |          `0%` |                |                |
|          trident |          `0%` |                |                |
|          uniswap |          `0%` |          `-0%` |          `-0%` |
| yield_liquidator |          `0%` |          `-0%` |           `0%` |
|         zeppelin |               |                |                |

### `ir-optimize-evm+yul`
|          project |  bytecode_size | deployment_gas |     method_gas |
|:----------------:|---------------:|---------------:|---------------:|
|           bleeps |                |                |                |
|            brink | **`+0.39% ❌`** |                |                |
|        chainlink |  **`-2.4% ✅`** |                |                |
|           colony | **`+0.13% ❌`** |                |                |
|        elementfi | **`-1.65% ✅`** |                |                |
|              ens | **`-0.16% ✅`** | **`-3.08% ✅`** | **`-0.01% ✅`** |
|            euler | **`+1.18% ❌`** |                |                |
|           gnosis |                |                |                |
|              gp2 | **`+0.49% ❌`** |                |                |
|  perpetual-pools | **`+0.08% ❌`** | **`-0.22% ✅`** | **`+0.13% ❌`** |
|    pool-together | **`-1.06% ✅`** |                |                |
|          trident | **`+0.27% ❌`** |                |                |
|          uniswap | **`+1.65% ❌`** | **`+1.66% ❌`** | **`+2.04% ❌`** |
| yield_liquidator | **`+0.92% ❌`** |  **`-0.1% ✅`** | **`+0.04% ❌`** |
|         zeppelin | **`-0.38% ✅`** | **`-1.18% ✅`** | **`+0.01% ❌`** |

### `ir-optimize-evm-only`
|          project | bytecode_size | deployment_gas |     method_gas |
|:----------------:|--------------:|---------------:|---------------:|
|           bleeps |               |                |                |
|            brink |          `0%` |                |                |
|        chainlink |               |                |                |
|           colony |          `0%` |                |                |
|        elementfi |          `0%` |                |                |
|              ens |          `0%` |          `-0%` |           `0%` |
|            euler |               |                |                |
|           gnosis |               |                |                |
|              gp2 |          `0%` |                |                |
|  perpetual-pools |          `0%` |          `+0%` | **`-0.01% ✅`** |
|    pool-together |          `0%` |                |                |
|          trident |          `0%` |                |                |
|          uniswap |          `0%` |          `-0%` |          `+0%` |
| yield_liquidator |          `0%` |          `+0%` |          `-0%` |
|         zeppelin |          `0%` |                |                |

### `legacy-no-optimize`
|          project | bytecode_size | deployment_gas |     method_gas |
|:----------------:|--------------:|---------------:|---------------:|
|           bleeps |               |                |                |
|            brink |          `0%` |                |                |
|        chainlink |          `0%` |                |                |
|           colony |          `0%` |                |                |
|        elementfi |          `0%` |                |                |
|              ens |          `0%` |                |                |
|            euler |          `0%` |                |                |
|           gnosis |          `0%` |                |                |
|              gp2 |          `0%` |                |                |
|  perpetual-pools |          `0%` |          `+0%` | **`-0.02% ✅`** |
|    pool-together |          `0%` |                |                |
|          trident |          `0%` |                |                |
|          uniswap |          `0%` |          `-0%` |          `-0%` |
| yield_liquidator |          `0%` |          `-0%` |           `0%` |
|         zeppelin |          `0%` |          `-0%` | **`-0.09% ✅`** |

### `legacy-optimize-evm+yul`
|          project |  bytecode_size | deployment_gas |     method_gas |
|:----------------:|---------------:|---------------:|---------------:|
|           bleeps | **`+0.13% ❌`** |                |                |
|            brink | **`-0.03% ✅`** |                |                |
|        chainlink | **`+0.12% ❌`** |                |                |
|           colony | **`+0.13% ❌`** |                |                |
|        elementfi | **`+0.09% ❌`** |                |                |
|              ens | **`+0.18% ❌`** | **`-0.02% ✅`** |          `-0%` |
|            euler | **`+0.14% ❌`** |                |                |
|           gnosis | **`+0.16% ❌`** |                |                |
|              gp2 | **`+0.27% ❌`** |                |                |
|  perpetual-pools | **`-0.03% ✅`** |          `+0%` | **`+0.03% ❌`** |
|    pool-together | **`+0.03% ❌`** |                |                |
|          trident |  **`+0.1% ❌`** |                |                |
|          uniswap | **`+0.04% ❌`** | **`+0.03% ❌`** |          `+0%` |
| yield_liquidator | **`+0.04% ❌`** | **`+0.02% ❌`** | **`-0.01% ✅`** |
|         zeppelin | **`+0.15% ❌`** | **`+0.17% ❌`** | **`-0.06% ✅`** |

### `legacy-optimize-evm-only`
|          project | bytecode_size | deployment_gas |     method_gas |
|:----------------:|--------------:|---------------:|---------------:|
|           bleeps |               |                |                |
|            brink |          `0%` |                |                |
|        chainlink |          `0%` |                |                |
|           colony |          `0%` |                |                |
|        elementfi |          `0%` |                |                |
|              ens |          `0%` |           `0%` |           `0%` |
|            euler |          `0%` |                |                |
|           gnosis |          `0%` |                |                |
|              gp2 |          `0%` |                |                |
|  perpetual-pools |          `0%` |          `-0%` |          `+0%` |
|    pool-together |          `0%` |                |                |
|          trident |          `0%` |                |                |
|          uniswap |          `0%` |          `+0%` |          `+0%` |
| yield_liquidator |          `0%` |          `-0%` |           `0%` |
|         zeppelin |          `0%` |          `-0%` | **`+0.02% ❌`** |


`!V` = version mismatch
`!B` = no value in the "before" version
`!A` = no value in the "after" version
`!T` = one or both values were not numeric and could not be compared
`-0` = very small negative value rounded to zero
`+0` = very small positive value rounded to zero

#### <img src="https://avatars.githubusercontent.com/u/137030?v=4" width="50">[cameel](https://github.com/cameel) commented at [2024-03-08 23:23](https://github.com/ethereum/solidity/pull/14928#issuecomment-1986558988):

## External test comparison with `the-good-parts`.

Interestingly, there is only one test where the new sequence performs worse (`perpetual-pools`) in almost all others it does the same or better, with just a few being neutral.

### the-good-parts -> the-good-parts-mk2 (ir-optimize-evm+yul diff)
```diff
-|            brink | +0.73% ❌ |           |           |
+|            brink | +0.39% ❌ |           |           |

-|        chainlink | -1.83% ✅ |           |           |
+|        chainlink |  -2.4% ✅ |           |           |

-|        elementfi | -1.33% ✅ |           |           |
+|        elementfi | -1.65% ✅ |           |           |

-|              ens | +0.39% ❌ | -2.77% ✅ | +0.02% ❌ |
+|              ens | -0.16% ✅ | -3.08% ✅ | -0.01% ✅ |

-|            euler | +1.29% ❌ |           |           |
+|            euler | +1.18% ❌ |           |           |

-|              gp2 | +0.86% ❌ |           |           |
+|              gp2 | +0.49% ❌ |           |           |

-|  perpetual-pools | -0.39% ✅ | -0.78% ✅ | +0.32% ❌ |
+|  perpetual-pools | +0.08% ❌ | -0.22% ✅ | +0.13% ❌ |

-|    pool-together | -0.83% ✅ |           |           |
+|    pool-together | -1.06% ✅ |           |           |

-|          trident |  +0.4% ❌ |           |           |
+|          trident | +0.27% ❌ |           |           |

-|          uniswap | +2.06% ❌ |  +2.2% ❌ | +2.13% ❌ |
+|          uniswap | +1.65% ❌ | +1.66% ❌ | +2.04% ❌ |

-| yield_liquidator |  +1.3% ❌ | +0.34% ❌ | +0.17% ❌ |
+| yield_liquidator | +0.92% ❌ |  -0.1% ✅ | +0.04% ❌ |

-|         zeppelin |  -0.2% ✅ | -1.16% ✅ | +0.12% ❌ |
+|         zeppelin | -0.38% ✅ | -1.18% ✅ | +0.01% ❌ |
```

### the-good-parts -> the-good-parts-mk2 (legacy-optimize-evm+yul diff)
```diff
+|        chainlink | +0.12% ❌ |           |           |
-|        chainlink | +0.13% ❌ |           |           |

-|        elementfi | +0.12% ❌ |           |           |
+|        elementfi | +0.09% ❌ |           |           |

-|            euler | +0.17% ❌ |           |           |
+|            euler | +0.14% ❌ |           |           |

-|           gnosis |  +0.2% ❌ |           |           |
+|           gnosis | +0.16% ❌ |           |           |

-|  perpetual-pools | -0.03% ✅ |       +0% | -0.01% ✅ |
+|  perpetual-pools | -0.03% ✅ |       +0% | +0.03% ❌ |

-|    pool-together | +0.05% ❌ |           |           |
+|    pool-together | +0.03% ❌ |           |           |

-| yield_liquidator | +0.09% ❌ | +0.06% ❌ | -0.01% ✅ |
+| yield_liquidator | +0.04% ❌ | +0.02% ❌ | -0.01% ✅ |

-|         zeppelin | +0.15% ❌ | +0.17% ❌ | -0.02% ✅ |
+|         zeppelin | +0.15% ❌ | +0.17% ❌ | -0.06% ✅ |
```

#### <img src="https://avatars.githubusercontent.com/u/137030?v=4" width="50">[cameel](https://github.com/cameel) commented at [2024-03-26 17:13](https://github.com/ethereum/solidity/pull/14928#issuecomment-2021020206):

A quick observation from reviewing the modified code: in a lot of cases the difference is in which variables get rematerialized or which expressions get joined. Sometimes this also prevents further optimizations (see e.g. `devcon_example.yul` for example where it interferes with `ForLoopConditionOutOfBody`).

That's unexpected to me given that the cleanup sequence ends with `Rematerialiser` (`m`) and that `ExpressionJoiner` (`j`) is also used quite liberally in the sequence. After some experimentation I see that this seems to be due to the extra zero assignments that `ConditionalSimplifier` (`C`) inserts. I'm not sure why they interfere but using `ConditionalUnsimplifier` (`U`) before `mu` or `j` seems to help.

The conclusion is that adding `U` to the cleanup sequence is probably a good idea.

EDIT: An extra `O` at the end of cleanup is also needed to move the condition out of body (though it's just a cosmetic difference).
EDIT2: Maybe not just cosmetic - I expected gas use to be the same but it actually decreased by a very small amount in several tests (and increased in one).
EDIT3: Moved to a thread: https://github.com/ethereum/solidity/pull/14928#discussion_r1561516503

#### <img src="https://avatars.githubusercontent.com/u/137030?v=4" width="50">[cameel](https://github.com/cameel) commented at [2024-03-26 17:20](https://github.com/ethereum/solidity/pull/14928#issuecomment-2021040960):

Hmm... after trying it out, it does not seem to affect as many cases as I expected. Basically `devcon_example.yul` and two others. Still, does not make anything worse either so probably does not hurt to include it in the cleanup.

#### <img src="https://avatars.githubusercontent.com/u/137030?v=4" width="50">[cameel](https://github.com/cameel) commented at [2024-04-15 12:03](https://github.com/ethereum/solidity/pull/14928#issuecomment-2056669155):

Closing in favor of #15031.


-------------------------------------------------------------------------------



[Export of Github issue for [ethereum/solidity](https://github.com/ethereum/solidity). Generated on 2024.12.15 at 06:45:24.]
